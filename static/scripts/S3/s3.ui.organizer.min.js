(function($,undefined){"use strict";var organizerID=0;function EventCache(){this.items={};this.slices=[];}
EventCache.prototype.store=function(start,end,items){var events={};items.forEach(function(item){this.items[item.id]=events[item.id]=item;},this);var slices=this.slices,slice=[moment(start),moment(end),events];slices.push(slice);slices.sort(function(x,y){if(x[0].isBefore(y[0])){return-1;}else if(y[0].isBefore(x[0])){return 1;}else{if(x[1].isBefore(y[1])){return-1;}else if(y[1].isBefore(x[1])){return 1;}}
return 0;});if(slices.length>1){var newSlices=[];var merged=slices.reduce(function(x,y){if(x[1].isBefore(y[0])||x[0].isAfter(y[1])){newSlices.push(x);return y;}else{return[moment.min(x[0],y[0]),moment.max(x[1],y[1]),$.extend({},x[2],y[2])];}});newSlices.push(merged);this.slices=newSlices;}};EventCache.prototype.retrieve=function(start,end){start=moment(start);end=moment(end);var slices=this.slices,numSlices=slices.length,slice,events,eventID,event,eventStart,items=[];for(var i=0;i<numSlices;i++){slice=slices[i];if(slice[0].isSameOrBefore(start)&&slice[1].isSameOrAfter(end)){events=slice[2];for(eventID in events){event=events[eventID];eventStart=moment(event.start);if(eventStart.isAfter(end)){continue;}
if(event.end){if(moment(event.end).isBefore(start)){continue;}}else{if(eventStart.isSameOrBefore(moment(start).subtract(1,'days'))){continue;}}
items.push(event);}
return items;}}
return null;};EventCache.prototype.updateItem=function(itemID,data){var item=this.items[itemID];if(item&&data){$.extend(item,data);}};EventCache.prototype.deleteItem=function(itemID){this.slices.forEach(function(slice){delete slice[2][itemID];});delete this.items[itemID];};EventCache.prototype.clear=function(){this.slices=[];this.items={};};$.widget('s3.organizer',{options:{locale:'en',timeout:10000,resources:null,aspectRatio:1.8,nowIndicator:true,slotDuration:'00:30:00',snapDuration:'00:15:00',defaultTimedEventDuration:'00:30:00',businessHours:false,timeFormat:null,labelEdit:'Edit',labelDelete:'Delete',deleteConfirmation:'Do you want to delete this entry?',firstDay:1,refreshIconClass:'fa fa-refresh',calendarIconClass:'fa fa-calendar'},_create:function(){this.id=organizerID;organizerID+=1;this.eventNamespace='.organizer';},_init:function(){this.openRequest=null;this.loadCount=-1;this.refresh();},_destroy:function(){$.Widget.prototype.destroy.call(this);},refresh:function(){var opts=this.options,resourceConfigs=opts.resources,el=$(this.element),widgetID=el.attr('id');this._unbindEvents();var insertable=false,allDaySlot=false;resourceConfigs.forEach(function(resourceConfig){if(resourceConfig.insertable){insertable=true;}
if(!resourceConfig.useTime){allDaySlot=true;}});var leftHeader,defaultView;if(opts.useTime){leftHeader='month,agendaWeek,agendaDay reload';defaultView='agendaWeek';}else{leftHeader='month,basicWeek reload';defaultView='month';}
var self=this,datePicker=$('#'+widgetID+'-date-picker');$(this.element).fullCalendar({aspectRatio:opts.aspectRatio,nowIndicator:opts.nowIndicator,slotDuration:opts.slotDuration,snapDuration:opts.snapDuration,displayEventEnd:false,defaultTimedEventDuration:opts.defaultTimedEventDuration,allDaySlot:allDaySlot,firstDay:opts.firstDay,timeFormat:opts.timeFormat,slotLabelFormat:opts.timeFormat,businessHours:opts.businessHours,selectable:insertable,editable:true,eventDrop:function(event,delta,revertFunc){self._updateItem(event,revertFunc);},eventResize:function(event,delta,revertFunc){self._updateItem(event,revertFunc);},customButtons:{reload:{text:'Reload',click:function(){self.reload();}},calendar:{text:'Calendar',click:function(){datePicker.datepicker('show');}}},header:{left:leftHeader,center:'title',right:'calendar today prev,next'},defaultView:defaultView,eventRender:function(item,element){self._eventRender(item,element);},eventDestroy:function(item,element){self._eventDestroy(item,element);},select:function(start,end,jsEvent){self._selectDate(start,end,jsEvent);},unselect:function(){$(self.element).qtip('destroy',true);},unselectCancel:'.s3-organizer-create',locale:opts.locale,timezone:'local'});var refreshIcon=$('<i>').addClass(opts.refreshIconClass),calendarIcon=$('<i>').addClass(opts.calendarIconClass);this.reloadButton=$('.fc-reload-button').empty().append(refreshIcon);var calendarButton=$('.fc-calendar-button').empty().append(calendarIcon);datePicker.datepicker('option',{showOn:'focus',showButtonPanel:true,firstDay:opts.firstDay}).insertBefore(calendarButton).on('change',function(){var date=datePicker.datepicker('getDate');if(date){el.fullCalendar('gotoDate',date);}});datePicker.datepicker('widget').hide();var throbber=$('<div class="inline-throbber">').css({visibility:'hidden'});$('.fc-header-toolbar .fc-left',this.element).append(throbber);this.throbber=throbber;this.resources=[];if(resourceConfigs){resourceConfigs.forEach(function(resourceConfig,index){this._addResource(resourceConfig,index);},this);}
this._bindEvents();},_addResource:function(resourceConfig,index){var resource=$.extend({},resourceConfig,{_cache:new EventCache()});this.resources.push(resource);var timeout=resource.timeout;if(timeout===undefined){timeout=this.options.timeout;}
var self=this;$(this.element).fullCalendar('addEventSource',{id:''+index,allDayDefault:!resource.useTime,editable:!!resource.editable,startEditable:!!resource.startEditable,durationEditable:!!resource.end&&!!resource.durationEditable,events:function(start,end,timezone,callback){self._fetchItems(resource,start,end,timezone,callback);}});},_eventRender:function(item,element){var self=this;$(element).qtip({content:{title:function(jsEvent,api){return self._itemTitle(item,api);},text:function(jsEvent,api){return self._itemDisplay(item,api);},button:true},position:{at:'center right',my:'left center',effect:false,viewport:$(window),adjust:{method:'flip shift'}},show:{event:'click',solo:true},hide:{event:'click mouseleave',delay:800,fixed:true},events:{visible:function(){S3.addModals();}}});},_eventDestroy:function(item,element){$(element).qtip('destroy',true);},_itemTitle:function(item){var dateFormat=item.allDay&&'L'||'L LT',timeFormat='LT',dates=[item.start.format(dateFormat)];if(item.end){var end=moment(item.end).endOf('minute');dates.push(end.format(timeFormat));}
return dates.join(' - ');},_itemDisplay:function(item,api){var contents=$('<div class="s3-organizer-popup">'),opts=this.options,resource=opts.resources[item.source.id];$('<h6>').html(item.popupTitle).appendTo(contents);var columns=resource.columns,description=item.description;if(columns&&description){columns.forEach(function(column){var colName=column[0],label=column[1];if(description[colName]!==undefined){if(label){$('<label>').text(label).appendTo(contents);}
$('<p>').html(description[colName]).appendTo(contents);}});}
var widgetID=$(this.element).attr('id'),ns=this.eventNamespace,self=this,buttons=[],btn,baseURL=resource.baseURL;if(baseURL){if(resource.editable&&item.editable!==false){var link=document.createElement('a');link.href=baseURL;link.pathname+='/'+item.id+'/update.popup';if(link.search){link.search+='&refresh='+widgetID;}else{link.search='?refresh='+widgetID;}
btn=$('<a class="action-btn s3_modal">').text(opts.labelEdit).attr('href',link.href);btn.on('click'+ns,function(){api.hide();});buttons.push(btn);}
if(resource.deletable&&item.deletable!==false){btn=$('<a class="action-btn delete-btn-ajax">').text(opts.labelDelete);btn.on('click'+ns,function(){if(confirm(opts.deleteConfirmation)){api.hide();self._deleteItem(item,function(){api.destroy();});}
return false;});buttons.push(btn);}}
if(buttons.length){$('<div>').append(buttons).appendTo(contents);}
return contents;},_selectDate:function(start,end,jsEvent){var self=this;$(this.element).qtip({content:{'text':function(jsEvent,api){return self._selectResource(start,end,jsEvent,api);}},position:{target:'mouse',at:'center right',my:'left center',effect:false,viewport:$(window),adjust:{mouse:false,method:'flip shift'}},show:{event:'click',solo:true},hide:{event:'mouseleave',delay:800,fixed:true},events:{'visible':function(){S3.addModals();}}});$(this.element).qtip('show',jsEvent);},_selectResource:function(start,end,jsEvent,api){api.set('style.classes','s3-organizer-create');var opts=this.options,resources=opts.resources,ns=this.eventNamespace,widgetID=$(this.element).attr('id'),contents=$('<div>');resources.forEach(function(resource){if(!resource.insertable){return;}
var createButton=$('<a class="action-btn s3_modal">'),label=resource.labelCreate,url=resource.baseURL;if(url&&label){var link=createButton.get(0),query=[];link.href=url;link.pathname+='/create.popup';if(widgetID){query.push('refresh='+encodeURIComponent(widgetID));}
var dates=start.toISOString()+'--'+moment(end).subtract(1,'seconds').toISOString();query.push('organizer='+encodeURIComponent(dates));if(link.search){link.search+='&'+query.join('&');}else{link.search='?'+query.join('&');}
createButton.text(label).appendTo(contents).on('click'+ns,function(){api.hide();});}});return contents;},_fetchItems:function(resource,start,end,timezone,callback){var items=resource._cache.retrieve(start,end);if(items){callback(items);return;}
var opts=this.options;this._showThrobber();var filterForm;if(resource.filterForm){filterForm=$('#'+resource.filterForm);}else if(opts.filterForm){filterForm=$('#'+opts.filterForm);}
var currentFilters=S3.search.getCurrentFilters(filterForm);var filters=currentFilters.filter(function(query){var selector=query[0].split('__')[0];return selector!==resource.start&&selector!==resource.end;});var ajaxURL=resource.ajaxURL;if(!ajaxURL){return;}else{ajaxURL=S3.search.filterURL(ajaxURL,filters);}
var interval=encodeURIComponent(start.toISOString()+'--'+end.toISOString());if(ajaxURL.indexOf('?')!=-1){ajaxURL+='&$interval='+interval;}else{ajaxURL+='?$interval='+interval;}
var timeout=resource.timeout,ajaxMethod=$.ajaxS3;if(timeout===undefined){timeout=opts.timeout;}
if($.searchS3!==undefined){ajaxMethod=$.searchS3;}
var openRequest=resource.openRequest;if(openRequest){openRequest.onreadystatechange=null;openRequest.abort();}
var self=this;resource.openRequest=ajaxMethod({'timeout':timeout,'url':ajaxURL,'dataType':'json','type':'GET','success':function(data){data=self._decodeServerData(resource,data);self._hideThrobber();resource._cache.store(start,end,data);callback(data);},'error':function(jqXHR,textStatus,errorThrown){self._hideThrobber();var msg;if(errorThrown=='UNAUTHORIZED'){msg=i18n.gis_requires_login;}else{msg=jqXHR.responseText;}
console.log(msg);}});},_decodeServerData:function(resource,data){var columns=data.c,records=data.r,items=[],translateCols=0,colors=resource.colors;if(columns&&columns.constructor===Array){translateCols=columns.length;}
records.forEach(function(record){var description={},values=record.d;if(translateCols&&values&&values.constructor===Array){var len=values.length;if(len<=translateCols){for(var i=0;i<len;i++){description[columns[i]]=values[i];}}}
var end=record.e;if(end){if(resource.useTime){end=moment(end).add(1,'seconds').toISOString();}else{end=moment(end).add(1,'days').startOf('day').toISOString();}}
var title=record.t,item={'id':record.id,title:$('<div>').html(title).text(),popupTitle:title,start:record.s,end:end,description:description,};if(!record.pe){item.editable=false;}
if(!record.pd){item.deletable=false;}
if(colors&&record.c){var itemColor=colors[record.c];if(itemColor!==undefined){item.color=itemColor;}}
items.push(item);});return items;},_updateItem:function(item,revertFunc){var resource=this.resources[item.source.id],self=this;var data={"id":item.id,"s":item.start.toISOString()};if(resource.end){if(resource.useTime){data.e=moment(item.end).subtract(1,'seconds').toISOString();}else{data.e=moment(item.end).subtract(1,'days').endOf('day').toISOString();}}
this._sendItems(resource,{u:[data]},function(){if(resource.reloadOnUpdate){self.reload();}else{resource._cache.updateItem(item.id,{start:item.start,end:item.end});}},revertFunc);},_deleteItem:function(item,callback){var resource=this.resources[item.source.id],data={'id':item.id},el=$(this.element);this._sendItems(resource,{d:[data]},function(){el.fullCalendar('removeEvents',function(eventObj){return eventObj.source.id==item.source.id&&eventObj.id==item.id;});resource._cache.deleteItem(item.id);if(typeof callback==='function'){callback();}});},_sendItems:function(resource,data,callback,revertFunc){var formKey=$('input[name="_formkey"]',this.element).val(),jsonData=JSON.stringify($.extend({k:formKey},data));this._showThrobber();var self=this;$.ajaxS3({type:'POST',url:resource.ajaxURL,data:jsonData,dataType:'json',retryLimit:0,contentType:'application/json; charset=utf-8',success:function(){if(typeof callback==='function'){callback();}
self._hideThrobber();},error:function(){if(typeof revertFunc==='function'){revertFunc();}
self._hideThrobber();}});},reload:function(){this.resources.forEach(function(resource){resource._cache.clear();});$(this.element).fullCalendar('refetchEvents');},_showThrobber:function(){this.reloadButton.prop('disabled',true);this.throbber.css({visibility:'visible'});},_hideThrobber:function(){this.throbber.css({visibility:'hidden'});this.reloadButton.prop('disabled',false);},_bindEvents:function(){return true;},_unbindEvents:function(){return true;}});})(jQuery);