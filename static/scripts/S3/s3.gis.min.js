S3.gis.maps={};S3.gis.timeouts={};S3.gis.proj4326=new OpenLayers.Projection('EPSG:4326');OpenLayers.ImgPath=S3.Ap.concat('/static/img/gis/openlayers/');OpenLayers.IMAGE_RELOAD_ATTEMPTS=3;OpenLayers.Util.onImageLoadErrorColor='transparent';OpenLayers.ProxyHost=S3.Ap.concat('/gis/proxy?url=');(function(){var format_geojson=new OpenLayers.Format.GeoJSON();format_geojson.ignoreExtraDims=true;var marker_url_path=S3.Ap.concat('/static/img/markers/');var proj4326=S3.gis.proj4326;var cluster_distance_default=20;var cluster_threshold_default=2;var fill_default='#f5902e';var cluster_fill_default='8087ff';var cluster_stroke_default='2b2f76';var select_fill_default='ffdc33';var select_stroke_default='ff9933';S3.gis.show_map=function(map_id,options){if(!map_id){map_id='default_map';}
if(undefined==options){options=S3.gis.options[map_id];}
var projection=options.projection;var projection_current=new OpenLayers.Projection('EPSG:'+projection);options.projection_current=projection_current;if(projection==900913){options.maxExtent=new OpenLayers.Bounds(-20037508.34,-20037508.34,20037508.34,20037508.34);options.maxResolution=156543.0339;options.units='m';}else if(projection==4326){options.maxExtent=new OpenLayers.Bounds(-180,-90,180,90);options.maxResolution=1.40625;options.units='degrees';}else{var maxExtent=options.maxExtent.split(',');options.maxExtent=new OpenLayers.Bounds(maxExtent[0],maxExtent[1],maxExtent[2],maxExtent[3]);options.maxResolution='auto';}
var lat=options.lat;var lon=options.lon;if((lat!=undefined)&&(lon!=undefined)){var bounds;var center=new OpenLayers.LonLat(lon,lat);center.transform(proj4326,projection_current);}else{var bounds=OpenLayers.Bounds.fromArray(options.bbox);var center=bounds.getCenterLonLat();}
options.center=center;if(undefined===options.cluster_label){options.cluster_label=true;}
var map=addMap(map_id,options);var s3=map.s3;map.Z_INDEX_BASE.Popup=900;var map_div=$('#'+map_id+'_panel');map_div.css('width','100%');$(window).resize(function(){var w=map_div.width();map.s3.mapWin.setWidth(w);});options.renderTo=map_id+'_panel';addMapUI(map);if(bounds){bounds.transform(proj4326,projection_current);map.zoomToExtent(bounds);}
map.events.on({'movestart':function(event){S3.hideAlerts('warning');}});$.when(layersLoaded(map_id)).then(function(status){s3_debug(status);$.when(tilesLoaded(S3.gis.maps[map_id].baseLayer)).then(function(status){s3_debug(status);hideThrobber(null,map);setTimeout(function drawing(){try{if(map.tileManager.tileQueue[map.id].length){setTimeout(drawing,250);}else{map.s3.loaded=true;}}catch(e){setTimeout(function(){map.s3.loaded=true},50000);}},1);},function(status){s3_debug(status);},function(status){showThrobber(map_id);s3_debug(status);});},function(status){s3_debug(status);},function(status){s3_debug(status);});return map;};var layersLoaded=function(map_id){var dfd=new jQuery.Deferred();var layers_loading=S3.gis.maps[map_id].s3.layers_loading;setTimeout(function working(){if(layers_loading.length==0){dfd.resolve('Layers loaded');}else if(dfd.state()==='pending'){dfd.notify('waiting for Layers to load...');setTimeout(working,250);}else{}},1);return dfd.promise();};var tilesLoaded=function(layer){if(undefined==layer.numLoadingTiles){return true;}
var dfd=new jQuery.Deferred();layer.events.register('loadend','',function(){if(layer.numLoadingTiles==0){dfd.resolve('Tiles loaded');}else if(dfd.state()==='pending'){dfd.reject('Tile loading failed');}else{}});return dfd.promise();};var zoomBounds=function(map,bounds,minBBOX){var bbox=bounds.toArray();var lon_min=bbox[0],lat_min=bbox[1],lon_max=bbox[2],lat_max=bbox[3];var min_size=minBBOX||0.05;var delta=(min_size-Math.abs(lon_max-lon_min))/2;if(delta>0){lon_min-=delta;lon_max+=delta;}
delta=(min_size-Math.abs(lat_max-lat_min))/2;if(delta>0){lat_min-=delta;lat_max+=delta;}
var inset=min_size/7;lon_min-=inset;lon_max+=inset;lat_min=Math.max(lat_min-inset,-90.0);lat_max=Math.min(lat_max+inset,90.0);bounds=new OpenLayers.Bounds(lon_min,lat_min,lon_max,lat_max);bounds.transform(proj4326,map.getProjectionObject());map.zoomToExtent(bounds);}
S3.gis.zoomBounds=zoomBounds;var search_layer_loadend=function(event){var layer=event.object;var bounds=layer.getDataExtent();if(bounds){var map=layer.map;bounds.transform(map.getProjectionObject(),proj4326);zoomBounds(map,bounds);}
var strategy,strategies=layer.strategies;for(var i=0,len=strategies.length;i<len;i++){strategy=strategies[i];if(strategy.CLASS_NAME=='OpenLayers.Strategy.AttributeCluster'){strategy.activate();strategy.features=layer.features;strategy.recluster();break;}}
layer.events.un({'loadend':search_layer_loadend});};S3.gis.search_layer_loadend=search_layer_loadend;S3.gis.refreshLayer=function(layer_id,queries){var maps=S3.gis.maps;var map_id,map,layers,i,len,layer,url,strategies,j,jlen,strategy;for(map_id in maps){map=maps[map_id];layers=map.layers;for(i=0,len=layers.length;i<len;i++){layer=layers[i];if(layer&&(layer.s3_layer_id==layer_id)){if(queries&&queries.length){url=layer.protocol.url;url=S3.search.filterURL(url,queries);var ajax_options={data:[],type:'GET',url:url,};S3.search.searchRewriteAjaxOptions(ajax_options,'form');var protocol_options=layer.protocol.options;protocol_options.params=ajax_options['data'];protocol_options.readWithPOST=true;protocol_options.url=ajax_options['url'];}
if(map.s3.mapWin.isVisible()){layer.events.on({'loadend':search_layer_loadend});strategies=layer.strategies;jlen=strategies.length;for(j=0;j<jlen;j++){strategy=strategies[j];if(strategy.CLASS_NAME=='OpenLayers.Strategy.AttributeCluster'){strategy.deactivate();break;}}
if(layer.visibility){for(j=0;j<jlen;j++){strategy=strategies[j];if(strategy.CLASS_NAME=='OpenLayers.Strategy.BBOX'||strategy.CLASS_NAME=='OpenLayers.Strategy.ZoomBBOX'){strategy.bounds=null;strategy.triggerRead();break;}}}else{layer.setVisibility(true);}
if(undefined!=map.s3.layerRefreshed){map.s3.layerRefreshed(layer);}}}}}};var addMap=function(map_id,options){if(i18n.gis_name_map){var fallThrough=true;}else{var fallThrough=false;}
var tileManager=new OpenLayers.TileManager();var map_options={controls:[],displayProjection:proj4326,projection:options.projection_current,fallThrough:fallThrough,maxResolution:options.maxResolution,maxExtent:options.maxExtent,numZoomLevels:options.numZoomLevels,theme:null,tileManager:tileManager,units:options.units};var map=new OpenLayers.Map('center',map_options);S3.gis.maps[map_id]=map;map.s3={};map.s3.id=map_id;map.s3.options=options;map.s3.plugins=[];map.registerPlugin=function(plugin){plugin.map=this;this.s3.plugins.push(plugin);}
addLayers(map);addControls(map);return map;};var addMapUI=function(map){var s3=map.s3;var options=s3.options;var mapPanel=new GeoExt.MapPanel({xtype:'gx_mappanel',map:map,center:options.center,zoom:options.zoom,plugins:[]});s3.mapPanel=mapPanel;var portal={};portal.map=mapPanel;s3.portal=portal;if(options.legend||options.layers_wms){var layers=map.layers;var mp_items=mapPanel.layers.data.items;for(var i=0;i<layers.length;i++){if(layers[i].legendURL){mp_items[i].data.legendURL=layers[i].legendURL;}
if(layers[i].legendTitle){mp_items[i].data.title=layers[i].legendTitle;}
if(layers[i].queryable){mp_items[i].data.queryable=1;}}}
var layerTree=addLayerTree(map);var west_panel_items=[layerTree];if(options.wms_browser_url){var wmsBrowser=addWMSBrowser(map);if(wmsBrowser){west_panel_items.push(wmsBrowser);}}
if(options.legend){if(options.legend=='float'){var legendPanel=addLegendPanel(map);}else{var legendPanel=new GeoExt.LegendPanel({title:i18n.gis_legend,defaults:{},autoScroll:true,collapsible:true,collapseMode:'mini'});west_panel_items.push(legendPanel);}
mapPanel.legendPanel=legendPanel;}
var plugins=s3.plugins;for(var j=0,len=plugins.length;j<len;++j){plugins[j].setup(map);plugins[j].addToMapWindow(west_panel_items);}
s3.west_panel_items=west_panel_items;if(options.window){addMapWindow(map);}else{addMapPanel(map);}
var westPanelContainer=s3.westPanelContainer;westPanelContainer.fireEvent('collapse');window.setTimeout(function(){westPanelContainer.fireEvent('expand')},300);layerTree.root.eachChild(function(){this.eachChild(function(){if(this.isLeaf()){this.on('checkchange',function(event,checked){if(!checked){hideThrobber(this.layer);}});}else{this.eachChild(function(){if(this.isLeaf()){this.on('checkchange',function(event,checked){if(!checked){hideThrobber(this.layer);}});}});}});});Ext.QuickTips.init();};var addMapPanel=function(map){var s3=map.s3;var options=s3.options;var westPanelContainer=addWestPanel(map);var mapPanelContainer=addMapPanelContainer(map);var mapWin=new Ext.Panel({renderTo:options.renderTo,autoWidth:true,titleCollapse:true,height:options.map_height,layout:'border',items:[westPanelContainer,mapPanelContainer]});s3.mapWin=mapWin;};S3.gis.addMapPanel=addMapPanel;var addMapWindow=function(map){var s3=map.s3;var options=s3.options;var westPanelContainer=addWestPanel(map);var mapPanelContainer=addMapPanelContainer(map);var mapWin=new Ext.Window({cls:'gis-map-window',collapsible:false,constrain:true,closable:!options.windowNotClosable,closeAction:'hide',autoScroll:true,maximizable:options.maximizable,titleCollapse:false,height:options.map_height,width:options.map_width,layout:'border',items:[westPanelContainer,mapPanelContainer]});mapWin.on('beforehide',function(mw){if(mw.maximized){mw.restore();}});mapWin.on('move',function(mw){map.events.clearMouseCache();});mapWin.on('resize',function(mw,width,height){if(height<842){$('#'+s3.id).removeClass('a0 a1 a2 a3').addClass('a4');}else if(height<1191){$('#'+s3.id).removeClass('a0 a1 a2 a4').addClass('a3');}else if(height<1684){$('#'+s3.id).removeClass('a0 a1 a3 a4').addClass('a2');}else if(height<2384){$('#'+s3.id).removeClass('a0 a2 a3 a4').addClass('a1');}else{$('#'+s3.id).removeClass('a1 a2 a3 a4').addClass('a0');}});if(!options.windowHide){mapWin.show();mapWin.maximize();}
s3.mapWin=mapWin;};S3.gis.addMapWindow=addMapWindow;var addWestPanel=function(map){var s3=map.s3;var west_collapsed=s3.options.west_collapsed||false;var mapWestPanel=new Ext.Panel({header:false,border:false,split:true,items:s3.west_panel_items});if(Ext.isChrome){autoWidth=false;}else{autoWidth=true;}
var westPanelContainer=new Ext.Panel({cls:'gis_west',region:'west',header:false,border:true,autoWidth:autoWidth,width:250,collapsible:true,collapseMode:'mini',collapsed:west_collapsed,items:[mapWestPanel]});s3.westPanelContainer=westPanelContainer;return westPanelContainer;};var addMapPanelContainer=function(map){var s3=map.s3;var options=s3.options;if(options.toolbar){var toolbar=addToolbar(map);}else{if(options.draw_feature){if(options.draw_feature=='active'){var active=true;}else{var active=false;}
addPointControl(map,null,active);}
if(options.draw_line){if(options.draw_line=='active'){var active=true;}else{var active=false;}
addLineControl(map,null,active);}
if(options.draw_polygon){if(options.draw_polygon=='active'){var active=true;}else{var active=false;}
addPolygonControl(map,null,active,true);}
if(options.draw_circle){if(options.draw_circle=='active'){var active=true;}else{var active=false;}
addCircleControl(map,null,active);}
addThrobber(map);}
if(options.save=='float'){addSavePanel(map);}
var mapPanelContainer=new Ext.Panel({layout:'card',region:'center',cls:'mappnlcntr',defaults:{border:false},items:[s3.mapPanel],activeItem:0,tbar:toolbar,scope:this});s3.mapPanelContainer=mapPanelContainer;return mapPanelContainer;};var addLayerTree=function(map){GeoExt.tree.LayerNodeUIS3=Ext.extend(GeoExt.tree.LayerNodeUI,{onClick:function(e){if(e.getTarget('.x-tree-node-cb',1)){var node=this.node;var attributes=this.node.attributes;var group=attributes.checkedGroup;if(group&&group!=='baselayer'){var checked=!attributes.checked;attributes.checked=checked;node.ui.checkbox.checked=checked;node.layer.setVisibility(checked);this.enforceOneVisible();}else{this.toggleCheck(this.isChecked());}}else{GeoExt.tree.LayerNodeUI.superclass.onClick.apply(this,arguments);}},enforceOneVisible:function(){var attributes=this.node.attributes;var group=attributes.checkedGroup;if(group&&group!=='baselayer'){var layer=this.node.layer;var checkedNodes=this.node.getOwnerTree().getChecked();Ext.each(checkedNodes,function(n){var l=n.layer;if(!n.hidden&&n.attributes.checkedGroup===group){if(l!=layer&&attributes.checked){l.setVisibility(false);}}});}}});GeoExt.tree.LayerNodeS3=Ext.extend(GeoExt.tree.LayerNode,{constructor:function(config){this.defaultUI=GeoExt.tree.LayerNodeUIS3;GeoExt.tree.LayerNodeS3.superclass.constructor.apply(this,arguments);}});Ext.tree.TreePanel.nodeTypes.gx_layer=GeoExt.tree.LayerNodeS3;var s3=map.s3;var options=s3.options;if(options.hide_base){var base=false;}else{var base=true;}
if(options.hide_overlays){var overlays=false;}else{var overlays=true;}
if(options.folders_closed){var expanded=false;}else{var expanded=true;}
if(options.folders_radio){var folders_radio=true;}else{var folders_radio=false;}
if(options.wms_browser_url||(options.legend&&options.legend!='float')){var collapsible=true;}else{var collapsible=false;}
var layerStore=s3.mapPanel.layers;var nodesArr=[];var leaf_listeners={click:function(node){var attributes=node.attributes;if(attributes.checkedGroup=='baselayer'){node.ui.toggleCheck(!node.ui.isChecked())}else{var checked=!attributes.checked;attributes.checked=checked;node.ui.checkbox.checked=checked;node.layer.setVisibility(checked);}}};var updateLayout=function(){var westPanelContainer=s3.westPanelContainer;westPanelContainer.fireEvent('collapse');window.setTimeout(function(){westPanelContainer.fireEvent('expand');},300);};var folder_listeners={collapse:function(node){updateLayout()},expand:function(node){updateLayout()}};if(base){var layerTreeBase={text:i18n.gis_base_layers,nodeType:'gx_baselayercontainer',layerStore:layerStore,loader:{baseAttrs:{listeners:leaf_listeners},filter:function(record){var layer=record.getLayer();return layer.displayInLayerSwitcher===true&&layer.isBaseLayer===true&&(layer.dir===undefined||layer.dir==='');}},leaf:false,listeners:folder_listeners,singleClickExpand:true,expanded:expanded};nodesArr.push(layerTreeBase)}
if(overlays){var layerTreeOverlays={text:i18n.gis_overlays,nodeType:'gx_overlaylayercontainer',layerStore:layerStore,loader:{baseAttrs:{listeners:leaf_listeners},filter:function(record){var layer=record.getLayer();return layer.displayInLayerSwitcher===true&&layer.isBaseLayer===false&&(layer.dir===undefined||layer.dir==='');}},leaf:false,listeners:folder_listeners,singleClickExpand:true,expanded:expanded};nodesArr.push(layerTreeOverlays)}
var dirs=map.s3.dirs
var len=dirs.length;if(len){GeoExt.tree.LayerLoaderS3=function(config){Ext.apply(this,config);GeoExt.tree.LayerLoaderS3.superclass.constructor.call(this);};Ext.extend(GeoExt.tree.LayerLoaderS3,GeoExt.tree.LayerLoader,{load:function(node,callback){if(this.fireEvent('beforeload',this,node)){this.removeStoreHandlers();while(node.firstChild){node.removeChild(node.firstChild);}
if(!this.uiProviders){this.uiProviders=node.getOwnerTree().getLoader().uiProviders;}
if(!this.store){this.store=GeoExt.MapPanel.guess().layers;}
this.store.each(function(record){this.addLayerNode(node,record);},this);this.addStoreHandlers(node);var children=node.attributes.children;var len=children.length;if(len){var child,dir,sibling;for(var i=0;i<len;i++){dir=children[i];child=new Ext.tree.TreePanel.nodeTypes[dir.nodeType](dir)
sibling=node.item(0);if(sibling){node.insertBefore(child,sibling);}else{node.appendChild(child);}}}
if(typeof callback=='function'){callback();}
this.fireEvent('load',this,node);}}});var baseAttrs,child,children,dir,_dir,_dirs,_dirslength,folder,folders={},_folders,i,j,loader,parent,sub;for(i=0;i<len;i++){dir=dirs[i];_dirs=dir.split('/');_dirslength=_dirs.length;for(j=0;j<_dirslength;j++){if(j==0){_folders=folders;}else{parent=folder;_folders=_folders[parent];}
folder=_dirs[j];if(!_folders.hasOwnProperty(folder)){_folders[folder]={};}}}
for(dir in folders){_dir=folders[dir];children=[];for(sub in _dir){baseAttrs={listeners:leaf_listeners}
if(folders_radio){baseAttrs['checkedGroup']=sub;}
loader=new GeoExt.tree.LayerLoaderS3({baseAttrs:baseAttrs,filter:(function(dir,sub){return function(read){if(read.data.layer.dir!=='undefined')
return read.data.layer.dir===dir+'/'+sub;};})(dir,sub)});child={text:sub,nodeType:'gx_layercontainer',layerStore:layerStore,children:[],loader:loader,leaf:false,listeners:folder_listeners,singleClickExpand:true,expanded:expanded};children.push(child);}
baseAttrs={listeners:leaf_listeners}
if(folders_radio){baseAttrs['checkedGroup']=dir;}
loader=new GeoExt.tree.LayerLoaderS3({baseAttrs:baseAttrs,filter:(function(dir){return function(read){if(read.data.layer.dir!=='undefined')
return read.data.layer.dir===dir;};})(dir)});child={text:dir,nodeType:'gx_layercontainer',layerStore:layerStore,children:children,loader:loader,leaf:false,listeners:folder_listeners,singleClickExpand:true,expanded:expanded};nodesArr.push(child);}}
var treeRoot=new Ext.tree.AsyncTreeNode({expanded:true,children:nodesArr});var clear_layers=options.clearlayers&options.clearlayers!='toolbar';if(clear_layers||i18n.gis_properties||i18n.gis_uploadlayer){var tbar=new Ext.Toolbar();}else{var tbar=null;}
var layerTree=new Ext.tree.TreePanel({title:i18n.gis_layers,loaderloader:new Ext.tree.TreeLoader({applyLoader:false}),root:treeRoot,rootVisible:false,split:true,collapsible:collapsible,collapseMode:'mini',lines:false,tbar:tbar,enableDD:false});new Ext.tree.TreeSorter(layerTree,{sortType:function(value,node){if(node.attributes.nodeType=='gx_baselayercontainer'){return' ';}else if(node.attributes.nodeType=='gx_overlaylayercontainer'){return'!';}else{return node.text;}}});if(i18n.gis_uploadlayer){addRemoveLayersControl(map,layerTree);}
if(i18n.gis_properties){addLayerPropertiesButton(map,layerTree);}
if(clear_layers){addClearLayersButton(map,layerTree.getTopToolbar());}
return layerTree;};var addWMSBrowser=function(map){var options=map.s3.options;var root=new Ext.tree.AsyncTreeNode({expanded:true,loader:new GeoExt.tree.WMSCapabilitiesLoader({url:OpenLayers.ProxyHost+options.wms_browser_url,layerOptions:{buffer:1,singleTile:false,ratio:1,wrapDateLine:true},layerParams:{'TRANSPARENT':'TRUE'},createNode:function(attr){attr.checked=attr.leaf?false:undefined;return GeoExt.tree.WMSCapabilitiesLoader.prototype.createNode.apply(this,[attr]);}})});var wmsBrowser=new Ext.tree.TreePanel({title:options.wms_browser_name,root:root,rootVisible:false,split:true,autoScroll:true,collapsible:true,collapseMode:'mini',lines:false,listeners:{'checkchange':function(node,checked){if(checked===true){map.addLayer(node.attributes.layer);}else{map.removeLayer(node.attributes.layer);}}}});return wmsBrowser;};var showThrobber=function(map_id){$('#'+map_id+' .layer_throbber').show().removeClass('hide');};var hideThrobber=function(layer,map){if(layer){var s3=layer.map.s3;var layers_loading=s3.layers_loading;layers_loading.pop(layer.s3_layer_id);}else{var s3=map.s3;var layers_loading=map.s3.layers_loading;}
if(layers_loading.length===0){$('#'+s3.id+' .layer_throbber').hide().addClass('hide');}};var layer_loadstart=function(event){var layer=event.object;var s3=layer.map.s3;showThrobber(s3.id);var layer_id=layer.s3_layer_id;var layers_loading=s3.layers_loading;layers_loading.pop(layer_id);layers_loading.push(layer_id);};var layer_loadend=function(event){var layer=event.object,response=event.response;if(response&&response.priv){var priv=response.priv;try{var s3=JSON.parse(priv.responseText).s3;}catch(e){}}else{hideThrobber(layer);return;}
if(undefined!=s3){if(undefined!=s3.level){var strategy,strategies=layer.strategies;for(var i=0,len=strategies.length;i<len;i++){strategy=strategies[i];if(strategy.CLASS_NAME=='OpenLayers.Strategy.ZoomBBOX'){strategy.level=s3.level;break;}}}
if(undefined!=s3.style){var restyle=true;var style=s3.style;var result=createStyleMap(layer.map,style);var marker_url=result[1];layer.legendURL=marker_url;layer.styleMap=result[0];layer.s3_popup_format=style.popup_format;layer.s3_style=style.style;layer.s3_url_format=style.url_format;var strategy,strategies=layer.strategies;for(var i=0,len=strategies.length;i<len;i++){strategy=strategies[i];if(strategy.CLASS_NAME=='OpenLayers.Strategy.AttributeCluster'){if(style.cluster_threshold!=undefined){var cluster_threshold=style.cluster_threshold;}else{var cluster_threshold=cluster_threshold_default;}
if(cluster_threshold){var cluster_distance=style.cluster_distance||cluster_distance_default;if((!strategy.active)||(cluster_distance!=strategy.distance)||(cluster_threshold!=strategy.threshold)){strategy.distance=cluster_distance;strategy.threshold=cluster_threshold;strategy.activate();strategy.features=layer.features;strategy.recluster();}}else if(strategy.active){strategy.deactivate();var features=layer.features;var i,j,cluster,_cluster,clusters=[],cluster_len,new_features=[],features_len=features.length;for(i=0;i<features_len;i++){if(features[i].cluster){cluster=features[i];_cluster=cluster.cluster;cluster_len=_cluster.length;for(j=0;j<cluster_len;j++){new_features.push(_cluster[j]);}
clusters.push(cluster);}}
layer.removeFeatures(clusters);layer.addFeatures(new_features);}
break;}}}}
hideThrobber(layer);if(priv.status==509){S3.showAlert(i18n.gis_too_many_features,'warning');}else{var s3_style=layer.s3_style;if(s3_style&&Object.prototype.toString.call(s3_style)==='[object Array]'&&s3_style.length==1){var rules=reStyle(layer);var restyle=true;}}
if(undefined!=restyle){var features=layer.features;var i,features_len=features.length;for(i=0;i<features_len;i++){layer.drawFeature(features[i]);}
var legendPanel=layer.map.s3.mapPanel.legendPanel;if(legendPanel){var layerLegend,layerLegends=legendPanel.items.items,s3_layer_id=layer.s3_layer_id;var layerLegends_len=layerLegends.length;for(i=0;i<layerLegends_len;i++){layerLegend=layerLegends[i];if((layerLegend.layer)&&(layerLegend.layer.s3_layer_id==s3_layer_id)){if(undefined!=rules){if(layerLegend.xtype=='gx_vectorlegend'){layerLegend.rules=rules;layerLegend.update();}else{var record=layerLegend.layerRecord;legendPanel.removeLegend(record);legendPanel.addLegend(record,i);}}else if(undefined!=marker_url){if(layerLegend.xtype=='gx_urllegend'){layerLegend.layerRecord.data.legendURL=marker_url;layerLegend.update();}else{var record=layerLegend.layerRecord;record.data.legendURL=marker_url;legendPanel.removeLegend(record);legendPanel.addLegend(record,i);}}
break;}}}}};var reStyle=function(layer){var defaults=layer.s3_style[0];var prop=defaults['prop'];var features=layer.features;var i,features_len=features.length,data=[];for(i=0;i<features_len;i++){data.push(features[i].attributes[prop]);}
data.sort(function(a,b){return a-b;});var seen={};$.each(data,function(){seen[this]=1;});var classes=Object.keys(seen).length;if(classes>=5){classes=5;var colors=['ffffb2','fecc5c','fd8d3c','f03b20','bd0026'];}else if(classes==4){var colors=['ffffb2','fecc5c','fd8d3c','e31a1c'];}else if(classes==3){var colors=['ffeda0','feb24c','f03b20'];}else if(classes==2){var colors=['ffeda0','f03b20'];}else if(classes==1){var colors=['feb24c'];}
var classSize=Math.round(features_len/classes);var step=classSize;var breaks=[data[0]];for(i=1;i<classes;i++){breaks[i]=data[step]||data[features_len-1];step+=classSize;}
breaks.push(data[features_len-1]);var low,high,_style,style=[];for(i=0;i<classes;i++){low=breaks[i];high=breaks[i+1];_style=$.extend({},defaults);_style['fill']=colors[i];_style['low']=low;_style['high']=high;if(low==high){_style['label']=low.toString();}else{_style['label']=low+' - '+high;}
style.push(_style);}
var _layer={'style':style,'cluster_threshold':0,'opacity':0.9};var rules=styleRules(_layer);layer.styleMap.styles['default'].rules=rules;return rules;};var layer_visibilitychanged=function(event){showLegend(event.object.map);};var addLayers=function(map){var s3=map.s3;var options=s3.options;s3.dirs=[];s3.layers_loading=[];s3.layers_nopopups=[];var i;if(options.layers_osm){var layers_osm=options.layers_osm;for(i=layers_osm.length;i>0;i--){addOSMLayer(map,layers_osm[i-1]);}}
try{if(google){addGoogleLayers(map);}}catch(e){}
if(options.Bing){addBingLayers(map);}
if(options.layers_tms){var layers_tms=options.layers_tms;for(i=layers_tms.length;i>0;i--){addTMSLayer(map,layers_tms[i-1]);}}
if(options.layers_wms){var layers_wms=options.layers_wms;for(i=layers_wms.length;i>0;i--){addWMSLayer(map,layers_wms[i-1]);}}
if(options.layers_xyz){var layers_xyz=options.layers_xyz;for(i=layers_xyz.length;i>0;i--){addXYZLayer(map,layers_xyz[i-1]);}}
if(options.EmptyLayer){var layer=new OpenLayers.Layer(options.EmptyLayer.name,{isBaseLayer:true,displayInLayerSwitcher:true,s3_layer_id:options.EmptyLayer.id,s3_layer_type:'empty'});map.addLayer(layer);if(options.EmptyLayer.base){map.setBaseLayer(layer);}}
if(options.layers_js){var layers_js=options.layers_js;for(i=layers_js.length;i>0;i--){eval(map,layers_js[i-1]);}}
if(options.layers_theme){var layers_theme=options.layers_theme;for(i=layers_theme.length;i>0;i--){addGeoJSONLayer(map,layers_theme[i-1]);}}
if(options.layers_geojson){var layers_geojson=options.layers_geojson;for(i=layers_geojson.length;i>0;i--){addGeoJSONLayer(map,layers_geojson[i-1]);}}
if(options.layers_gpx){var layers_gpx=options.layers_gpx;for(i=layers_gpx.length;i>0;i--){addGPXLayer(map,layers_gpx[i-1]);}}
if(options.layers_arcrest){var layers_arcrest=options.layers_arcrest;for(i=layers_arcrest.length;i>0;i--){addArcRESTLayer(map,layers_arcrest[i-1]);}}
if(options.CoordinateGrid){addCoordinateGrid(map);}
if(options.layers_georss){var layers_georss=options.layers_georss;for(i=layers_georss.length;i>0;i--){addGeoJSONLayer(map,layers_georss[i-1]);}}
if(options.layers_kml){var layers_kml=options.layers_kml;for(i=layers_kml.length;i>0;i--){addKMLLayer(map,layers_kml[i-1]);}}
if(options.OWM){addOWMLayers(map);}
if(options.layers_shapefile){var layers_shapefile=options.layers_shapefile;for(i=layers_shapefile.length;i>0;i--){addGeoJSONLayer(map,layers_shapefile[i-1]);}}
if(options.layers_wfs){var layers_wfs=options.layers_wfs;for(i=layers_wfs.length;i>0;i--){addWFSLayer(map,layers_wfs[i-1]);}}
if(options.feature_queries){var feature_queries=options.feature_queries;for(i=feature_queries.length;i>0;i--){addGeoJSONLayer(map,feature_queries[i-1]);}}
if(options.feature_resources){var feature_resources=options.feature_resources;for(i=feature_resources.length;i>0;i--){addGeoJSONLayer(map,feature_resources[i-1]);}}
if(options.layers_feature){var layers_feature=options.layers_feature;for(i=layers_feature.length;i>0;i--){addGeoJSONLayer(map,layers_feature[i-1]);}}
if(options.features||options.draw_feature||options.draw_polygon||options.draw_circle||navigator.geolocation){var draftLayer=addDraftLayer(map);}
if(options.features){var features=options.features;var current_projection=map.getProjectionObject();for(i=0;i<features.length;i++){var feature=format_geojson.parseFeature(features[i]);feature.geometry.transform(proj4326,current_projection);draftLayer.addFeatures([feature]);}}};var addArcRESTLayer=function(map,layer){var name=layer.name;var url=[layer.url];if(undefined!=layer.layers){var layers=layer.layers.join();}else{var layers=0;}
if(undefined!=layer.dir){var dir=layer.dir;if($.inArray(dir,map.s3.dirs)==-1){map.s3.dirs.push(dir);}}else{var dir='';}
if(undefined!=layer.base){var isBaseLayer=layer.base;}else{var isBaseLayer=false;}
if(undefined!=layer.format){var format=layer.format;}else{var format='png';}
if(undefined!=layer.transparent){var transparent=layer.transparent;}else{var transparent=true;}
if(undefined!=layer.visibility){var visibility=layer.visibility;}else{var visibility=true;}
var arcRESTLayer=new OpenLayers.Layer.ArcGIS93Rest(name,url,{layers:'show:'+layers,isBaseLayer:isBaseLayer,transparent:transparent,format:format,dir:dir,s3_layer_id:layer.id,s3_layer_type:'arcrest'});arcRESTLayer.setVisibility(visibility);map.addLayer(arcRESTLayer);if(layer._base){map.setBaseLayer(arcRESTLayer);}};var addBingLayers=function(map){var bing=map.s3.options.Bing;var ApiKey=bing.ApiKey;var layer;if(bing.Aerial){layer=new OpenLayers.Layer.Bing({key:ApiKey,type:'Aerial',name:bing.Aerial.name,s3_layer_id:bing.Aerial.id,s3_layer_type:'bing'});map.addLayer(layer);if(bing.Base=='aerial'){map.setBaseLayer(layer);}}
if(bing.Road){layer=new OpenLayers.Layer.Bing({key:ApiKey,type:'Road',name:bing.Road.name,s3_layer_id:bing.Road.id,s3_layer_type:'bing'});map.addLayer(layer);if(bing.Base=='road'){map.setBaseLayer(layer);}}
if(bing.Hybrid){layer=new OpenLayers.Layer.Bing({key:ApiKey,type:'AerialWithLabels',name:bing.Hybrid.name,s3_layer_id:bing.Hybrid.id,s3_layer_type:'bing'});map.addLayer(layer);if(bing.Base=='hybrid'){map.setBaseLayer(layer);}}};var addCoordinateGrid=function(map){var CoordinateGrid=map.s3.options.CoordinateGrid;var graticule=new OpenLayers.Control.Graticule({layerName:CoordinateGrid.name,visible:CoordinateGrid.visibility});map.addControl(graticule);};var addDraftLayer=function(map){var marker,style,options=map.s3.options;if(options.draw_feature){var marker=options.marker_default;}
if(options.draft_style){var style=options.draft_style;}
var layer={'marker':marker,'style':style,'opacity':0.9};var response=createStyleMap(map,layer);var featureStyleMap=response[0];var marker_url=response[1];var draftLayer=new OpenLayers.Layer.Vector(i18n.gis_draft_layer,{displayInLayerSwitcher:false,legendURL:marker_url,styleMap:featureStyleMap});draftLayer.setVisibility(true);map.addLayer(draftLayer);map.s3.draftLayer=draftLayer;return draftLayer;};var addGeoJSONLayer=function(map,layer){var s3=map.s3;var name=layer.name;if(layer.no_popups){s3.layers_nopopups.push(name);}
var url=layer.url;if(url.indexOf('$search')!==-1){var readWithPOST=true;}else{var readWithPOST=false;}
if(undefined!=layer.refresh){var refresh=layer.refresh;}else{var refresh=900;}
if(undefined!=layer.dir){var dir=layer.dir;if($.inArray(dir,s3.dirs)==-1){s3.dirs.push(dir);}}else{var dir='';}
if(undefined!=layer.visibility){var visibility=layer.visibility;}else{var visibility=true;}
if(undefined!=layer.cluster_attribute){var cluster_attribute=layer.cluster_attribute;}else{var cluster_attribute='colour';}
if(undefined!=layer.cluster_distance){var cluster_distance=layer.cluster_distance;}else{var cluster_distance=cluster_distance_default;}
if(undefined!=layer.cluster_threshold){var cluster_threshold=layer.cluster_threshold;}else{var cluster_threshold=cluster_threshold_default;}
if(undefined!=layer.projection){var projection=layer.projection;}else{var projection=4326;}
if(4326==projection){projection=proj4326;}else{projection=new OpenLayers.Projection('EPSG:'+projection);}
if(undefined!=layer.type){var layer_type=layer.type;}else{var layer_type='feature';}
var legendTitle='<div class="gis_layer_legend"><div class="gis_legend_title">'+name+'</div>';if(undefined!=layer.desc){legendTitle+='<div class="gis_legend_desc">'+layer.desc+'</div>';}
if((undefined!=layer.src)||(undefined!=layer.src_url)){var source='<div class="gis_legend_src">';if(undefined!=layer.src_url){source+='<a href="'+layer.src_url+'" target="_blank">'
if(undefined!=layer.src){source+=layer.src;}else{source+=layer.src_url;}
source+='</a>';}else{source+=layer.src;}
source+='</div>';legendTitle+=source;}
legendTitle+='</div>';var response=createStyleMap(map,layer);var featureStyleMap=response[0];var marker_url=response[1];var strategies=[new OpenLayers.Strategy.ZoomBBOX({ratio:1.5})]
if(refresh){strategies.push(new OpenLayers.Strategy.Refresh({force:true,interval:refresh*1000}));}
if(cluster_threshold||layer.cluster){strategies.push(new OpenLayers.Strategy.AttributeCluster({attribute:cluster_attribute,distance:cluster_distance,threshold:cluster_threshold}))}
var geojsonLayer=new OpenLayers.Layer.Vector(name,{dir:dir,projection:projection,protocol:new OpenLayers.Protocol.HTTP({url:url,format:format_geojson,readWithPOST:readWithPOST}),legendURL:marker_url,strategies:strategies,styleMap:featureStyleMap,s3_layer_id:layer.id,s3_layer_type:layer_type,s3_style:layer.style,s3_url_format:layer.url_format});geojsonLayer.legendTitle=legendTitle;if(undefined!=layer.popup_format){geojsonLayer.s3_popup_format=layer.popup_format;}
geojsonLayer.setVisibility(visibility);geojsonLayer.events.on({'loadstart':layer_loadstart,'loadend':layer_loadend,'visibilitychanged':layer_visibilitychanged});map.addLayer(geojsonLayer);};var addGoogleLayers=function(map){var google=map.s3.options.Google;var layer;if(google.MapMaker||google.MapMakerHybrid){if(google.Satellite){layer=new OpenLayers.Layer.Google(google.Satellite.name,{type:G_SATELLITE_MAP,sphericalMercator:true,s3_layer_id:google.Satellite.id,s3_layer_type:'google'});map.addLayer(layer);if(google.Base=='satellite'){map.setBaseLayer(layer);}}
if(google.Maps){layer=new OpenLayers.Layer.Google(google.Maps.name,{type:G_NORMAL_MAP,sphericalMercator:true,s3_layer_id:google.Maps.id,s3_layer_type:'google'});map.addLayer(layer);if(google.Base=='maps'){map.setBaseLayer(layer);}}
if(google.Hybrid){layer=new OpenLayers.Layer.Google(google.Hybrid.name,{type:G_HYBRID_MAP,sphericalMercator:true,s3_layer_id:google.Hybrid.id,s3_layer_type:'google'});map.addLayer(layer);if(google.Base=='maps'){map.setBaseLayer(layer);}}
if(google.Terrain){layer=new OpenLayers.Layer.Google(google.Terrain.name,{type:G_PHYSICAL_MAP,sphericalMercator:true,s3_layer_id:google.Terrain.id,s3_layer_type:'google'});map.addLayer(layer);if(google.Base=='terrain'){map.setBaseLayer(layer);}}
if(google.MapMaker){layer=new OpenLayers.Layer.Google(google.MapMaker.name,{type:G_MAPMAKER_NORMAL_MAP,sphericalMercator:true,s3_layer_id:layer.id,s3_layer_type:'google'});map.addLayer(layer);if(google.Base=='mapmaker'){map.setBaseLayer(layer);}}
if(google.MapMakerHybrid){layer=new OpenLayers.Layer.Google(google.MapMakerHybrid.name,{type:G_MAPMAKER_HYBRID_MAP,sphericalMercator:true,s3_layer_id:layer.id,s3_layer_type:'google'});map.addLayer(layer);if(google.Base=='mapmakerhybrid'){map.setBaseLayer(layer);}}}else{if(google.Satellite){layer=new OpenLayers.Layer.Google(google.Satellite.name,{type:'satellite',numZoomLevels:22,s3_layer_id:google.Satellite.id,s3_layer_type:'google'});map.addLayer(layer);if(google.Base=='satellite'){map.setBaseLayer(layer);}}
if(google.Maps){layer=new OpenLayers.Layer.Google(google.Maps.name,{numZoomLevels:20,s3_layer_id:google.Maps.id,s3_layer_type:'google'});map.addLayer(layer);if(google.Base=='maps'){map.setBaseLayer(layer);}}
if(google.Hybrid){layer=new OpenLayers.Layer.Google(google.Hybrid.name,{type:'hybrid',numZoomLevels:20,s3_layer_id:google.Hybrid.id,s3_layer_type:'google'});map.addLayer(layer);if(google.Base=='hybrid'){map.setBaseLayer(layer);}}
if(google.Terrain){layer=new OpenLayers.Layer.Google(google.Terrain.name,{type:'terrain',s3_layer_id:google.Terrain.id,s3_layer_type:'google'});map.addLayer(layer);if(google.Base=='terrain'){map.setBaseLayer(layer);}}}};var addGPXLayer=function(map,layer){var name=layer.name;var url=layer.url;var marker=layer.marker;var marker_url=marker_url_path+marker.i;var marker_height=marker.h;var marker_width=marker.w;if(undefined!=layer.waypoints){var waypoints=layer.waypoints;}else{var waypoints=true;}
if(undefined!=layer.tracks){var tracks=layer.tracks;}else{var tracks=true;}
if(undefined!=layer.routes){var routes=layer.routes;}else{var routes=true;}
if(undefined!=layer.visibility){var visibility=layer.visibility;}else{var visibility=true;}
if(undefined!=layer.dir){var dir=layer.dir;if($.inArray(dir,map.s3.dirs)==-1){map.s3.dirs.push(dir);}}else{var dir='';}
if(undefined!=layer.opacity){var opacity=layer.opacity;}else{var opacity=1;}
if(undefined!=layer.cluster_distance){var cluster_distance=layer.cluster_distance;}else{var cluster_distance=cluster_distance_default;}
if(undefined!=layer.cluster_threshold){var cluster_threshold=layer.cluster_threshold;}else{var cluster_threshold=cluster_threshold_default;}
var style_marker=OpenLayers.Util.extend({},OpenLayers.Feature.Vector.style['default']);if(waypoints){style_marker.graphicOpacity=opacity;style_marker.graphicWidth=marker_width;style_marker.graphicHeight=marker_height;style_marker.graphicXOffset=-(marker_width/2);style_marker.graphicYOffset=-marker_height;style_marker.externalGraphic=marker_url;}else{style_marker.externalGraphic='';}
style_marker.strokeColor='blue';style_marker.strokeWidth=6;style_marker.strokeOpacity=opacity;var gpxLayer=new OpenLayers.Layer.Vector(name,{dir:dir,projection:proj4326,strategies:[new OpenLayers.Strategy.Fixed(),new OpenLayers.Strategy.Cluster({distance:cluster_distance,threshold:cluster_threshold})],legendURL:marker_url,s3_layer_id:layer.id,s3_layer_type:'gpx',style:style_marker,protocol:new OpenLayers.Protocol.HTTP({url:url,format:new OpenLayers.Format.GPX({extractAttributes:true,extractWaypoints:waypoints,extractTracks:tracks,extractRoutes:routes})})});gpxLayer.setVisibility(visibility);gpxLayer.events.on({'loadstart':layer_loadstart,'loadend':layer_loadend,'visibilitychanged':layer_visibilitychanged});map.addLayer(gpxLayer);};var addKMLLayer=function(map,layer){var s3=map.s3;var name=layer.name;var url=layer.url;if(undefined!=layer.title){var title=layer.title;}else{var title='name';}
if(undefined!=layer.body){var body=layer.body;}else{var body='description';}
if(undefined!=layer.refresh){var refresh=layer.refresh;}else{var refresh=900;}
if(undefined!=layer.visibility){var visibility=layer.visibility;}else{var visibility=true;}
if(undefined!=layer.dir){var dir=layer.dir;if($.inArray(dir,s3.dirs)==-1){s3.dirs.push(dir);}}else{var dir='';}
if(undefined!=layer.cluster_distance){var cluster_distance=layer.cluster_distance;}else{var cluster_distance=cluster_distance_default;}
if(undefined!=layer.cluster_threshold){var cluster_threshold=layer.cluster_threshold;}else{var cluster_threshold=cluster_threshold_default;}
var response=createStyleMap(map,layer);var featureStyleMap=response[0];var format=new OpenLayers.Format.KML({extractStyles:true,extractAttributes:true,maxDepth:2});var strategies=[new OpenLayers.Strategy.Fixed()]
if(refresh){strategies.push(new OpenLayers.Strategy.Refresh({force:true,interval:refresh*1000}));}
if(cluster_threshold){strategies.push(new OpenLayers.Strategy.Cluster({distance:cluster_distance,threshold:cluster_threshold}))}
var kmlLayer=new OpenLayers.Layer.Vector(name,{dir:dir,projection:proj4326,protocol:new OpenLayers.Protocol.HTTP({url:url,format:format}),strategies:strategies,styleMap:featureStyleMap,s3_layer_id:layer.id,s3_layer_type:'kml',s3_style:layer.style});kmlLayer.title=title;kmlLayer.body=body;kmlLayer.setVisibility(visibility);kmlLayer.events.on({'loadstart':layer_loadstart,'loadend':layer_loadend,'visibilitychanged':layer_visibilitychanged});map.addLayer(kmlLayer);};var addOSMLayer=function(map,layer){var name=layer.name;var url=[layer.url1];if(undefined!=layer.url2){url.push(layer.url2);}
if(undefined!=layer.url3){url.push(layer.url3);}
if(undefined!=layer.visibility){var visibility=layer.visibility;}else{var visibility=true;}
if(undefined!=layer.dir){var dir=layer.dir;if($.inArray(dir,map.s3.dirs)==-1){map.s3.dirs.push(dir);}}else{var dir='';}
if(undefined!=layer.base){var isBaseLayer=layer.base;}else{var isBaseLayer=true;}
if(undefined!=layer.zoomLevels){var numZoomLevels=layer.zoomLevels;}else{var numZoomLevels=19;}
var osmLayer=new OpenLayers.Layer.TMS(name,url,{dir:dir,type:'png',getURL:osm_getTileURL,displayOutsideMaxExtent:true,numZoomLevels:numZoomLevels,isBaseLayer:isBaseLayer,s3_layer_id:layer.id,s3_layer_type:'openstreetmap'});if(undefined!=layer.attribution){osmLayer.attribution=layer.attribution;}
osmLayer.setVisibility(visibility);osmLayer.events.on({'loadstart':layer_loadstart,'loadend':layer_loadend});map.addLayer(osmLayer);if(layer._base){map.setBaseLayer(osmLayer);}};var osm_getTileURL=function(bounds){var res=this.map.getResolution();var x=Math.round((bounds.left-this.maxExtent.left)/(res*this.tileSize.w));var y=Math.round((this.maxExtent.top-bounds.top)/(res*this.tileSize.h));var z=this.map.getZoom();var limit=Math.pow(2,z);if(y<0||y>=limit){return OpenLayers.Util.getImagesLocation()+'404.png';}else{x=((x%limit)+limit)%limit;var path=z+'/'+x+'/'+y+'.'+this.type;var url=this.url;if(url instanceof Array){url=this.selectUrl(path,url);}
return url+path;}};var addOWMLayers=function(map){var owm=map.s3.options.OWM;var layer;if(owm.station){layer=new OpenLayers.Layer.Vector.OWMStations(owm.station.name,{dir:owm.station.dir,s3_layer_id:owm.station.id,s3_layer_type:'openweathermap'});layer.setVisibility(owm.station.visibility);layer.events.on({'featureselected':layer.onSelect,'featureunselected':layer.onUnselect,'loadstart':layer_loadstart,'loadend':layer_loadend,'visibilitychanged':layer_visibilitychanged});map.addLayer(layer);}
if(owm.city){layer=new OpenLayers.Layer.Vector.OWMWeather(owm.city.name,{dir:owm.city.dir,s3_layer_id:owm.city.id,s3_layer_type:'openweathermap'});layer.setVisibility(owm.city.visibility);layer.events.on({'featureselected':layer.onSelect,'featureunselected':layer.onUnselect,'loadstart':layer_loadstart,'loadend':layer_loadend,'visibilitychanged':layer_visibilitychanged});map.addLayer(layer);}};var addTMSLayer=function(map,layer){var name=layer.name;var url=[layer.url];if(undefined!=layer.url2){url.push(layer.url2);}
if(undefined!=layer.url3){url.push(layer.url3);}
var layername=layer.layername;if(undefined!=layer.zoomLevels){var numZoomLevels=layer.zoomLevels;}else{var numZoomLevels=19;}
if(undefined!=layer.dir){var dir=layer.dir;if($.inArray(dir,map.s3.dirs)==-1){map.s3.dirs.push(dir);}}else{var dir='';}
if(undefined!=layer.format){var format=layer.format;}else{var format='png';}
var tmsLayer=new OpenLayers.Layer.TMS(name,url,{dir:dir,s3_layer_id:layer.id,s3_layer_type:'tms',layername:layername,type:format,numZoomLevels:numZoomLevels});if(undefined!=layer.attribution){tmsLayer.attribution=layer.attribution;}
tmsLayer.events.on({'loadstart':layer_loadstart,'loadend':layer_loadend});map.addLayer(tmsLayer);if(layer._base){map.setBaseLayer(tmsLayer);}};var addWFSLayer=function(map,layer){var name=layer.name;var url=layer.url;if((undefined!=layer.username)&&(undefined!=layer.password)){var username=layer.username;var password=layer.password;url=url.replace('://','://'+username+':'+password+'@');}
var title=layer.title;var featureType=layer.featureType;if(undefined!=layer.featureNS){var featureNS=layer.featureNS;}else{var featureNS=null;}
if(undefined!=layer.schema){var schema=layer.schema;}else{var schema=null;}
if(undefined!=layer.version){var version=layer.version;}else{var version='1.1.0';}
if(undefined!=layer.geometryName){var geometryName=layer.geometryName;}else{var geometryName='the_geom';}
if(undefined!=layer.visibility){var visibility=layer.visibility;}else{var visibility=true;}
if(undefined!=layer.dir){var dir=layer.dir;if($.inArray(dir,map.s3.dirs)==-1){map.s3.dirs.push(dir);}}else{var dir='';}
if(undefined!=layer.cluster_attribute){var cluster_attribute=layer.cluster_attribute;}else{var cluster_attribute='colour';}
if(undefined!=layer.cluster_distance){var cluster_distance=layer.cluster_distance;}else{var cluster_distance=cluster_distance_default;}
if(undefined!=layer.cluster_threshold){var cluster_threshold=layer.cluster_threshold;}else{var cluster_threshold=cluster_threshold_default;}
if(undefined!=layer.refresh){var refresh=layer.refresh;}else{var refresh=false;}
var strategies=[new OpenLayers.Strategy.BBOX({ratio:1.5})]
if(refresh){strategies.push(new OpenLayers.Strategy.Refresh({force:true,interval:refresh*1000}));}
if(cluster_threshold){strategies.push(new OpenLayers.Strategy.AttributeCluster({attribute:cluster_attribute,distance:cluster_distance,threshold:cluster_threshold}))}
if(undefined!=layer.projection){var projection=layer.projection;var srsName='EPSG:'+projection;}else{var projection='4326';var srsName='EPSG:4326';}
var protocol=new OpenLayers.Protocol.WFS({version:version,srsName:srsName,url:url,featureType:featureType,featureNS:featureNS,geometryName:geometryName,schema:schema});var legendTitle='<div class="gis_layer_legend"><div class="gis_legend_title">'+name+'</div>';if(undefined!=layer.desc){legendTitle+='<div class="gis_legend_desc">'+layer.desc+'</div>';}
if((undefined!=layer.src)||(undefined!=layer.src_url)){var source='<div class="gis_legend_src">';if(undefined!=layer.src_url){source+='<a href="'+layer.src_url+'" target="_blank">'
if(undefined!=layer.src){source+=layer.src;}else{source+=layer.src_url;}
source+='</a>';}else{source+=layer.src;}
source+='</div>';legendTitle+=source;}
legendTitle+='</div>';var response=createStyleMap(map,layer);var featureStyleMap=response[0];var marker_url=response[1];if('4326'==projection){projection=proj4326;}else{projection=new OpenLayers.Projection('EPSG:'+projection);}
var wfsLayer=new OpenLayers.Layer.Vector(name,{maxFeatures:1000,strategies:strategies,dir:dir,legendURL:marker_url,projection:projection,protocol:protocol,styleMap:featureStyleMap,s3_layer_id:layer.id,s3_layer_type:'wfs',s3_style:layer.style});wfsLayer.legendTitle=legendTitle;wfsLayer.title=title;wfsLayer.setVisibility(visibility);wfsLayer.events.on({'loadstart':layer_loadstart,'loadend':layer_loadend,'visibilitychanged':layer_visibilitychanged});map.addLayer(wfsLayer);};var addWMSLayer=function(map,layer){var name=layer.name;var url=layer.url;if(layer.username&&layer.password){var username=layer.username;var password=layer.password;url=url.replace('://','://'+username+':'+password+'@');}
var layers=layer.layers;if(undefined!=layer.visibility){var visibility=layer.visibility;}else{var visibility=true;}
if(undefined!=layer.dir){var dir=layer.dir;if($.inArray(dir,map.s3.dirs)==-1){map.s3.dirs.push(dir);}}else{var dir='';}
if(undefined!=layer.base){var isBaseLayer=layer.base;}else{var isBaseLayer=false;}
if(undefined!=layer.transparent){var transparent=layer.transparent;}else{var transparent=true;}
if(undefined!=layer.format){var format=layer.format;}else{var format='image/png';}
if(undefined!=layer.version){var version=layer.version;}else{var version='1.1.1';}
if(layer.map){var wms_map=layer.map;}else{var wms_map='';}
if(layer.style){var style=layer.style;}else{var style='';}
if(undefined!=layer.bgcolor){var bgcolor='0x'+layer.bgcolor;}else{var bgcolor='';}
if(undefined!=layer.buffer){var buffer=layer.buffer;}else{var buffer=0;}
if(undefined!=layer.tiled){var tiled=layer.tiled;}else{var tiled=false;}
if(undefined!=layer.opacity){var opacity=layer.opacity;}else{var opacity=1;}
if(undefined!=layer.queryable){var queryable=layer.queryable;}else{var queryable=1;}
var legendTitle='<div class="gis_layer_legend"><div class="gis_legend_title">'+name+'</div>';if(undefined!=layer.desc){legendTitle+='<div class="gis_legend_desc">'+layer.desc+'</div>';}
if(map.s3.options.metadata){if(undefined!=layer.post_id){if(i18n.gis_metadata){var label=i18n.gis_metadata;var murl=S3.Ap.concat('/cms/page/'+layer.post_id);}else{var label=i18n.gis_metadata_edit;var murl=S3.Ap.concat('/cms/post/'+layer.post_id+'/update?layer_id='+layer.id);}}else if(i18n.gis_metadata_create){var label=i18n.gis_metadata_create;var murl=S3.Ap.concat('/cms/post/create?layer_id='+layer.id);}else{var label='';}
if(label){source='<div class="gis_legend_src"><a href="'+murl+'" target="_blank">'+label+'</a></div>';legendTitle+=source;}}else if((undefined!=layer.src)||(undefined!=layer.src_url)){var source='<div class="gis_legend_src">';if(undefined!=layer.src_url){source+='<a href="'+layer.src_url+'" target="_blank">';if(undefined!=layer.src){source+=layer.src;}else{source+=layer.src_url;}
source+='</a>';}else{source+=layer.src;}
source+='</div>';legendTitle+=source;}
legendTitle+='</div>';if(undefined!=layer.legendURL){var legendURL=layer.legendURL;}else{var legendURL;}
var wmsLayer=new OpenLayers.Layer.WMS(name,url,{layers:layers,transparent:transparent},{dir:dir,wrapDateLine:true,isBaseLayer:isBaseLayer,s3_layer_id:layer.id,s3_layer_type:'wms',queryable:queryable,visibility:visibility});if(wms_map){wmsLayer.params.MAP=wms_map;}
if(format){wmsLayer.params.FORMAT=format;}
if(version){wmsLayer.params.VERSION=version;}
if(style){wmsLayer.params.STYLES=style;}
if(bgcolor){wmsLayer.params.BGCOLOR=bgcolor;}
if(tiled){wmsLayer.params.TILED=true;wmsLayer.params.TILESORIGIN=[map.maxExtent.left,map.maxExtent.bottom];}
if(!isBaseLayer){wmsLayer.opacity=opacity;if(buffer){wmsLayer.buffer=buffer;}else{wmsLayer.buffer=0;}}
wmsLayer.legendTitle=legendTitle;if(legendURL){wmsLayer.legendURL=legendURL;}
wmsLayer.events.on({'loadstart':layer_loadstart,'loadend':layer_loadend,'visibilitychanged':layer_visibilitychanged});map.addLayer(wmsLayer);if(layer._base){map.setBaseLayer(wmsLayer);}};var addXYZLayer=function(map,layer){var name=layer.name;var url=[layer.url];if(undefined!=layer.url2){url.push(layer.url2);}
if(undefined!=layer.url3){url.push(layer.url3);}
var layername=layer.layername;if(undefined!=layer.zoomLevels){var numZoomLevels=layer.zoomLevels;}else{var numZoomLevels=19;}
if(undefined!=layer.dir){var dir=layer.dir;if($.inArray(dir,map.s3.dirs)==-1){map.s3.dirs.push(dir);}}else{var dir='';}
if(undefined!=layer.format){var format=layer.format;}else{var format='png';}
var xyzLayer=new OpenLayers.Layer.XYZ(name,url,{dir:dir,s3_layer_id:layer.id,s3_layer_type:'xyz',layername:layername,type:format,numZoomLevels:numZoomLevels});if(undefined!=layer.attribution){xyzLayer.attribution=layer.attribution;}
xyzLayer.events.on({'loadstart':layer_loadstart,'loadend':layer_loadend});map.addLayer(xyzLayer);if(layer._base){map.setBaseLayer(xyzLayer);}};var addControls=function(map){var options=map.s3.options;var navControl=new OpenLayers.Control.Navigation();if(options.no_zoom_wheel){navControl.zoomWheelEnabled=false;}
map.addControl(navControl);if(options.zoomcontrol==undefined){map.addControl(new OpenLayers.Control.Zoom());}
map.addControl(new OpenLayers.Control.ArgParser());map.addControl(new OpenLayers.Control.Attribution());if(options.scaleline==undefined){map.addControl(new OpenLayers.Control.ScaleLine());}
if(options.mouse_position=='mgrs'){map.addControl(new OpenLayers.Control.MGRSMousePosition());}else if(options.mouse_position){map.addControl(new OpenLayers.Control.MousePosition());}
if(options.permalink==undefined){map.addControl(new OpenLayers.Control.Permalink());}
if(options.overview==undefined){var ov_options={};var map_options=map.options;var prop;for(prop in map_options){if(prop!='controls'){ov_options[prop]=map_options[prop];}}
map.addControl(new OpenLayers.Control.OverviewMap({mapOptions:ov_options}));}
addPopupControls(map);};var addPopupControls=function(map){map.events.register('featureover',this,tooltipSelect);map.events.register('featureout',this,tooltipUnselect);map.events.register('featureclick',this,onFeatureSelect);}
var tooltipSelect=function(event){var feature=event.feature;var layer=feature.layer;feature.renderIntent='select';layer.drawFeature(feature);if(['OpenLayers.Handler.PointS3','OpenLayers.Handler.Path','OpenLayers.Handler.Polygon','OpenLayers.Handler.RegularPolygon'].indexOf(layer.name)!=-1){return;}
var map=layer.map;if(map.s3.layers_nopopups.indexOf(layer.name)!=-1){return;}
S3.gis.timeouts[feature.id]=setTimeout(function(){if(feature.cluster){}else{if(!feature.geometry){return;}
var attributes=feature.attributes,centerPoint=feature.geometry.getBounds().getCenterLonLat(),tooltip;if(undefined!=layer.s3_popup_format){_.templateSettings={interpolate:/\{(.+?)\}/g};var s3_popup_format=layer.s3_popup_format;var template=_.template(s3_popup_format);var defaults={},key,keys=s3_popup_format.split('{');for(var j=0;j<keys.length;j++){key=keys[j].split('}')[0];defaults[key]='';}
_.defaults(attributes,defaults);tooltip=template(attributes);}else if(undefined!=attributes.popup){tooltip=attributes.popup;}else if(undefined!=attributes.name){tooltip=attributes.name;}else if(undefined!=layer.title){var a=attributes[layer.title];var type=typeof a;if('object'==type){tooltip=a.value;}else{tooltip=a;}}
if(tooltip){OpenLayers.Popup.Tooltip=OpenLayers.Class(OpenLayers.Popup,{displayClass:'gis_tooltip',contentDisplayClass:'gis_tooltip_content',CLASS_NAME:'OpenLayers.Popup.Tooltip'});var tooltipPopup=new OpenLayers.Popup.Tooltip(feature.id+'_tooltip',centerPoint,new OpenLayers.Size(80,12),tooltip);tooltipPopup.autoSize=true;feature.popup=tooltipPopup;map.addPopup(tooltipPopup);}}},500);};var tooltipUnselect=function(event){var feature=event.feature;var layer=feature.layer;var map=layer.map;if(feature){feature.renderIntent='default';layer.drawFeature(feature);}
if(['OpenLayers.Handler.PointS3','OpenLayers.Handler.Path','OpenLayers.Handler.Polygon','OpenLayers.Handler.RegularPolygon'].indexOf(layer.name)!=-1){return;}
if(map.s3.layers_nopopups.indexOf(layer.name)!=-1){return;}
if(feature){clearTimeout(S3.gis.timeouts[feature.id]);if((feature.popup)&&(feature.popup.CLASS_NAME=='OpenLayers.Popup.Tooltip')){if(feature.popup){map.removePopup(feature.popup);feature.popup.destroy();}
delete feature.popup;}
$('#'+feature.id+'_tooltip').remove();}};var addPopup=function(feature,url,contents,iframe){var id=feature.id+'_popup';if(iframe&&url){if(url.indexOf('http://')===0){url=OpenLayers.ProxyHost+encodeURIComponent(url);}
contents='<iframe src="'+url+'" onload="S3.gis.popupLoaded(\''+id+'\')" class="loading" marginWidth="0" marginHeight="0" frameBorder="0"></iframe>';}else if(undefined==contents){contents=i18n.gis_loading+'...<div class="throbber"></div>';}
var centerPoint=feature.geometry.getBounds().getCenterLonLat();var popup=new OpenLayers.Popup.FramedCloud(id,centerPoint,new OpenLayers.Size(400,400),contents,null,true,onPopupClose);feature.popup=popup;popup.feature=feature;popup.maxSize=new OpenLayers.Size(750,660);var map=feature.layer.map;feature.map=map;map.addPopup(popup);if(!iframe&&undefined!=url){loadDetails(url,id+'_contentDiv',popup);}
return popup;};S3.gis.addPopup=addPopup;S3.gis.popupLoaded=function(id){$('#'+id+'_contentDiv iframe').contents().find('#popup').show();var maps=S3.gis.maps;var map_id,map,popup,popups,i,len;for(map_id in maps){map=maps[map_id];popups=map.popups;for(i=0,len=popups.length;i<len;i++){popup=popups[i];if(popup.id==id){popup.updateSize(true);}}}}
var loadDetails=function(url,id,popup){if(url.indexOf('http://')===0){url=OpenLayers.ProxyHost+encodeURIComponent(url);}
$.ajaxS3({url:url,dataType:'html',success:function(data){try{$('#'+id).html(data);popup.updateSize();$('#'+id+' a.btn.iframe').click(function(){var url=$(this).attr('href');if(url.indexOf('http://')===0){url=OpenLayers.ProxyHost+encodeURIComponent(url);}
var popup_id=id.slice(0,-11);var contents='<iframe src="'+url+'" onload="S3.gis.popupLoaded(\''+popup_id+'\')" class="loading" marginWidth="0" marginHeight="0" frameBorder="0"></iframe>';$('#'+id).html(contents);return false;});}catch(e){}},error:function(jqXHR,textStatus,errorThrown){if(errorThrown=='UNAUTHORIZED'){msg=i18n.gis_requires_login;}else{msg=jqXHR.responseText;}
$('#'+id+'_contentDiv').html(msg);popup.updateSize();}});};var onFeatureSelect=function(event){var feature=event.feature;var layer=feature.layer;var map=layer.map;var s3=map.s3;if((['OpenLayers.Handler.PointS3','OpenLayers.Handler.Path','OpenLayers.Handler.Polygon','OpenLayers.Handler.RegularPolygon'].indexOf(layer.name)!=-1)||(s3.layers_nopopups.indexOf(layer.name)!=-1)){return;}else if(layer.s3_layer_type=='openweathermap'){var html=layer.options.getPopupHtml(feature.attributes.station);var popup=new OpenLayers.Popup('Popup',feature.geometry.getBounds().getCenterLonLat(),new OpenLayers.Size(layer.options.popupX,layer.options.popupY),html,'Station',false);feature.popup=popup;popup.feature=feature;map.addPopup(popup,true);return;}
var geometry=feature.geometry;if(geometry.CLASS_NAME!='OpenLayers.Geometry.Point'){for(var i=0,len=s3.clicking.length;i<len;++i){if(s3.clicking[i].geometry.CLASS_NAME=='OpenLayers.Geometry.Point'){return;}}}
tooltipUnselect(event);feature.renderIntent='select';layer.drawFeature(feature);var layer_type=layer.s3_layer_type;var centerPoint=geometry.getBounds().getCenterLonLat();var popup_id=feature.id+'_popup';if(undefined!=layer.title){var titleField=layer.title;}else{var titleField='name';}
var contents,data_link,name,popup_url;if(feature.cluster){var cluster=feature.cluster;contents=i18n.gis_cluster_multiple+':<ul>';var i,length=cluster.length,map_id=s3.id;for(i=0;i<length;i++){var attributes=cluster[i].attributes;if(undefined!=layer.s3_popup_format){_.templateSettings={interpolate:/\{(.+?)\}/g};var s3_popup_format=layer.s3_popup_format;var template=_.template(s3_popup_format);var defaults={},key,keys=s3_popup_format.split('{');for(var j=0;j<keys.length;j++){key=keys[j].split('}')[0];defaults[key]='';}
_.defaults(attributes,defaults);name=template(attributes).split('<br/>',1)[0];}else if(undefined!=attributes.popup){name=attributes.popup.split('<br/>',1)[0];}else{name=attributes[titleField];}
if(undefined!=attributes.url){contents+="<li><a href='javascript:S3.gis.loadClusterPopup("+"\""+map_id+"\", \""+attributes.url+"\", \""+popup_id+"\""+")'>"+name+"</a></li>";}else if(undefined!=layer.s3_url_format){_.templateSettings={interpolate:/\{(.+?)\}/g};var template=_.template(layer.s3_url_format);if(attributes.id.constructor===Array){attributes.id=attributes.id[0];}
popup_url=template(attributes);contents+="<li><a href='javascript:S3.gis.loadClusterPopup("+"\""+map_id+"\", \""+popup_url+"\", \""+popup_id+"\""+")'>"+name+"</a></li>";}else{contents+='<li>'+name+'</li>';}}
popup_url=null;contents+='</ul>';contents+="<div align='center'><a href='javascript:S3.gis.zoomToSelectedFeature("+"\""+map_id+"\", "+centerPoint.lon+","+centerPoint.lat+", 3)'>"+i18n.gis_zoomin+'</a></div>';}else{if(layer_type=='kml'){var attributes=feature.attributes;if(undefined!=feature.style.balloonStyle){var balloonStyle=feature.style.balloonStyle;contents=balloonStyle.replace(/{([^{}]*)}/g,function(a,b){var r=attributes[b];return typeof r==='string'||typeof r==='number'?r:a;});}else{var type=typeof attributes[titleField];var title;if('object'==type){title=attributes[titleField].value;}else{title=attributes[titleField];}
contents='<h3>'+title+'</h3>';var body=layer.body.split(' ');var label,row,value;for(var j=0;j<body.length;j++){type=typeof attributes[body[j]];if('object'==type){label=attributes[body[j]].displayName;if(label===''){label=body[j];}
value=attributes[body[j]].value;row='<div class="gis_popup_row"><div class="gis_popup_label">'+label+':</div><div class="gis_popup_cell">'+value+'</div></div>';}else if(undefined!=attributes[body[j]]){row='<div class="gis_popup_row">'+attributes[body[j]]+'</div>';}else{row='';}
contents+=row;}}
if(contents.search('<script')!=-1){contents='Content contained Javascript! Escaped content below.<br />'+contents.replace(/</g,'<');}}else if(layer_type=='gpx'){}else if((layer_type=='shapefile')||(layer_type=='geojson')){var attributes=feature.attributes;contents='<div>';var label,prop,row,value;$.each(attributes,function(label,value){if(label=='id_orig'){label='id';}
row='<div class="gis_popup_row"><div class="gis_popup_label">'+label+':</div><div class="gis_popup_cell">'+value+'</div></div>';contents+=row;});contents+='</div>';}else if(layer_type=='wfs'){var attributes=feature.attributes;var title=attributes[titleField];contents='<h3>'+title+'</h3>';var row;$.each(attributes,function(label,value){row='<div class="gis_popup_row"><div class="gis_popup_label">'+label+':</div><div class="gis_popup_val">'+value+'</div></div>';contents+=row;});}else{if(undefined!=feature.attributes.url){popup_url=feature.attributes.url;}else if(undefined!=layer.s3_url_format){_.templateSettings={interpolate:/\{(.+?)\}/g};var template=_.template(layer.s3_url_format);if(feature.attributes.id.constructor===Array){feature.attributes.id=feature.attributes.id[0];}
popup_url=template(feature.attributes);}else{var attributes=feature.attributes;if(undefined==attributes.name){name='';}else{name='<h3>'+attributes.name+'</h3>';}
var description;if(undefined==attributes.description){description='';}else{description='<p>'+attributes.description+'</p>';}
var link;if(undefined==attributes.link){link='';}else{link='<a href="'+attributes.link+'" target="_blank">'+attributes.link+'</a>';}
var data;if(undefined==attributes.data){data='';}else if(attributes.data.indexOf('http://')===0){data_link=true;var data_id=S3.uid();data='<div id="'+data_id+'">'+i18n.gis_loading+"...<div class='throbber'></div>"+'</div>';}else{data='<p>'+attributes.data+'</p>';}
var image;if(undefined==attributes.image){image='';}else if(attributes.image.indexOf('http://')===0){image='<img src="'+attributes.image+'" height=300 width=300>';}else{image='';}
contents=name+description+link+data+image;}}}
var popup=addPopup(feature,popup_url,contents);if(data_link){loadDetails(feature.attributes.data,data_id,popup);}};var onFeatureUnselect=function(event){var feature=event.feature;if(feature){var layer=feature.layer;feature.renderIntent='default';if(layer){layer.drawFeature(feature);}
if(feature.popup){if(layer){layer.map.removePopup(feature.popup);}
feature.popup.destroy();delete feature.popup;}
if(feature.id){$('#'+feature.id+'_popup').remove();}else{var map=feature.map;if(map){var popups=map.popups;var len=popups.length;for(var i=len-1;i>-1;i--){map.removePopup(popups[i]);}}}
if(layer&&layer.name==i18n.gis_draft_layer){feature.destroy();}}};var onPopupClose=function(event){onFeatureUnselect(this);};var loadClusterPopup=function(map_id,url,id){var selector='#'+id+'_contentDiv';var div=$(selector);var contents=i18n.gis_loading+"...<div class='throbber'></div>";div.html(contents);var map=S3.gis.maps[map_id];$.getS3(url,function(data){div.html(data);map.popups[0].updateSize();var dropdowns=$(selector+' .dropdown-toggle');if(dropdowns.length){div.parent().css('overflow','visible').parent().css('overflow','visible');dropdowns.dropdown();}},'html');};S3.gis.loadClusterPopup=loadClusterPopup;var zoomToSelectedFeature=function(map_id,lon,lat,zoomfactor){var map=S3.gis.maps[map_id];var lonlat=new OpenLayers.LonLat(lon,lat);var currZoom=map.getZoom();var newZoom=currZoom+zoomfactor;map.setCenter(lonlat,newZoom);for(var i=0;i<map.popups.length;i++){map.removePopup(map.popups[i]);}};S3.gis.zoomToSelectedFeature=zoomToSelectedFeature;var addToolbar=function(map){var s3=map.s3;var options=s3.options;var toolbar=new Ext.Toolbar({height:34})
toolbar.map=map;s3.portal.toolbar=toolbar;OpenLayers.Control.ZoomToMaxExtentS3=OpenLayers.Class(OpenLayers.Control.Button,{trigger:function(){var restrictedExtent=new OpenLayers.Bounds.fromArray(options.restrictedExtent);restrictedExtent.transform(proj4326,map.getProjectionObject());map.zoomToExtent(restrictedExtent);},CLASS_NAME:"OpenLayers.Control.ZoomToMaxExtentS3"});var zoomfull=new GeoExt.Action({control:new OpenLayers.Control.ZoomToMaxExtentS3(),map:map,iconCls:'zoomfull',tooltip:i18n.gis_zoomfull});var line_pressed,pan_pressed,point_pressed,polygon_pressed,circle_pressed;if(options.draw_polygon=='active'){polygon_pressed=true;line_pressed=false;pan_pressed=false;point_pressed=false;circle_pressed=false;}else if(options.draw_line=='active'){line_pressed=true;point_pressed=false;pan_pressed=false;polygon_pressed=false;circle_pressed=false;}else if(options.draw_feature=='active'){point_pressed=true;line_pressed=false;pan_pressed=false;polygon_pressed=false;circle_pressed=false;}else if(options.draw_circle=='active'){point_pressed=false;line_pressed=false;pan_pressed=false;polygon_pressed=false;circle_pressed=true;}else{pan_pressed=true;line_pressed=false;point_pressed=false;polygon_pressed=false;circle_pressed=false;}
toolbar.add(zoomfull);if(i18n.gis_geoLocate&&navigator.geolocation){addGeolocateControl(toolbar);}
if(undefined===options.nav){var zoomout=new GeoExt.Action({control:new OpenLayers.Control.ZoomBox({out:true}),map:map,iconCls:'zoomout',tooltip:i18n.gis_zoomout,toggleGroup:'controls'});var zoomin=new GeoExt.Action({control:new OpenLayers.Control.ZoomBox(),map:map,iconCls:'zoomin',tooltip:i18n.gis_zoominbutton,toggleGroup:'controls'});var panButton=new GeoExt.Action({control:new OpenLayers.Control.Navigation(),map:map,iconCls:'pan-off',tooltip:i18n.gis_pan,allowDepress:true,toggleGroup:'controls',pressed:pan_pressed});toolbar.add(zoomout);toolbar.add(zoomin);toolbar.add(panButton);toolbar.addSeparator();addNavigationControl(toolbar);}
if(options.print){toolbar.addSeparator();addPrintButton(toolbar);}
if(options.save&&options.save!='float'){toolbar.addSeparator();addSaveButton(toolbar);}
toolbar.addSeparator();addMeasureControls(toolbar);if(options.clear_layers=='toolbar'){addClearLayersButton(map,toolbar);}
if(options.mgrs_url){addPdfControl(toolbar);}
if(options.draw_feature||options.draw_line||options.draw_polygon||options.draw_circle){toolbar.addSeparator();var poi_resources=S3.gis.poi_resources;if(poi_resources){var len=poi_resources.length;}
var i,resource;if(options.draw_feature){if(poi_resources){for(i=0;i<len;i++){resource=poi_resources[i];if(resource['t']=='point'){addPointControl(map,toolbar,point_pressed,resource);}}}else{addPointControl(map,toolbar,point_pressed);}}
if(options.draw_line){if(poi_resources){for(i=0;i<len;i++){resource=poi_resources[i];if(resource['t']=='line'){addLineControl(map,toolbar,line_pressed,resource);}}}else{addLineControl(map,toolbar,line_pressed);}}
if(options.draw_polygon){if(poi_resources){for(i=0;i<len;i++){resource=poi_resources[i];if(resource['t']=='line'){addPolygonControl(map,toolbar,polygon_pressed,true,resource);}}}else{addPolygonControl(map,toolbar,polygon_pressed,true);}}
if(options.draw_circle){if(poi_resources){for(i=0;i<len;i++){resource=poi_resources[i];if(resource['t']=='circle'){addCircleControl(map,toolbar,circle_pressed,resource);}}}else{addCircleControl(map,toolbar,circle_pressed);}}
if(options.color_picker){addColorPickerControl(map,toolbar);}}
if(i18n.gis_get_feature_info){addWMSGetFeatureInfoControl(map);}
if(i18n.gis_potlatch){addPotlatchButton(toolbar);}
if(options.Google&&options.Google.StreetviewButton){addGoogleStreetviewControl(toolbar);}
if(options.geonames){if(false===options.nav){var max_width=options.map_width-500;}else{var max_width=options.map_width-680;}
var width=Math.min(350,max_width);var mapSearch=new GeoExt.ux.GeoNamesSearchCombo({map:map,width:width,listWidth:width,minChars:2,emptyText:i18n.gis_search,username:options.geonames});toolbar.addSeparator();toolbar.add(mapSearch);}
var throbber=new Ext.BoxComponent({cls:'layer_throbber hide'});toolbar.add(throbber);return toolbar;};var addGeolocateControl=function(toolbar){var map=toolbar.map;var draftLayer=map.s3.draftLayer;var style={fillColor:'#000',fillOpacity:0.1,strokeWidth:0};var geolocateControl=new OpenLayers.Control.Geolocate({geolocationOptions:{enableHighAccuracy:false,maximumAge:0,timeout:7000}});map.addControl(geolocateControl);geolocateControl.events.register('locationupdated',this,function(e){draftLayer.removeAllFeatures();var circle=new OpenLayers.Feature.Vector(OpenLayers.Geometry.Polygon.createRegularPolygon(new OpenLayers.Geometry.Point(e.point.x,e.point.y),e.position.coords.accuracy/2,40,0),{},style);draftLayer.addFeatures([new OpenLayers.Feature.Vector(e.point,{},{graphicName:'cross',strokeColor:'#f00',strokeWidth:2,fillOpacity:0,pointRadius:10}),circle]);map.zoomToExtent(draftLayer.getDataExtent());pulsate(map,circle);});geolocateControl.events.register('locationfailed',this,function(){OpenLayers.Console.log('Location detection failed');});var geoLocateButton=new Ext.Button({iconCls:'geolocation',tooltip:i18n.gis_geoLocate,handler:function(){draftLayer.removeAllFeatures();geolocateControl.activate();}});toolbar.addButton(geoLocateButton);};var pulsate=function(map,feature){var point=feature.geometry.getCentroid(),bounds=feature.geometry.getBounds(),radius=Math.abs((bounds.right-bounds.left)/2),count=0,grow='up';var resize=function(){if(count>16){clearInterval(window.resizeInterval);}
var interval=radius*0.03;var ratio=interval/radius;switch(count){case 4:case 12:grow='down';break;case 8:grow='up';break;}
if(grow!=='up'){ratio=-Math.abs(ratio);}
feature.geometry.resize(1+ratio,point);map.s3.draftLayer.drawFeature(feature);count++;};window.resizeInterval=window.setInterval(resize,50,point,radius);};var addGoogleStreetviewControl=function(toolbar){var map=toolbar.map;var Clicker=OpenLayers.Class(OpenLayers.Control,{defaults:{pixelTolerance:1,stopSingle:true},initialize:function(options){this.handlerOptions=OpenLayers.Util.extend({},this.defaults);OpenLayers.Control.prototype.initialize.apply(this,arguments);this.handler=new OpenLayers.Handler.Click(this,{click:this.trigger},this.handlerOptions);},trigger:function(event){openStreetviewPopup(map,map.getLonLatFromViewPortPx(event.xy));}});StreetviewClicker=new Clicker({autoactivate:false});map.addControl(StreetviewClicker);var googleStreetviewButton=new Ext.Button({iconCls:'streetview',tooltip:map.s3.options.Google.StreetviewButton,allowDepress:true,enableToggle:true,toggleGroup:'controls',toggleHandler:function(button,state){if(state===true){StreetviewClicker.activate();}else{StreetviewClicker.deactivate();}}});toolbar.addSeparator();toolbar.addButton(googleStreetviewButton);};var openStreetviewPopup=function(map,location){if(!location){location=map.getCenter();}
if(map.s3.sv_popup&&map.s3.sv_popup.anc){map.s3.sv_popup.close();}
map.s3.sv_popup=new GeoExt.Popup({title:map.s3.options.Google.StreetviewTitle,location:location,width:300,height:300,collapsible:true,map:map.s3.mapPanel,items:[new gxp.GoogleStreetViewPanel()]});map.s3.sv_popup.show();};var addMeasureControls=function(toolbar){var map=toolbar.map;var measureSymbolizers={'Point':{pointRadius:5,graphicName:'circle',fillColor:'white',fillOpacity:1,strokeWidth:1,strokeOpacity:1,strokeColor:'#f5902e'},'Line':{strokeWidth:3,strokeOpacity:1,strokeColor:'#f5902e',strokeDashstyle:'dash'},'Polygon':{strokeWidth:2,strokeOpacity:1,strokeColor:'#f5902e',fillColor:'white',fillOpacity:0.5}};var styleMeasure=new OpenLayers.Style();styleMeasure.addRules([new OpenLayers.Rule({symbolizer:measureSymbolizers})]);var styleMapMeasure=new OpenLayers.StyleMap({'default':styleMeasure});var length=new OpenLayers.Control.Measure(OpenLayers.Handler.Path,{geodesic:true,persist:true,handlerOptions:{layerOptions:{styleMap:styleMapMeasure}}});length.events.on({'measure':function(evt){alert(i18n.gis_length_message+' '+evt.measure.toFixed(2)+' '+evt.units);}});var lengthButton=new GeoExt.Action({control:length,map:map,iconCls:'measure-off',tooltip:i18n.gis_length_tooltip,allowDepress:true,enableToggle:true,toggleGroup:'controls'});toolbar.add(lengthButton);if(false===map.s3.options.area){var area=new OpenLayers.Control.Measure(OpenLayers.Handler.Polygon,{geodesic:true,persist:true,handlerOptions:{layerOptions:{styleMap:styleMapMeasure}}});area.events.on({'measure':function(evt){alert(i18n.gis_area_message+' '+evt.measure.toFixed(2)+' '+evt.units+'2');}});var areaButton=new GeoExt.Action({control:area,map:map,iconCls:'measure-area',tooltip:i18n.gis_area_tooltip,allowDepress:true,enableToggle:true,toggleGroup:'controls'});toolbar.add(areaButton);}};var addLegendPanel=function(map){var map_id=map.s3.id;var div='<div class="map_legend_div"><div class="map_legend_tab right"></div><div class="map_legend_panel"></div></div>';$('#'+map_id).append(div);var legendPanel=new GeoExt.LegendPanel({title:i18n.gis_legend,autoScroll:true,border:false});var jquery_obj=$('#'+map_id+' .map_legend_panel');var el=Ext.get(jquery_obj[0]);legendPanel.render(el);$('#'+map_id+' .map_legend_tab').click(function(){if($(this).hasClass('right')){hideLegend(map);}else{showLegend(map);}});return legendPanel;};var hideLegend=function(map){var map_id=map.s3.id;var outerWidth=$('#'+map_id+' .map_legend_panel').outerWidth();$('#'+map_id+' .map_legend_div').animate({marginRight:'-'+outerWidth+'px'});$('#'+map_id+' .map_legend_tab').removeClass('right').addClass('left');};var showLegend=function(map){var map_id=map.s3.id;$('#'+map_id+' .map_legend_div').animate({marginRight:0});$('#'+map_id+' .map_legend_tab').removeClass('left').addClass('right');};var addNavigationControl=function(toolbar){var nav=new OpenLayers.Control.NavigationHistory();toolbar.map.addControl(nav);nav.activate();var navPreviousButton=new Ext.Button({iconCls:'back',tooltip:i18n.gis_navPrevious,handler:nav.previous.trigger});var navNextButton=new Ext.Button({iconCls:'next',tooltip:i18n.gis_navNext,handler:nav.next.trigger});toolbar.addButton(navPreviousButton);toolbar.addButton(navNextButton);};var addPointControl=function(map,toolbar,active,config){OpenLayers.Handler.PointS3=OpenLayers.Class(OpenLayers.Handler.Point,{dblclick:function(evt){return true;},CLASS_NAME:'OpenLayers.Handler.PointS3'});var draftLayer=map.s3.draftLayer;var control=new OpenLayers.Control.DrawFeature(draftLayer,OpenLayers.Handler.PointS3,{'featureAdded':function(feature){if(map.s3.lastDraftFeature){map.s3.lastDraftFeature.destroy();}else if(draftLayer.features.length>1){draftLayer.features[0].destroy();}
while(map.popups.length>0){map.removePopup(map.popups[0]);}
if(undefined!=map.s3.pointPlaced){map.s3.pointPlaced(feature,config);}
map.s3.lastDraftFeature=feature;}});if(toolbar){if(config&&config.l){var tooltip=config.l;}else{var tooltip=i18n.gis_draw_feature;}
var map_id=map.s3.id;var pointButton=new GeoExt.Action({control:control,handler:function(){if(pointButton.items[0].pressed){$('#'+map_id+'_panel .olMapViewport').addClass('crosshair');var colorpicker=$('#'+map_id+'_panel .gis_colorpicker');if(colorpicker.length){colorpicker.spectrum('disable');}}else{$('#'+map_id+'_panel .olMapViewport').removeClass('crosshair');}},map:map,iconCls:'drawpoint-off',tooltip:tooltip,allowDepress:true,enableToggle:true,toggleGroup:'controls',pressed:active});toolbar.add(pointButton);if(active){$('#'+map_id+'_panel .olMapViewport').addClass('crosshair');var colorpicker=$('#'+map_id+'_panel .gis_colorpicker');if(colorpicker.length){colorpicker.spectrum('disable');}}
map.s3.pointButton=pointButton;}else{map.addControl(control);if(active){control.activate();$('#'+map.s3.id+'_panel .olMapViewport').addClass('crosshair');}}};var addLineControl=function(map,toolbar,active,config){var draftLayer=map.s3.draftLayer;var control=new OpenLayers.Control.DrawFeature(draftLayer,OpenLayers.Handler.Path,{'featureAdded':function(feature){if(map.s3.lastDraftFeature){map.s3.lastDraftFeature.destroy();}else if(draftLayer.features.length>1){draftLayer.features[0].destroy();}
while(map.popups.length>0){map.removePopup(map.popups[0]);}
if(undefined!=map.s3.pointPlaced){map.s3.pointPlaced(feature,config);}
map.s3.lastDraftFeature=feature;}});if(toolbar){if(config&&config.l){var tooltip=config.l;}else{var tooltip=i18n.gis_draw_line;}
var map_id=map.s3.id;var lineButton=new GeoExt.Action({control:control,handler:function(){if(lineButton.items[0].pressed){$('#'+map_id+'_panel .olMapViewport').addClass('crosshair');var colorpicker=$('#'+map_id+'_panel .gis_colorpicker');if(colorpicker.length){colorpicker.spectrum('enable');}}else{$('#'+map_id+'_panel .olMapViewport').removeClass('crosshair');var colorpicker=$('#'+map_id+'_panel .gis_colorpicker');if(colorpicker.length){colorpicker.spectrum('disable');}}},map:map,iconCls:'drawline-off',tooltip:tooltip,allowDepress:true,enableToggle:true,toggleGroup:'controls',pressed:active,activateOnEnable:true,deactivateOnDisable:true});toolbar.add(lineButton);map.s3.lineButton=lineButton;}else{map.addControl(control);if(active){control.activate();$('#'+map.s3.id+'_panel .olMapViewport').addClass('crosshair');}}};var addPolygonControl=function(map,toolbar,active,not_regular,config){var s3=map.s3,draftLayer=s3.draftLayer;var control=new OpenLayers.Control.DrawFeature(draftLayer,not_regular?OpenLayers.Handler.Polygon:OpenLayers.Handler.RegularPolygon,{handlerOptions:not_regular?{sides:4,snapAngle:90}:{},'featureAdded':function(feature){if(s3.lastDraftFeature){s3.lastDraftFeature.destroy();}else if(draftLayer.features.length>1){draftLayer.features[0].destroy();}
var wkt_field=$('#gis_location_wkt');if(wkt_field.length){var WKT=feature.geometry.transform(map.getProjectionObject(),proj4326).toString();wkt_field.val(WKT);$('#gis_location_lat').val('');$('#gis_location_lon').val('');}
while(map.popups.length>0){map.removePopup(map.popups[0]);}
if(undefined!=s3.pointPlaced){s3.pointPlaced(feature,config);}
s3.lastDraftFeature=feature;}});var map_id=s3.id;if(toolbar){if(config&&config.l){var tooltip=config.l;}else{var tooltip=i18n.gis_draw_polygon;}
var polygonButton=new GeoExt.Action({control:control,handler:function(){var btn=polygonButton.items[0];if(btn.pressed){polygonButton.setIconClass('drawpolygonclear-off');btn.tooltip=i18n.gis_draw_polygon_clear;btn.setTooltip(i18n.gis_draw_polygon_clear);$('#'+map_id+'_panel .olMapViewport').addClass('crosshair');var colorpicker=$('#'+map_id+'_panel .gis_colorpicker');if(colorpicker.length){colorpicker.spectrum('enable');}}else{polygonButton.setIconClass('drawpolygon-off');btn.tooltip=tooltip;btn.setTooltip(tooltip);$('#'+map_id+'_panel .olMapViewport').removeClass('crosshair');var colorpicker=$('#'+map_id+'_panel .gis_colorpicker');if(colorpicker.length){colorpicker.spectrum('disable');}
if(s3.lastDraftFeature){s3.lastDraftFeature.destroy();}else if(draftLayer.features.length>1){draftLayer.features[0].destroy();}
if(undefined!=s3.polygonButtonOff){s3.polygonButtonOff();}}},map:map,iconCls:'drawpolygon-off',tooltip:tooltip,allowDepress:true,enableToggle:true,toggleGroup:'controls',pressed:active,activateOnEnable:true,deactivateOnDisable:true});toolbar.add(polygonButton);s3.polygonButton=polygonButton;}else{map.addControl(control);if(active){control.activate();$('#'+map_id+'_panel .olMapViewport').addClass('crosshair');addPolygonPanel(map_id,control);}}};var addPolygonPanel=function(map_id,control){if(undefined===control){var i,len,controls=S3.gis.maps[map_id].controls;for(i=0,len=controls.length;i<len;i++){control=controls[i];if(control.CLASS_NAME=='OpenLayers.Control.DrawFeature'){break;}}}
var msg='Click anywhere on the map to begin drawing. Double click to complete the area or click the Finish button below.';var div='<div class="map_polygon_panel">'+msg+'<div class="map_polygon_buttons"><a class="button small map_polygon_finish">'+'Finish'+'</a><a class="button small map_polygon_clear">'+'Clear'+'</a></div></div>';$('#'+map_id).append(div);var s3=S3.gis.maps[map_id].s3;$('#'+map_id+' .map_polygon_finish').click(function(){control.finishSketch();if(undefined!=s3.polygonPanelFinish){s3.polygonPanelFinish();}else{if(s3.lastDraftFeature){s3.lastDraftFeature.destroy();}else if(s3.draftLayer.features.length>1){s3.draftLayer.features[0].destroy();}
control.deactivate();$('#'+map_id+'_panel .olMapViewport').removeClass('crosshair');}});$('#'+map_id+' .map_polygon_clear').click(function(){if(s3.lastDraftFeature){s3.lastDraftFeature.destroy();}else if(s3.draftLayer.features.length>1){s3.draftLayer.features[0].destroy();}
control.deactivate();$('#'+map_id+'_panel .olMapViewport').removeClass('crosshair');if(undefined!=s3.polygonPanelClear){s3.polygonPanelClear();}});return control;};S3.gis.addPolygonPanel=addPolygonPanel;var addCircleControl=function(map,toolbar,active,config){var draftLayer=map.s3.draftLayer;var control=new OpenLayers.Control.DrawFeature(draftLayer,OpenLayers.Handler.RegularPolygon,{handlerOptions:{sides:1000},'featureAdded':function(feature){if(map.s3.lastDraftFeature){map.s3.lastDraftFeature.destroy();}else if(draftLayer.features.length>1){draftLayer.features[0].destroy();}
while(map.popups.length>0){map.removePopup(map.popups[0]);}
if(undefined!=map.s3.pointPlaced){map.s3.pointPlaced(feature,config);}
map.s3.lastDraftFeature=feature;}});if(toolbar){if(config&&config.l){var tooltip=config.l;}else{var tooltip=i18n.gis_draw_circle;}
var map_id=map.s3.id;var circleButton=new GeoExt.Action({control:control,handler:function(){if(circleButton.items[0].pressed){$('#'+map_id+'_panel .olMapViewport').addClass('crosshair');var colorpicker=$('#'+map_id+'_panel .gis_colorpicker');if(colorpicker.length){colorpicker.spectrum('enable');}}else{$('#'+map_id+'_panel .olMapViewport').removeClass('crosshair');var colorpicker=$('#'+map_id+'_panel .gis_colorpicker');if(colorpicker.length){colorpicker.spectrum('disable');}}},map:map,iconCls:'drawcircle-on',tooltip:tooltip,allowDepress:true,enableToggle:true,toggleGroup:'controls',pressed:active,activateOnEnable:true,deactivateOnDisable:true});toolbar.add(circleButton);map.s3.circleButton=circleButton;}else{map.addControl(control);if(active){control.activate();$('#'+map.s3.id+'_panel .olMapViewport').addClass('crosshair');}}};var uiLoaded=function(map_id){var dfd=new jQuery.Deferred();var s3=S3.gis.maps[map_id].s3;setTimeout(function working(){if(s3.mapWin!=undefined){dfd.resolve('loaded');}else if(dfd.state()==='pending'){dfd.notify('waiting for JS to load...');setTimeout(working,500);}else{}},1);return dfd.promise();};var hex2rgb=function(hex){var bigint=parseInt(hex,16);var r=(bigint>>16)&255;var g=(bigint>>8)&255;var b=bigint&255;return[r,g,b].join();}
var rgb2hex=function(r,g,b){return Number(0x1000000+Math.round(r)*0x10000+Math.round(g)*0x100+Math.round(b)).toString(16).substring(1);}
var addColorPickerControl=function(map,toolbar){var s3=map.s3;var map_id=s3.id;var draft_style=s3.options.draft_style;if(draft_style){if(draft_style.fillOpacity){var value='rgba('+hex2rgb(draft_style.fill)+','+draft_style.fillOpacity+')';}else{var value='rgb('+hex2rgb(draft_style.fill)+')';}}else{var value='';}
var colorPickerButton=new Ext.Toolbar.Item({html:'<input class="gis_colorpicker" name="colour" value="'+value+'"/>'});toolbar.add(colorPickerButton);$.when(uiLoaded(map_id)).then(function(status){$('#'+map_id+'_panel .gis_colorpicker').spectrum({showInput:true,showInitial:true,preferredFormat:'rgb',showPaletteOnly:true,togglePaletteOnly:true,palette:['rgba(255, 0, 0, .5)','rgba(255, 165, 0, .5)','rgba(255, 255, 0, .5)','rgba(0, 255, 0, .5)','rgba(0, 0, 255, .5)','rgba(255, 255, 255, .5)','rgba(0, 0, 0, .5)'],showAlpha:true,cancelText:i18n.gis_cancelText,chooseText:i18n.gis_chooseText,togglePaletteMoreText:i18n.gis_togglePaletteMoreText,togglePaletteLessText:i18n.gis_togglePaletteLessText,clearText:i18n.gis_clearText,noColorSelectedText:i18n.gis_noColorSelectedText,change:function(colour){var style={fill:rgb2hex(colour._r,colour._g,colour._b)};if(colour._a!=1){style.fillOpacity=colour._a;}
var layer={'style':style,'opacity':0.9};var response=createStyleMap(map,layer);var featureStyleMap=response[0];var draftLayer=s3.draftLayer;draftLayer.styleMap=featureStyleMap;draftLayer.redraw();}});},function(status){s3_debug(status);},function(status){s3_debug(status);});};var addPotlatchButton=function(toolbar){var map=toolbar.map;var potlatchButton=new Ext.Button({iconCls:'potlatch',tooltip:i18n.gis_potlatch,handler:function(){var zoom_current=map.getZoom();if(zoom_current<14){alert(i18n.gis_osm_zoom_closer);}else{var lonlat=map.getCenter();lonlat.transform(map.getProjectionObject(),proj4326);var url=S3.Ap.concat('/gis/potlatch2/potlatch2.html')+'?lat='+lonlat.lat+'&lon='+lonlat.lon+'&zoom='+zoom_current;window.open(url);}}});toolbar.addSeparator();toolbar.addButton(potlatchButton);};var addPrintButton=function(toolbar){var map=toolbar.map;var map_id=map.s3.id;var printButton=new Ext.Button({iconCls:'print',tooltip:i18n.gis_print_tip,menu:{xtype:'menu',plain:true,items:[{xtype:'form',bodyPadding:5,items:[{xtype:'combo',allowBlank:false,displayField:'label',fieldLabel:i18n.gis_paper_size,getListParent:function(){return this.el.up('.x-menu');},hiddenName:'size',id:map_id+'_paper_size',lazyInit:false,mode:'local',selectOnFocus:true,store:new Ext.data.ArrayStore({id:0,fields:['size','label'],data:[['Letter','Letter (2550 x 3300)'],['A4','A4 (2480 x 3508)'],['A3','A3 (3508 x 4962)'],['A2','A2 (4962 x 7017)'],['A1','A1 (7017 x 9933)'],['A0','A0 (9933 x 14061)']]}),triggerAction:'all',typeAhead:true,value:'Letter',valueField:'size'},{xtype:'button',text:i18n.gis_print,handler:function(){var size=$('#x-form-el-'+map_id+'_paper_size input[name="size"]').val();if(size=='Letter'){var height=2550;var width=3300;}else if(size=='A4'){var height=2480;var width=3508;}else if(size=='A3'){var height=3508;var width=4962;}else if(size=='A2'){var height=4962;var width=7017;}else if(size=='A1'){var height=7017;var width=9933;}else if(size=='A0'){var height=9933;var width=14061;}
var extent=map.getExtent();var viewSize=new OpenLayers.Size(width,height);var idealResolution=Math.max(extent.getWidth()/viewSize.w,extent.getHeight()/viewSize.h);var zoom=map.baseLayer.getZoomForResolution(idealResolution);var config_id=saveConfig(map,true,zoom);var url=S3.Ap.concat('/gis/screenshot/'+config_id+'?size='+size);window.open(url);}}]}]}});toolbar.addButton(printButton);};var addSaveButton=function(toolbar){var saveButton=new Ext.Button({iconCls:'save',tooltip:i18n.gis_save,handler:function(){saveConfig(toolbar.map);}});toolbar.addButton(saveButton);};var addSavePanel=function(map){var s3=map.s3;var map_id=s3.id;if($('#'+map_id+' .map_save_panel').length){return;}
var name_display='<div class="fleft"><div class="map_save_name">';var config_name=s3.options.config_name;if(config_name){name_display+=config_name;}
name_display+='</div></div>';var div='<div class="map_save_panel off">'+name_display+'<div class="btn map_save_button"><div class="map_save_label">'+i18n.gis_save_map+'</div></div></div>';$('#'+map_id).append(div);if(config_name){$('#'+map_id+' .map_save_panel').removeClass('off');}
$('#'+map_id+' .map_save_button').click(function(){saveClickHandler(map);});};var saveClickHandler=function(map){var map_id=map.s3.id;$('#'+map_id+' .map_save_panel').removeClass('off');$('#'+map_id+' .map_save_panel .saved').remove();$('#'+map_id+' .map_save_panel .fleft').show();$('#'+map_id+' .map_save_label').html(i18n.save);nameConfig(map);};var nameConfig=function(map){var s3=map.s3;var map_id=s3.id;var options=s3.options;var config_id=options.config_id;if(options.config_name){var name=options.config_name;}else{var name='';}
var save_button=$('#'+map_id+' .map_save_button');var input_id=map_id+'_save';var name_input=$('#'+input_id);if(!name_input.length){var name_input='<input id="'+input_id+'" value="'+name+'">';var hint='<label for="'+input_id+'">'+i18n.gis_name_map+'</label>';name_input='<div class="hint">'+hint+name_input+'</div>';if(config_id){var disabled=''}else{var disabled=' disabled="disabled" checked="checked"'}
var checkbox='<div class="new_map"><input type="checkbox" class="checkbox"'+disabled+'>'+i18n.gis_new_map+'</div>';$('#'+map_id+' .map_save_panel .fleft').html(name_input+checkbox);$('#'+map_id+' .map_save_panel label').labelOver('over');}
save_button.unbind('click').click(function(){saveConfig(map);var name=$('#'+map_id+'_save').val();$('#'+map_id+' .map_save_name').html(name);options.config_name=name;if(options.pe_id){var pe_url='?~.pe_id__belongs='+options.pe_id;}else{var pe_url='';}
var div='<div class="saved"><p><i>'+i18n.saved+'</i></p><p><a href="'+S3.Ap.concat('/gis/config')+pe_url+'">'+i18n.gis_my_maps+'</a></p></div>';$('#'+map_id+' .map_save_panel .fleft').hide().before(div);$('#'+map_id+' .map_save_panel .checkbox').prop('checked',false).prop('disabled',false);save_button.unbind('click').click(function(){saveClickHandler(map);});});var savePanel=$('#'+map_id+' .map_save_panel');$('html').unbind('click.cancelSave').bind('click.cancelSave',function(){savePanel.addClass('off');save_button.unbind('click').click(function(){savePanel.removeClass('off').unbind('click');nameConfig(map);});});savePanel.click(function(event){event.stopPropagation();});};var saveConfig=function(map,temp,zoom){var s3=map.s3;var map_id=s3.id;showThrobber(map_id);var state=getState(map);var encode=JSON.stringify;var layersStr=encode(state.layers);var pluginsStr=encode(state.plugins);var json_data={lat:state.lat,lon:state.lon,zoom:zoom||state.zoom,layers:layersStr,plugins:pluginsStr};var options=s3.options;if(options.pe_id){json_data['pe_id']=options.pe_id;}
if(temp){var config_id;var update=false;json_data['temp']=1;}else{var name_input=$('#'+map_id+'_save');var config_id=options.config_id;if(name_input.length){json_data['hide']=1;json_data['name']=name_input.val();if(config_id){var update=!$('#'+map_id+' .map_save_panel input[type="checkbox"]').prop('checked');}else{var update=false;}}else if(config_id){var update=true;}else{var update=false;}}
var url;if(update){url=S3.Ap.concat('/gis/config/'+config_id+'.url/update');}else{url=S3.Ap.concat('/gis/config.url/create');}
$.ajaxS3({async:false,url:url,type:'POST',data:json_data,dataType:'json',success:function(data,status){config_id=data.id;if(!temp&&config_id){options.config_id=config_id;if(history.pushState){if(document.location.search){var pairs=document.location.search.split('?')[1].split('&');var pair=[];for(var i=0;i<pairs.length;i++){pair=pairs[i].split('=');if((decodeURIComponent(pair[0])=='config')&&decodeURIComponent(pair[1])!=config_id){pairs[i]='config='+config_id;var url=document.location.pathname+'?'+pairs.join('&');window.history.pushState({},document.title,url);break;}}}else if((document.location.pathname==S3.Ap.concat('/gis/index'))||(document.location.pathname==S3.Ap.concat('/gis/map_viewing_client'))){var url=document.location.pathname+'?config='+config_id;window.history.pushState({},document.title,url);}}
var url=S3.Ap.concat('/gis/config/',config_id,'/layer_entity');$('#gis_menu_config').attr('href',url);}
hideThrobber(null,map);}});return config_id;};var getState=function(map){var state={};var lonlat=map.getCenter();lonlat.transform(map.getProjectionObject(),proj4326);state.lon=lonlat.lon;state.lat=lonlat.lat;state.zoom=map.getZoom();var layers=[];var id,layer_config;var base_id=map.baseLayer.s3_layer_id;Ext.iterate(map.layers,function(key,val,obj){id=key.s3_layer_id;layer_config={id:id};if(key.visibility){layer_config['visible']=key.visibility;}
if(id==base_id){layer_config['base']=true;}
if(key.s3_style){layer_config['style']=key.s3_style;}
if(key.dir){layer_config['dir']=key.dir;}
layers.push(layer_config);});state.layers=layers;var plugins=[];Ext.iterate(map.s3.plugins,function(key,val,obj){if(key.getState){plugins.push(key.getState());}});state.plugins=plugins;return state;};var addThrobber=function(map){var s3=map.s3;var map_id=s3.id;if($('#'+map_id+' .layer_throbber').length){return;}
var div='<div class="layer_throbber float hide';if(s3.options.save){div+=' save';}
div+='"></div>';$('#'+map_id).append(div);};var addPdfControl=function(toolbar){var map=toolbar.map;var options=map.s3.options;selectPdfControl=new OpenLayers.Control();OpenLayers.Util.extend(selectPdfControl,{draw:function(){this.box=new OpenLayers.Handler.Box(this,{'done':this.getPdf});this.box.activate();},response:function(req){this.w.destroy();var gml=new OpenLayers.Format.GML();var features=gml.read(req.responseText);var html=features.length+' pdfs. <br /><ul>';if(features.length){for(var i=0;i<features.length;i++){var f=features[i];var text=f.attributes.utm_zone+f.attributes.grid_zone+f.attributes.grid_square+f.attributes.easting+f.attributes.northing;html+="<li><a href='"+features[i].attributes.url+"'>"+text+'</a></li>';}}
html+='</ul>';this.w=new Ext.Window({'html':html,width:300,'title':'Results',height:200});this.w.show();},getPdf:function(bounds){var current_projection=map.getProjectionObject()
var ll=map.getLonLatFromPixel(new OpenLayers.Pixel(bounds.left,bounds.bottom)).transform(current_projection,proj4326);var ur=map.getLonLatFromPixel(new OpenLayers.Pixel(bounds.right,bounds.top)).transform(current_projection,proj4326);var boundsgeog=new OpenLayers.Bounds(ll.lon,ll.lat,ur.lon,ur.lat);bbox=boundsgeog.toBBOX();OpenLayers.Request.GET({url:options.mgrs_url+'&bbox='+bbox,callback:OpenLayers.Function.bind(this.response,this)});this.w=new Ext.Window({'html':'Searching '+options.mgrs_name+', please wait.',width:200,'title':'Please Wait.'});this.w.show();}});var tooltip='Select '+options.mgrs_name;var mgrsButton=new GeoExt.Action({text:tooltip,control:selectPdfControl,map:map,allowDepress:false,toggleGroup:'controls',tooltip:tooltip});toolbar.addSeparator();toolbar.add(mgrsButton);};var addWMSGetFeatureInfoControl=function(map){var wmsGetFeatureInfo=new gxp.plugins.WMSGetFeatureInfo({actionTarget:'toolbar',outputTarget:'map',outputConfig:{width:400,height:200},toggleGroup:'controls',infoActionTip:i18n.gis_get_feature_info,popupTitle:i18n.gis_feature_info});wmsGetFeatureInfo.target=map.s3;wmsGetFeatureInfo.addActions();};var addRemoveLayersControl=function(map,layerTree){var addLayersControl=new gxp.plugins.AddLayers({actionTarget:'treepanel.tbar',addActionTip:'Add layers',addActionMenuText:'Add layers',addServerText:'Add a New Server',doneText:'Done',upload:{url:null},uploadText:i18n.gis_uploadlayer,relativeUploadOnly:false});var store=new GeoExt.data.LayerStore();addLayersControl.target=layerTree;layerTree.proxy=OpenLayers.ProxyHost;layerTree.layerSources={};layerTree.layerSources['local']=new gxp.plugins.LayerSource({title:'local',store:store});var actions=addLayersControl.addActions();actions[0].enable();var removeLayerControl=new gxp.plugins.RemoveLayer({actionTarget:'treepanel.tbar',removeActionTip:'Remove layer'});removeLayerControl.target=layerTree;layerTree.mapPanel=map.s3.mapPanel;removeLayerControl.addActions();};var addLayerPropertiesButton=function(map,layerTree){var propertiesWindow=map.s3.propertiesWindow;var layerPropertiesButton=new Ext.Button({iconCls:'gxp-icon-layerproperties',tooltip:i18n.gis_properties,handler:function(){function isSelected(node){var selected=node.isSelected();if(selected){if(!node.leaf){return false;}else{return true;}}else{return false;}}
var node=layerTree.root.findChildBy(isSelected,null,true);if(node){var layer_type=node.layer.s3_layer_type;var url=S3.Ap.concat('/gis/layer_'+layer_type+'.plain?layer_'+layer_type+'.layer_id='+node.layer.s3_layer_id+'&update=1');Ext.Ajax.request({url:url,method:'GET',success:function(response,opts){if(propertiesWindow){propertiesWindow.close();}
var tabPanel;if(layer_type=='feature'){tabPanel=new Ext.TabPanel({activeTab:0,items:[{title:'Layer Properties',html:response.responseText},{title:'Filter',id:'s3_gis_layer_filter_tab',html:''}]});tabPanel.items.items[1].on('activate',function(){var search_url;Ext.iterate(map.s3.layers_feature,function(key,val,obj){if(key.id==node.layer.s3_layer_id){search_url=key.url.replace(/.geojson.+/,'/search.plain');}});Ext.get('s3_gis_layer_filter_tab').load({url:search_url,discardUrl:false,callback:function(){S3.redraw();},text:'Loading...',timeout:30,scripts:false});});}else{tabPanel=new Ext.Panel({title:'Layer Properties',html:response.responseText});}
propertiesWindow=new Ext.Window({width:400,layout:'fit',items:[tabPanel]});propertiesWindow.show();$('#plain form').submit(function(){var id=$('#plain input[name="id"]').val();var update_url=S3.Ap.concat('/gis/layer_'+layer_type+'/'+id+'.plain/update');var fields=$('#plain input');var ids=[];Ext.iterate(fields,function(key,val,obj){if(val.id&&(val.id.indexOf('gis_layer_')!=-1)){ids.push(val.id);}});var pcs=[];for(i=0;i<ids.length;i++){q=$('#'+ids[i]).serialize();if(q){pcs.push(q);}}
q=$('#plain input[name="id"]').serialize();if(q){pcs.push(q);}
q=$('#plain input[name="_formkey"]').serialize();if(q){pcs.push(q);}
q=$('#plain input[name="_formname"]').serialize();if(q){pcs.push(q);}
if(pcs.length>0){var query=pcs.join("&");$.ajaxS3({type:'POST',url:update_url,data:query,success:function(msg){$('#plain').html(msg);}});}
return false;});S3.addTooltips();S3.autocomplete.normal('role','admin','group','gis_layer_'+layer_type+'_role_required');}});}}});var toolbar=layerTree.getTopToolbar();toolbar.add(layerPropertiesButton);};var addClearLayersButton=function(map,toolbar){var clearLayersButton=new Ext.Button({iconCls:'icon-clearlayers',tooltip:i18n.gis_clearlayers,handler:function(){layers=map.layers;for(i=0,len=layers.length;i<len;i++){layer=layers[i];if(!layer.isBaseLayer){layer.setVisibility(false);}}}});toolbar.add(clearLayersButton);};var createStyleMap=function(map,layer){if(undefined!=layer.marker){var marker=layer.marker;var marker_url=marker_url_path+marker.i;var marker_height=marker.h;var marker_width=marker.w;}else{var marker_url='';}
var opacity=layer.opacity||1;var style=layer.style;if(Object.prototype.toString.call(style)==='[object Array]'){var style_array=true;}else{var style_array=false;}
var options=map.s3.options;var scaleImage=function(){var image=this;var max_h=options.max_h||35;var max_w=options.max_w||30;var scaleRatio=image.height/image.width;var w=Math.min(image.width,max_w);var h=w*scaleRatio;if(h>max_h){h=max_h;scaleRatio=w/h;w=w*scaleRatio;}
image.height=h;image.width=w;};var styleArray={label:'${label}',labelAlign:'cm',pointRadius:'${radius}',fillColor:'${fill}',fillOpacity:'${fillOpacity}',strokeColor:'${stroke}',strokeDashstyle:'${strokeDashstyle}',strokeWidth:'${strokeWidth}',strokeOpacity:'${strokeOpacity}',graphicHeight:'${graphicHeight}',graphicWidth:'${graphicWidth}',graphicName:'${graphicName}',graphicOpacity:opacity,graphicXOffset:'${graphicXOffset}',graphicYOffset:'${graphicYOffset}',graphicZIndex:'${graphicZIndex}',externalGraphic:'${externalGraphic}',zIndex:'${zIndex}'};var styleOptions={context:{graphicWidth:function(feature){var pix=1;if(feature.cluster){}else if(feature.attributes.marker_width){pix=feature.attributes.marker_width;}else if(style&&!style_array&&undefined==style.externalGraphic&&undefined==marker_width&&feature.geometry.CLASS_NAME=='OpenLayers.Geometry.Point'){pix=options.marker_default.w;}else if(undefined!=marker_width){pix=marker_width;}
return pix;},graphicHeight:function(feature){var pix=1;if(feature.cluster){}else if(feature.attributes.marker_height){pix=feature.attributes.marker_height;}else if(style&&!style_array&&undefined==style.externalGraphic&&undefined==marker_height&&feature.geometry.CLASS_NAME=='OpenLayers.Geometry.Point'){pix=options.marker_default.h;}else if(undefined!=marker_height){pix=marker_height;}
return pix;},graphicXOffset:function(feature){var pix=-1;if(feature.cluster){}else if(feature.attributes.marker_width){pix=-(feature.attributes.marker_width/2);}else if(style&&!style_array&&undefined==style.externalGraphic&&undefined==marker_width&&feature.geometry.CLASS_NAME=='OpenLayers.Geometry.Point'){pix=-(options.marker_default.w/2);}else if(undefined!=marker_width){pix=-(marker_width/2);}
return pix;},graphicYOffset:function(feature){var pix=-1;if(feature.cluster){}else if(feature.attributes.marker_height){pix=-feature.attributes.marker_height;}else if(style&&!style_array&&undefined==style.externalGraphic&&undefined==marker_height&&feature.geometry.CLASS_NAME=='OpenLayers.Geometry.Point'){pix=-options.marker_default.h;}else if(undefined!=marker_height){pix=-marker_height;}
return pix;},graphicName:function(feature){var graphic='circle';if(feature.cluster){}else if(feature.attributes.shape){graphic=feature.attributes.shape;}else if(style){if(!style_array){if(undefined!=style.graphic){graphic=style.graphic;}}}
return graphic;},externalGraphic:function(feature){var url='';if(feature.cluster){}else if(feature.attributes.marker_url){url=feature.attributes.marker_url;}else if(style){if(!style_array){if(undefined!=style.externalGraphic){url=S3.Ap.concat('/static/'+style.externalGraphic);}else if(feature.geometry.CLASS_NAME=='OpenLayers.Geometry.Point'){if(marker_url){return marker_url;}else{url=marker_url_path+options.marker_default.i;}}}else{}}else{if(feature.geometry.CLASS_NAME=='OpenLayers.Geometry.Point'){return marker_url;}}
return url;},radius:function(feature){var pix=10;if(feature.cluster){pix=Math.min(feature.attributes.count/2,8)+10;}else if(feature.attributes.size){pix=feature.attributes.size;}else if(style){if(!style_array){pix=style.size;}else{}}
return pix;},fill:function(feature){var color;if(feature.cluster){if(feature.cluster[0].attributes.colour){color=feature.cluster[0].attributes.colour;}else{color='#'+(options.cluster_fill||cluster_fill_default);}}else if(feature.attributes.colour){color=feature.attributes.colour;}else if(feature.attributes.style){color=feature.attributes.style.fill;if(undefined!=color){color='#'+color;}else{color='#000000';}}else if(style){if(!style_array){color=style.fill;}else{}
if(undefined!=color){color='#'+color;}else{color='#000000';}}else{color=fill_default;}
return color;},fillOpacity:function(feature){var fillOpacity;if(feature.cluster){if(feature.cluster[0].attributes.opacity){fillOpacity=feature.cluster[0].attributes.opacity;}else{fillOpacity=opacity;}}else if(feature.attributes.opacity){fillOpacity=feature.attributes.opacity;}else if(feature.attributes.style){fillOpacity=feature.attributes.style.fillOpacity;}else if(style){if(!style_array){fillOpacity=style.fillOpacity;}else{}}
return fillOpacity||opacity;},stroke:function(feature){var color;if(feature.cluster){if(feature.cluster[0].attributes.colour){color=feature.cluster[0].attributes.colour;}else{color='#'+(options.cluster_stroke||cluster_stroke_default);}}else if(feature.attributes.colour){color=feature.attributes.colour;}else if(feature.attributes.style){var fstyle=feature.attributes.style;color=fstyle.stroke||fstyle.fill;if(undefined!=color){color='#'+color;}else{color='#000000';}}else if(style){if(!style_array){color=style.stroke||style.fill;}else{}
if(undefined!=color){color='#'+color;}else{color='#000000';}}else{color=fill_default;}
return color;},strokeOpacity:function(feature){var strokeOpacity;if(feature.cluster){if(feature.cluster[0].attributes.opacity){strokeOpacity=feature.cluster[0].attributes.opacity;}else{strokeOpacity=opacity;}}else if(feature.attributes.opacity){strokeOpacity=feature.attributes.opacity;}else if(style){if(!style_array){strokeOpacity=style.strokeOpacity;}else{}}
return strokeOpacity||opacity;},strokeDashstyle:function(feature){var dashStyle;if(style){if(!style_array){dashStyle=style.strokeDashstyle;}else{}}
return dashStyle||'solid';},strokeWidth:function(feature){var width=2;if(feature.cluster){if(feature.cluster[0].attributes.strokeWidth){width=feature.cluster[0].attributes.strokeWidth;}}else if(style){if(!style_array){width=style.strokeWidth;}else{}}
return width||2;},label:function(feature){var label;if(feature.cluster){if(options.cluster_label&&feature.attributes.count>1){label=feature.attributes.count;}}else if(feature.layer&&(undefined!=feature.layer.s3_style)){var style=feature.layer.s3_style;if(!style_array){if(style.show_label){label=style.label;}}else{}}
return label||'';},zIndex:function(feature){if(feature.geometry.CLASS_NAME=='OpenLayers.Geometry.Point'){return 10;}else if(feature.geometry.CLASS_NAME=='OpenLayers.Geometry.Line'){return 5;}else{return 0;}},graphicZIndex:function(feature){if(feature.geometry.CLASS_NAME=='OpenLayers.Geometry.Point'){return 10;}else if(feature.geometry.CLASS_NAME=='OpenLayers.Geometry.Line'){return 5;}else{return 0;}}}};var featureStyle=new OpenLayers.Style(styleArray,styleOptions);if(style_array){var rules=styleRules(layer);featureStyle.addRules(rules);}
if(opacity!=1){var selectOpacity=Math.min(opacity*2,0.8);var selectStyle={fillOpacity:selectOpacity,graphicOpacity:selectOpacity};}else{var selectStyle={fillColor:'#'+(options.select_fill||select_fill_default),strokeColor:'#'+(options.select_stroke||select_stroke_default)};}
var featureStyleMap=new OpenLayers.StyleMap({'default':featureStyle,'select':selectStyle});return[featureStyleMap,marker_url];};var styleRules=function(layer){var style=layer.style;var rules=[];var prop,rule,value,elseFilter,fill,fillOpacity,point,externalGraphic,graphicHeight,graphicWidth,line,strokeOpacity,strokeWidth,symbolizer;$.each(style,function(index,elem){var options={};if(undefined!=elem.fallback){options.title=elem.fallback;elsefilter=options.elseFilter=true;}else{if(undefined!=elem.prop){prop=elem.prop;}else{prop='value';}
if(undefined!=elem.cat){value=elem.cat;options.title=elem.label||value;options.filter=new OpenLayers.Filter.Comparison({type:OpenLayers.Filter.Comparison.EQUAL_TO,property:prop,value:value});}else{options.title=elem.label||(elem.low+'-'+elem.high);options.filter=new OpenLayers.Filter.Comparison({type:OpenLayers.Filter.Comparison.BETWEEN,property:prop,lowerBoundary:elem.low,upperBoundary:elem.high});}}
if(undefined!=elem.externalGraphic){point=true;line=false;}else if(undefined!=elem.size){point=true;line=false;}else{point=false;}
if(undefined!=elem.fill){line=false;fill='#'+elem.fill;}else if(undefined!=elem.stroke){line=true;fill='#'+elem.stroke;}
if(undefined!=elem.fillOpacity){fillOpacity=elem.fillOpacity;}else{fillOpacity=layer.opacity||1;}
if(undefined!=elem.strokeOpacity){strokeOpacity=elem.strokeOpacity;}else{strokeOpacity=1;}
if(undefined!=elem.graphic){graphic=elem.graphic;}else{graphic='square';}
if(undefined!=elem.strokeWidth){strokeWidth=elem.strokeWidth;}else{strokeWidth=2;}
symbolizer={fillColor:fill,fillOpacity:fillOpacity,strokeColor:fill,strokeOpacity:strokeOpacity,strokeWidth:strokeWidth,graphicName:graphic};if(point){if(undefined!=elem.externalGraphic){externalGraphic=S3.Ap.concat('/static/'+elem.externalGraphic);var image=new Image();image.src=externalGraphic;graphicHeight=image.height;graphicWidth=image.width;symbolizer.externalGraphic=externalGraphic;symbolizer.graphicHeight=graphicHeight;symbolizer.graphicWidth=graphicWidth;symbolizer.graphicXOffset=-(graphicWidth/2);symbolizer.graphicYOffset=-graphicHeight;}
symbolizer.pointRadius=elem.size||10;symbolizer.graphicZIndex=10;symbolizer.zIndex=10;symbolizer.Point=symbolizer;}else if(line){symbolizer.graphicZIndex=5;symbolizer.zIndex=5;symbolizer.Line=symbolizer;if(undefined!=elem.strokeDashstyle){symbolizer.strokeDashstyle=elem.strokeDashstyle;}}else{}
options.symbolizer=symbolizer;rule=new OpenLayers.Rule(options);rules.push(rule);});if(!elseFilter&&(layer.cluster_threshold!=0)){rule=new OpenLayers.Rule({elseFilter:true,title:' '});rules.push(rule);}
return rules;};}());