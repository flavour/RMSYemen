(function($,undefined){"use strict";var siteCheckInID=0;$.widget('s3.siteCheckIn',{options:{tableName:'site_check_in',ajaxURL:'',noPictureAvailable:'No picture available',statusCheckedIn:'checked-in',statusCheckedOut:'checked-out',statusNone:'-',statusLabel:'Status'},_create:function(){var el=$(this.element);this.id=siteCheckInID;siteCheckInID+=1;this.eventNamespace='.siteCheckIn';},_init:function(){this.idPrefix='#'+this.options.tableName;this.personData=$(this.element).find('input[type=hidden][name=data]');this.refresh();},_destroy:function(){$.Widget.prototype.destroy.call(this);},refresh:function(){this._unbindEvents();var data=this.personData.val();if(data&&data!='null'){this._showPersonData(JSON.parse(data));}
this._bindEvents();},_checkID:function(){var prefix=this.idPrefix,labelInput=$(prefix+'_label'),label=labelInput.val().trim();labelInput.val(label);if(!label){return;}
this._clearForm(false,true);var personInfo=$(prefix+'_person__row .controls').empty(),throbber=$('<div class="inline-throbber">').insertAfter(personInfo);$('#submit_record__row').find('.button').prop('disabled',true);var self=this,ajaxURL=this.options.ajaxURL,input={m:'check',l:label};$.ajaxS3({'url':ajaxURL,'type':'POST','dataType':'json','contentType':'application/json; charset=utf-8','data':JSON.stringify(input),'success':function(data){throbber.remove();$('#submit_record__row').find('.button').prop('disabled',false);if(data.e){var msg=$('<div class="error_wrapper"><div id="label__error" class="error" style="display: block;">'+data.e+'</div></div>').hide();msg.insertAfter(labelInput).slideDown();}else{self._showPersonData(data);var alert=data.m;if(alert){S3.showAlert(alert[0],alert[1]);}}},'error':function(){throbber.remove();$('#submit_record__row').find('.button').prop('disabled',false);self._clearForm(true,false);}});},_register:function(method){var prefix=this.idPrefix,labelInput=$(prefix+'_label'),label=labelInput.val().trim();labelInput.val(label);if(!label){return;}
this._clearAlert();var personInfo=$(prefix+'_person__row .controls'),throbber=$('<div class="inline-throbber">').insertAfter(personInfo);$('#submit_record__row').find('.button').prop('disabled',true);var hasPersonInfo=!!$.trim(personInfo.html()).length;var self=this,ajaxURL=this.options.ajaxURL,input={m:method,l:label};$.ajaxS3({'url':ajaxURL,'type':'POST','dataType':'json','contentType':'application/json; charset=utf-8','data':JSON.stringify(input),'success':function(data){throbber.remove();$('#submit_record__row').find('.button').prop('disabled',false);if(data.e){var msg=$('<div class="error_wrapper"><div id="label__error" class="error" style="display: block;">'+data.e+'</div></div>').hide();msg.insertAfter(labelInput).slideDown();}else{if(data.a&&!hasPersonInfo){self._showPersonData(data);}else{self._clearForm();}
var alert=data.m;if(alert){S3.showAlert(alert[0],alert[1]);}}},'error':function(){throbber.remove();$('#submit_record__row').find('.button').prop('disabled',false);self._clearForm(true,false);}});},_showPersonData:function(data){var prefix=this.idPrefix,person=$(prefix+'_person__row .controls'),status=$(prefix+'_status__row .controls'),info=$(prefix+'_info__row .controls');person.html(data.d).removeClass('hide').show();this._showProfilePicture(data.p);var statusMsg=this._statusMsg(data.s);status.append(statusMsg).removeClass('hide').show();if(!data.i){this._toggleAction('check-in-btn','deny');}else if(data.s==1){this._toggleAction('check-in-btn','off');}
if(!data.o){this._toggleAction('check-out-btn','deny');}else if(data.s==2){this._toggleAction('check-out-btn','off');}
if(data.a){info.html(data.a).removeClass('hide').show();}},_statusMsg:function(status){var opts=this.options,container=$('<div class="check-in-status">'),label=$('<span class="status-label">'+opts.statusLabel+': </span>').appendTo(container),message=$('<span class="status-message">').appendTo(container);switch(status){case 1:message.html(opts.statusCheckedIn);break;case 2:message.html(opts.statusCheckedOut);break;default:message.html(opts.statusNone);break;}
return container;},_clearForm:function(keepAlerts,keepInput){var prefix=this.idPrefix;$('.inline-throbber').remove();if(!keepAlerts){this._clearAlert();}
if(!keepInput){$(prefix+'_label').val('').focus();}
$(prefix+'_person__row .controls').hide().empty();$(prefix+'_status__row .controls').hide().empty();$(prefix+'_info__row .controls').hide().empty();this._hideProfilePicture();this._toggleAction('check-in-btn','on');this._toggleAction('check-out-btn','on');},_clearAlert:function(){$('.alert-error, .alert-warning, .alert-info, .alert-success').fadeOut('fast').remove();$('.error_wrapper').fadeOut('fast').remove();},_showProfilePicture:function(url){var container=$('#profile-picture').empty(),panel=$('<div class="panel">').hide().appendTo(container),image;if(url){image=$('<img>').attr('src',url);}else{image=$('<p>').text(this.options.noPictureAvailable);}
panel.append(image).show();},_hideProfilePicture:function(){$('#profile-picture').empty();},_toggleAction:function(buttonClass,status){var button=$('input.'+buttonClass),label=button.val(),disabled;if(!button.length){return;}
button.siblings('.disabled-'+buttonClass).remove();switch(status){case'off':button.prop('disabled',true).show();break;case'deny':disabled=$('<a class="tiny alert button disabled-'+buttonClass+'" disabled="disabled"><i class="fa fa-ban"></i>'+label+'</a>');button.prop('disabled',true).hide().after(disabled);break;default:button.siblings('.disabled-'+buttonClass).remove();button.prop('disabled',false).show();break;}},_bindEvents:function(){var self=this,form=$(this.element),ns=this.eventNamespace,prefix=this.idPrefix;form.find('.check-btn').bind('click'+ns,function(e){e.preventDefault();self._checkID();});form.find('.check-in-btn').unbind(ns).bind('click'+ns,function(e){e.preventDefault();self._register('check-in');});form.find('.check-out-btn').unbind(ns).bind('click'+ns,function(e){e.preventDefault();self._register('check-out');});form.find('a.cancel-action, .clear-btn').bind('click'+ns,function(e){e.preventDefault();self._clearForm();});var labelInput=$(prefix+'_label');labelInput.bind('input'+ns,function(e){self._clearForm(false,true);});labelInput.bind('keyup'+ns,function(e){switch(e.which){case 27:self._clearForm();break;default:break;}});return true;},_unbindEvents:function(){var form=$(this.element),ns=this.eventNamespace,prefix=this.idPrefix;$(prefix+'_label').unbind(ns);form.find('.check-btn').unbind(ns);form.find('.check-in-btn').unbind(ns);form.find('.check-out-btn').unbind(ns);form.find('a.cancel-action, .clear-btn').unbind(ns);return true;}});})(jQuery);