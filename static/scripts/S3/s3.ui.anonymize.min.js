(function($,undefined){"use strict";var anonymizeID=0;$.widget('s3.anonymize',{options:{ajaxURL:null},_create:function(){this.id=anonymizeID;anonymizeID+=1;this.eventNamespace='.anonymize';},_init:function(){var el=$(this.element);this.container=el.find('.anonymize-dialog');this.submitButton=el.find('.anonymize-submit');this.cancelButton=el.find('.anonymize-cancel');this.confirmCB=el.find('input[name="anonymize_confirm"]').first();this.refresh();},_destroy:function(){$.Widget.prototype.destroy.call(this);},refresh:function(){this._unbindEvents();this._bindEvents();},_showDialog:function(){var ns=this.eventNamespace,container=this.container,cancelButton=this.cancelButton,submitButton=this.submitButton,confirmCB=this.confirmCB,self=this;var dialog=container.removeClass('hide').show().dialog({autoOpen:false,modal:true,closeText:'',open:function(){$('.ui-widget-overlay').off(ns).on('click'+ns,function(){dialog.dialog('close');});cancelButton.off(ns).on('click'+ns,function(){dialog.dialog('close');});confirmCB.off(ns).on('click'+ns,function(){if($(this).prop('checked')){submitButton.prop('disabled',false);}else{submitButton.prop('disabled',true);}});submitButton.off(ns).on('click'+ns,function(){self._anonymize(container).then(function(reload){container.find('.anonymize-form').hide();container.find('.anonymize-success').removeClass('hide').show();if(reload){try{S3ClearNavigateAwayConfirm();}finally{window.location.reload(true);}}else{dialog.dialog('close');}},function(){dialog.dialog('close');});});},close:function(){confirmCB.prop('checked',false);submitButton.prop('disabled',true);container.hide();}});dialog.dialog('open');},_anonymize:function(container){var dfd=$.Deferred();var cancelButton=this.cancelButton.hide(),submitButton=this.submitButton.prop('disabled',true);var throbber=$('<div class="inline-throbber">').css({'display':'inline-block','margin-left':'1rem'}).insertAfter(cancelButton);var removeThrobber=function(){throbber.remove();cancelButton.show();submitButton.prop('disabled',false);};var selected=[];container.find('.anonymize-rule').each(function(){if($(this).prop('checked')){selected.push($(this).attr('name'));}});if(!selected.length){return dfd.resolve(false);}
var key=container.find('input[name="action-key"]').first().val(),data=JSON.stringify({'apply':selected,'key':key,}),url=this.options.ajaxURL;$.ajaxS3({type:'POST',url:url,data:data,dataType:'json',contentType:'application/json; charset=utf-8',success:function(){removeThrobber();dfd.resolve(true);},error:function(){removeThrobber();dfd.reject();}});return dfd.promise();},_bindEvents:function(){var self=this,ns=this.eventNamespace;$(this.element).find('.anonymize-btn').off(ns).on('click'+ns,function(){self._showDialog();});return true;},_unbindEvents:function(){var ns=this.eventNamespace;$(this.element).off(ns);return true;}});})(jQuery);