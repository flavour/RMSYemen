(function($,undefined){"use strict";var cascadeSelectID=0;$.widget('s3.cascadeSelect',{options:{multiple:true,leafonly:true,cascade:true,},_create:function(){this.id=cascadeSelectID;cascadeSelectID+=1;this.eventNamespace='.cascadeSelect';},_init:function(){var el=$(this.element);this.hiddenInput=$('.s3-cascade-input',el).first();this.refresh();},_destroy:function(){$.Widget.prototype.destroy.call(this);},refresh:function(){var el=$(this.element);this._unbindEvents();var selectors=[];$('select.s3-cascade-select',el).each(function(){selectors.push($(this).empty().data('available',{}));});selectors.sort(function(a,b){return a.data('level')-b.data('level');});this.selectors=selectors;var hierarchy=this._getHierarchy();for(var nodeID in hierarchy){this._addAvailableOption(null,0,nodeID,hierarchy[nodeID]);}
this._renderOptions(selectors[0],Object.keys(hierarchy),[]);var selected=this._deserialize();this._updateOptions(selectors[selectors.length-1],selected);this._multiSelectInit();this._bindEvents();},get:function(){return this._deserialize();},set:function(value){this.reset();if(!value){return;}
if(value.constructor!==Array){value=[value];}
value=value.map(function(v){return''+v;});var selectors=this.selectors;this._updateOptions(selectors[selectors.length-1],value);this._serialize();return this;},reset:function(){this.selectors.forEach(function(selector,index){selector.val('');if(index>0){$('option',selector).remove();}
var multiSelect=selector.multiselect('instance');if(multiSelect){multiSelect.refresh();}});this._serialize();this._toggleSelectors();return this;},_deserialize:function(){var values=JSON.parse(this.hiddenInput.val());if(values){return values.map(function(v){return''+v;});}else{return[];}},_serialize:function(){var opts=this.options,selection=[],selectors=this.selectors;for(var i=selectors.length;i--;){var selector=selectors[i],multiple=selector.prop('multiple'),available=selector.data('available'),selected=this._getSelected(selector);for(var j=0,len=selected.length;j<len;j++){var value=selected[j],node=available[value];if(!node||opts.leafonly&&node[3]){continue;}
if(selection.indexOf(value)==-1){selection.push(value);}
if(selection.length&&!multiple){break;}}
if(selection.length&&!multiple){break;}}
this.hiddenInput.val(JSON.stringify(selection)).trigger('select.s3hierarchy');},_multiSelectInit:function(){this.selectors.forEach(function(selector){if(selector.multiselect('instance')){selector.multiselect('refresh');}else{if(selector.prop('multiple')){selector.multiselect({});}}});},_getHierarchy:function(){var el=$(this).element,hierarchy=this.hierarchy;if(hierarchy===undefined){var dataInput=$('.s3-cascade',el);this.hierarchy=hierarchy=JSON.parse(dataInput.val());}
return hierarchy;},_updateOptions:function(selector,selected,propagate){var level=selector.data('level'),available=selector.data('available'),subNodes=[];selected=selected.slice(0);this._getSelected(selector).forEach(function(nodeID){if(selected.indexOf(nodeID)==-1&&(!propagate||propagate.indexOf(nodeID)!=-1)){selected.push(nodeID);}});if(level===0){this._setSelected(selector,selected);}else if(propagate){this._renderOptions(selector,propagate,selected);}else{var selection=selected.slice(0);selected.forEach(function(nodeID){var node=available[nodeID];if(node!==undefined){var parentID=node[0];if(selection.indexOf(parentID)==-1){selection.push(node[0]);}}});this._updateOptions(this.selectors[level-1],selection);}
if(level===0||propagate){var nextLevel=this.selectors[level+1];if(nextLevel!==undefined){selected.forEach(function(nodeID){var node=available[nodeID];if(node!==undefined){subNodes=subNodes.concat(Object.keys(node[3]));}});this._updateOptions(nextLevel,selected,subNodes);}else{this._toggleSelectors();}}},_renderOptions:function(selector,options,selected){var opts=this.options;if(!opts.multiple&&opts.cascade&&options.length==1){var singleOpt=options[0];if(selected.indexOf(singleOpt)==-1){selected.push(singleOpt);}}
var available=selector.data('available');selector.empty();var items=[];options.forEach(function(nodeID){var node=available[nodeID];if(node){items.push([nodeID,node[1]]);}});items.sort(function(a,b){return a[1].localeCompare(b[1]);});items.forEach(function(item){$('<option>').val(item[0]).text(item[1]).appendTo(selector);});this._setSelected(selector,selected);},_getSelected:function(selector){var value=$(selector).val();if(!value){return[];}
if(value.constructor===Array){return value.map(function(v){return''+v;});}else{return[''+value];}},_setSelected:function(selector,values){var available=selector.data('available'),multiSelect=selector.multiselect('instance');var selected=values.filter(function(value){return available[''+value]!==undefined;});if(selector.prop('multiple')){selector.val(selected);}else{selector.val(selected[0]);}
if(multiSelect){multiSelect.refresh();}},_addAvailableOption:function(parent,level,nodeID,node){var selector=this.selectors[level];if(!selector){return;}
var available=selector.data('available');if(available===undefined||available===null){available={};}
available[''+nodeID]=[''+parent].concat(node);selector.data('available',available);var subNodes=node[2];if(subNodes&&subNodes!==true){for(var subNodeID in subNodes){this._addAvailableOption(nodeID,level+1,subNodeID,subNodes[subNodeID]);}}},_toggleSelectors:function(){this.selectors.forEach(function(selector){var multiSelect=selector.multiselect('instance');if($('option',selector).length){selector.prop('disabled',false);if(multiSelect){multiSelect.enable();}}else{selector.prop('disabled',true);if(multiSelect){multiSelect.disable();}}});},_hiddenBranches:function(selector,values){var hidden=[],level=selector.data('level'),nextLevel=this.selectors[level+1];if(nextLevel){var available=selector.data('available'),branches={};values.forEach(function(value){var node=available[value];if(node){var subNodes=node[3];if(subNodes&&subNodes!==true){for(var nodeID in subNodes){branches[''+nodeID]=true;}}}});$('option',nextLevel).each(function(){branches[$(this).val()]=false;});hidden=Object.keys(branches).filter(function(nodeID){return branches[nodeID];});hidden=hidden.concat(this._hiddenBranches(nextLevel,hidden));}
return hidden;},_bindEvents:function(){var el=$(this.element),ns=this.eventNamespace,opts=this.options,self=this;$('select.s3-cascade-select',el).on('change'+ns,function(){var selector=$(this),selected=self._getSelected(selector);if(opts.multiple&&opts.cascade){var hidden=self._hiddenBranches(selector,selected);hidden.forEach(function(nodeID){if(selected.indexOf(nodeID)==-1){selected.push(nodeID);}});}
self._updateOptions(selector,selected);self._serialize();});return true;},_unbindEvents:function(){var el=$(this.element),ns=this.eventNamespace;$('select.s3-cascade-select',el).off(ns);return true;}});})(jQuery);