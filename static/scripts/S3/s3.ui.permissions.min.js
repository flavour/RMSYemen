(function($,undefined){"use strict";var labels={rm_Add:'Add',rm_AddRule:'Add Rule',rm_AllEntities:'All Entities',rm_AllRecords:'All Records',rm_AssignedEntities:'Assigned Entities',rm_Cancel:'Cancel',rm_CollapseAll:'Collapse All',rm_ConfirmDeleteRule:'Do you want to delete this rule?',rm_Default:'default',rm_DeleteRule:'Delete',rm_ExpandAll:'Expand All',rm_NoAccess:'No access',rm_NoRestrictions:'No restrictions',rm_Others:'Others',rm_OwnedRecords:'Owned Records',rm_Page:'Page',rm_RestrictedTables:'Restricted Tables',rm_Scope:'Scope',rm_SystemTables:'System Tables',rm_Table:'Table',rm_UnrestrictedTables:'Unrestricted Tables',};var equivalent=function(a,b){var check;if(a[0]===null||b[0]===null){check=[1,2,3];}else{check=[1,2,3,6];}
for(var i=check.length,idx;i--;){idx=check[i];if(a[idx]!==b[idx]){return false;}}
return true;};var getTarget=function(rule){var target,tablename=rule[3];if(tablename){if(tablename!==true){target=tablename;}}else{if(rule[2]!==true){target=rule[1]+'/'+(rule[2]||'*');}}
return target;};var permissionEditID=0;$.widget('s3.permissionEdit',{options:{fRules:false,tRules:false,useRealms:false,permissions:[{l:"CREATE",b:0x0001,o:false},{l:"READ",b:0x0002,o:true},{l:"UPDATE",b:0x0004,o:true},{l:"DELETE",b:0x0008,o:true}],modules:{},models:{},defaultPermissions:{},icons:{expanded:'fa fa-caret-down',collapsed:'fa fa-caret-right'}},_create:function(){this.id=permissionEditID;permissionEditID+=1;this.eventNamespace='.permissionEdit';},_init:function(){var el=$(this.element),widgetID=el.attr('id');this.input=$('#'+widgetID+'-input');if(this.options.useRealms){this.tableWidth=5;}else{this.tableWidth=4;}
for(var key in labels){labels[key]=i18n[key]||labels[key];}
this.refresh();},_destroy:function(){$.Widget.prototype.destroy.call(this);},refresh:function(){var el=$(this.element),opts=this.options;this._unbindEvents();this._deserialize();var rules=this._ruleSets(),container=$('.rm-rules',el).first();var self=this,ruleSet=rules.pages,tab=$('.rm-page-rules',el);this._renderExpandCollapseAll().appendTo(tab);Object.keys(opts.modules).sort().forEach(function(prefix){if(opts.modules[prefix][1]){self._ruleTable('p',prefix,ruleSet[prefix]).appendTo(tab);}});if(ruleSet._other.length){this._ruleTable('p','_other',ruleSet._other).appendTo(tab);}
if(opts.tRules){ruleSet=rules.tables;tab=$('.rm-table-rules',el);this._renderExpandCollapseAll().appendTo(tab);Object.keys(opts.models).sort().forEach(function(prefix){if(prefix!='_system'){self._ruleTable('t',prefix,ruleSet[prefix]).appendTo(tab);}});this._ruleTable('t','_system',ruleSet._system).appendTo(tab);if(ruleSet._other.length){this._ruleTable('t','_other',ruleSet._other).appendTo(tab);}}
container.tabs().removeClass('hide').show();this._bindEvents();},_deserialize:function(){try{this.rules=JSON.parse(this.input.val());}catch(e){this.rules=[];this._serialize();}},_serialize:function(){var rules=this.rules.filter(function(rule){return rule[0]!==null&&(rule[0]!==0||!rule[7]);});this.input.val(JSON.stringify(rules)).change();},_ruleSets:function(){var rules=this.rules,pRules={_other:[]},tRules={_other:[]},opts=this.options;rules.forEach(function(rule){var ruleSet,module,prefixes,tablename=rule[3];if(tablename){ruleSet=tRules;prefixes=opts.models;module=tablename.split('_')[0];}else{ruleSet=pRules;prefixes=opts.modules;var c=rule[1],f=rule[2];if(c=='default'&&(f=='table'||f=='tables')){module='default/dt';}else{module=c;}}
if(prefixes.hasOwnProperty(module)){if(ruleSet[module]===undefined){ruleSet[module]=[];}}else{module='_other';}
ruleSet[module].push(rule);});return{pages:pRules,tables:tRules};},_renderExpandCollapseAll:function(){var expand=$('<span class="action-lnk rm-expand-all">'),collapse=$('<span class="action-lnk rm-collapse-all">');expand.text(labels.rm_ExpandAll);collapse.text(labels.rm_CollapseAll);return $('<div class="rm-toggle-all">').append(expand).append(collapse);},_ruleTable:function(ruleType,prefix,rules){if(!rules){rules=[];}
var table=$('<table class="rm-module-rules">').data({module:prefix});table.append(this._ruleTableHeader(prefix)).append(this._ruleTableBody(ruleType,prefix,rules)).append(this._ruleTableFooter(ruleType,prefix,rules));this._indicateNumRules(table,rules.length);return table;},_ruleTableHeader:function(prefix){var thead=$('<thead class="rm-module-header">'),header=$('<th>').attr('colspan',this.tableWidth);var icons=this.options.icons;if(icons){var expanded=$('<i class="'+icons.expanded+'">').hide(),collapsed=$('<i class="'+icons.collapsed+'">');$('<div class="rm-module-toggle">').append(expanded).append(collapsed).appendTo(header);}
var module,title;switch(prefix){case'_system':module='SYSTEM';title=labels.rm_SystemTables;break;case'_other':module='*';title=labels.rm_Others;break;case's3dt':module='S3DT';title=labels.rm_DynamicTables;break;default:if(prefix=='default/dt'){module='DEFAULT';}else{module=prefix.toLocaleUpperCase();}
if(this.options.modules.hasOwnProperty(prefix)){title=this.options.modules[prefix][0];}else{title='';}
break;}
$('<div class="rm-module-prefix">').text(module).appendTo(header);$('<div class="rm-module-title">').text(title).appendTo(header);$('<div class="rm-module-numrules">').appendTo(header);$('<tr>').append(header).appendTo(thead);return thead;},_ruleTableBody:function(ruleType,prefix,rules){var opts=this.options,tbody=$('<tbody>').hide(),hasRules=true,targets=rules.map(getTarget),targetLabel;if(ruleType=='t'){var tables=opts.models[prefix];if(tables){for(var tablename in tables){if(tables[tablename]&&targets.indexOf(tablename)==-1){rules.push([null,null,null,tablename,null,null,null,false]);}}}
targetLabel=labels.rm_Table;if(rules.length===0){hasRules=false;tbody.append(this._defaultRule(false));}}else{var dynamicTables=prefix=='default/dt',page,match,f;for(var target in opts.defaultPermissions){if(dynamicTables){match=target=='default/tables'||target=='default/table';}else{match=target.slice(0,prefix.length+1)==prefix+'/';}
if(match&&targets.indexOf(target)==-1){page=target.split('/');f=page[1];if(f=='*'){f=null;}else if(!opts.fRules){continue;}
rules.push([null,page[0],f,null,null,null,null,false]);}}
targetLabel=labels.rm_Page;if(rules.length===0){hasRules=false;tbody.append(this._defaultRule(true));}}
var labelRow=$('<tr class="rm-rule-labels">').hide().appendTo(tbody);labelRow.append('<th>'+targetLabel+'</th>').append('<th>'+(labels.rm_AllRecords)+'</th>').append('<th>'+(labels.rm_OwnedRecords)+'</th>');if(opts.useRealms){$('<th>').text(labels.rm_Scope).appendTo(labelRow);}
labelRow.append('<th></th>');if(hasRules){labelRow.show();rules=rules.sort(function(a,b){var aStr=a.slice(1,4).join(' '),bStr=b.slice(1,4).join(' ');if(aStr===bStr){return 0;}else{return aStr>bStr&&1||-1;}});var self=this;rules.forEach(function(rule){self._ruleTableRow(rule).appendTo(tbody);});}
return tbody;},_ruleTableFooter:function(ruleType,prefix,rules){var tfoot=$('<tfoot>').hide();if(prefix!='_other'){var addRow=$('<tr class="rm-module-add">'),cell=$('<td>').attr('colspan',this.tableWidth),addRule=$('<span class="action-lnk rm-add-rule">');addRule.text(labels.rm_AddRule).appendTo(cell);if(ruleType!='t'&&!this.options.fRules&&rules.length){addRow.hide();}
addRow.append(cell).appendTo(tfoot);}
return tfoot;},_ruleTableRow:function(rule){var row=$('<tr class="rm-rule">').data({rule:rule}),opts=this.options,target=getTarget(rule);if(target){$('<td class="rm-rule-target">').text(target).appendTo(row);}else{var targetSelector=this._targetSelector(rule);$('<td class="rm-rule-target">').append(targetSelector).appendTo(row);}
if(target&&rule[0]===null){row.addClass('rm-default-permissions');var defaultPermissions=this._defaultPermissions(target);if(defaultPermissions.oACL){$('<td>').text(defaultPermissions.uACL).appendTo(row);$('<td>').text(defaultPermissions.oACL).appendTo(row);}else{$('<td>').attr('colspan',2).text(defaultPermissions.uACL).appendTo(row);}
if(opts.useRealms){$('<td>').appendTo(row);}
var addRule=$('<a class="rm-add-rule action-lnk">');$('<td>').append(addRule.text(labels.rm_AddRule)).appendTo(row);}else{var pSelector=this._permissionSelector(rule);row.append(pSelector.uACL).append(pSelector.oACL);if(opts.useRealms){$('<td>').append(this._scopeSelector(rule)).appendTo(row);}
if(target){var deleteRule=$('<a class="rm-delete-rule delete-btn-ajax">');$('<td>').append(deleteRule.text(labels.rm_DeleteRule)).appendTo(row);}else{var submitRule=$('<a class="rm-submit-rule action-btn">'),cancelAdd=$('<span class="rm-cancel-add action-lnk">');$('<td>').append(submitRule.text(labels.rm_Add)).append(cancelAdd.text(labels.rm_Cancel)).appendTo(row);}}
return row;},_targetSelector:function(rule){var opts=this.options,wrapper=$('<div>'),selector,prefix=rule[1];var selectOption=function(value,label){if(label===undefined){label=value;}
return $('<option value="'+value+'">').text(label);};var emptyOption=function(){return $('<option value="">').prop('selected',true).prop('disabled',true).hide();};if(rule[3]){var tables=opts.models[prefix],rGroup=$('<optgroup>').attr('label',labels.rm_RestrictedTables),uGroup=$('<optgroup>').attr('label',labels.rm_UnrestrictedTables),numRestricted=0,numUnrestricted=0;Object.keys(tables).sort().forEach(function(tableName){if(tables[tableName]){numRestricted+=1;rGroup.append(selectOption(tableName));}else{numUnrestricted+=1;uGroup.append(selectOption(tableName));}});selector=$('<select>').append(emptyOption());if(numRestricted){selector.append(rGroup);}
if(numUnrestricted){selector.append(uGroup);}}else{if(prefix=='_other'){selector=$('<input type="text" size="20">');selector.data('pattern',/^(\w+)(\/(\*|[\w]+))?$/);}else{if(prefix=='default/dt'){selector=$('<select>');selector.append(emptyOption()).append(selectOption('default/table')).append(selectOption('default/tables'));}else{wrapper.append('<span>'+prefix+' / </span>');selector=$('<input type="text" size="10">');selector.data('pattern',/^(\w+|\*)$/);}}}
selector.addClass('rm-target-select').appendTo(wrapper);return wrapper;},_validateTarget:function(input){var value=input.val(),valid=input.data('pattern');valid.lastIndex=0;if(value&&valid&&!valid.exec(value)){input.addClass('rm-invalid');return false;}else{input.removeClass('rm-invalid');return true;}},_defaultPermissions:function(target){var opts=this.options,permissions=opts.defaultPermissions[target],result={},defaultLabel=' ('+labels.rm_Default+')';if(permissions!==undefined){var uACL=permissions[0],oACL=permissions[1]&~uACL;var pLabel=function(bitmap){var l=[];opts.permissions.forEach(function(p){if(bitmap&p.b){l.push(p.l);}});return l.join(', ');};if(uACL){result.uACL=pLabel(uACL)+defaultLabel;}
if(oACL){result.oACL=pLabel(oACL)+defaultLabel;}}
if(!result.uACL){result.uACL=labels.rm_NoAccess+defaultLabel;}
return result;},_defaultRule:function(restricted){var defaultRule;if(restricted){defaultRule=labels.rm_NoAccess;}else{defaultRule=labels.rm_NoRestrictions;}
defaultRule=$('<td>').attr('colspan',this.tableWidth).text(defaultRule);return $('<tr class="rm-default-rule">').append(defaultRule);},_permissionSelector:function(rule){var uBox=$('<td class="rm-permission-all">'),oBox=$('<td class="rm-permission-own">');this.options.permissions.forEach(function(permission){var uCheckbox=$('<input class="rm-permission" type="checkbox">'),oCheckbox=$('<input class="rm-permission" type="checkbox">');$('<label>').append(uCheckbox).append(permission.l).appendTo(uBox);$('<label>').append(oCheckbox).append(permission.l).css({visibility:permission.o&&'visible'||'hidden'}).appendTo(oBox);var selected=rule[5]&permission.b;oCheckbox.prop('checked',selected);oCheckbox.data({bit:permission.b,selected:selected,implied:false});selected=rule[4]&permission.b;uCheckbox.prop('checked',selected);uCheckbox.data({bit:permission.b,selected:selected,implied:false});oCheckbox.data('implied',selected);if(selected){oCheckbox.prop({checked:true,disabled:true});}
uCheckbox.data('imply',oCheckbox);});return{uACL:uBox,oACL:oBox};},_scopeSelector:function(rule){var selector=$('<select class="rm-scope-select">'),assigned=$('<option value="">').text(labels.rm_AssignedEntities),any=$('<option value="any">').text(labels.rm_AllEntities);if(rule){switch(rule[6]){case'any':any.prop('selected',true);break;default:assigned.prop('selected',true);rule[6]=null;break;}}
selector.append(assigned).append(any);return $('<div>').append(selector);},_addRule:function(trigger){var opts=this.options,ruleTable=trigger.closest('.rm-module-rules'),prefix=ruleTable.data('module'),models=opts.models[prefix];var self=this;$('tfoot .rm-rule',$(this.element)).each(function(){self._cancelAdd($(this));});var row=trigger.closest('.rm-rule'),newRow,rule;if(row.length){rule=row.data('rule');var tablename=rule[3];if(tablename){rule=[0,null,null,tablename,0,0,null,false];}else{rule=[0,rule[1],rule[2],null,0,0,null,false];}
var defaultPermissions=opts.defaultPermissions[getTarget(rule)];if(defaultPermissions){rule[4]=defaultPermissions[0];rule[5]=defaultPermissions[1];}
this.rules.push(rule);newRow=this._ruleTableRow(rule);row.after(newRow).remove();if(tablename){models[tablename]+=1;}
this._serialize();}else{var editNewRule=true;if(trigger.closest('.rm-table-rules').length){rule=[0,prefix,null,true,0,0,null,false];}else{if(!opts.fRules){if(!$('tbody .rm-rule',ruleTable).length){rule=[0,prefix,null,null,0,0,null,false];editNewRule=false;}}else{rule=[0,prefix,true,null,0,0,null,false];}}
if(rule){newRow=this._ruleTableRow(rule);if(editNewRule){trigger.closest('.rm-module-add').hide().after(newRow);}else{$('tbody',ruleTable).append(newRow);trigger.closest('.rm-module-add').hide();}}
$('.rm-default-rule',ruleTable).hide();$('.rm-rule-labels',ruleTable).show();}},_submitAdd:function(row){var ruleTable=row.closest('.rm-module-rules'),rule=row.data('rule'),c=null,f=null,t=null,target=$('.rm-target-select',row).val().replace(/\s/,'');if(rule[3]){t=target;if(!t){return;}}else{c=rule[1];f=target;var isOther=c=='_other';if(c=='default/dt'||isOther){var r=/^(\w+)(\/(\*|[\w]+))?$/.exec(target);if(r){c=r[1];f=r[3];}else{return;}
if(isOther){var ruleTables=$('.rm-module-rules',row.closest('.rm-page-rules'));for(var i=ruleTables.length;i--;){var rt=$(ruleTables[i]);if(rt.data('module')==c){ruleTable=rt;break;}}}}
if(!f||f=='*'){f=null;}else if(!/^\w+$/.exec(f)){return;}}
rule[1]=c&&c.toLowerCase();rule[2]=f&&f.toLowerCase();rule[3]=t&&t.toLowerCase();var duplicate,existing,following;$('tbody .rm-rule',ruleTable).each(function(){var $this=$(this),other=$this.data('rule');if(!duplicate){if(equivalent(rule,other)){existing=other;duplicate=$this;following=duplicate;}else if(!following){if(t){if(other[3]>t){following=$this;}}else{if(other[2]&&(f&&other[2]>f||!f)){following=$this;}}}}});if(existing&&existing[0]!==null){existing.splice(1,rule.length-1);existing.push.apply(existing,rule.slice(1));rule=existing;}else{this.rules.push(rule);var tablename=rule[3];if(tablename){var models=this.options.models[ruleTable.data('module')];if(models[tablename]!==undefined){models[tablename]+=1;}else{models[tablename]=1;}}}
this._serialize();var newRow=this._ruleTableRow(rule);if(following){newRow.insertBefore(following);}else{newRow.appendTo($('tbody',ruleTable));}
if(duplicate){duplicate.remove();}
this._indicateNumRules(ruleTable,$('tbody .rm-rule',ruleTable).length);row.siblings('.rm-module-add').show();row.remove();},_cancelAdd:function(row){var ruleTable=row.closest('.rm-module-rules');if($('tbody .rm-rule',ruleTable).length===0){$('.rm-rule-labels',ruleTable).hide();$('.rm-default-rule',ruleTable).show();}
row.siblings('.rm-module-add').show();row.remove();},_updateRule:function(row,data){var rule=row.data('rule');if(!rule){return;}
for(var k in data){var v=data[k];if(v===undefined){continue;}
switch(k){case'c':rule[1]=v;break;case'f':rule[2]=v;break;case't':rule[3]=v;break;case'uACL':rule[4]=v;break;case'oACL':rule[5]=v;break;case'scope':rule[6]=v;break;case'deleted':rule[7]=!!v;break;default:break;}}
this._serialize();},_deleteRule:function(row){if(confirm(labels.rm_ConfirmDeleteRule)){var opts=this.options,ruleTable=row.closest('.rm-module-rules'),moduleRestricted=false,rule=row.data('rule'),otherRules,defaultRule;rule[7]=true;this._serialize();var tablename=rule[3];if(tablename){otherRules=this.rules.filter(function(r){return r[3]==tablename&&!r[7];});if(!otherRules.length){var prefix=ruleTable.data('module'),models=opts.models[prefix];models[tablename]-=1;if(models[tablename]>0){defaultRule=[null,null,null,tablename,null,null,null,false];this._ruleTableRow(defaultRule).insertBefore(row);}}}else{otherRules=this.rules.filter(function(r){return r[1]==rule[1]&&r[2]==rule[2]&&!r[7];});if(!otherRules.length){if(opts.defaultPermissions[getTarget(rule)]){defaultRule=[null,rule[1],rule[2],null,null,null,null,false];this._ruleTableRow(defaultRule).insertBefore(row);}}
moduleRestricted=true;}
var remainingRules=$('.rm-rule',ruleTable).length-1;if(!remainingRules){this._defaultRule(moduleRestricted).insertBefore(row);$('.rm-rule-labels',ruleTable).hide();$('.rm-module-add',ruleTable).show();}
this._indicateNumRules(ruleTable,remainingRules);row.remove();}},_updatePermissions:function(row){this._updateRule(row,{uACL:this._getPermissions($('.rm-permission-all',row)),oACL:this._getPermissions($('.rm-permission-own',row))});},_getPermissions:function(cbContainer){var permissions=0;$('.rm-permission',cbContainer).each(function(){var cb=$(this);if(!cb.data('implied')&&cb.data('selected')){var bit=cb.data('bit');if(bit){permissions|=bit;}}});return permissions;},_indicateNumRules:function(ruleTable,numRules){var indicator=$('.rm-module-numrules',ruleTable);if(numRules){indicator.text('['+numRules+']');ruleTable.addClass('hasrules');}else{indicator.empty();ruleTable.removeClass('hasrules');}},_toggleRuleTable:function(table){if(table.hasClass('rm-expanded')){$('tbody, tfoot',table).hide();table.removeClass('rm-expanded');}else{$('tbody, tfoot',table).show();table.addClass('rm-expanded');}
$('.rm-module-toggle i',table).toggle();},_toggleAll:function(tab,visibility){var self=this;if(visibility){$('.rm-module-rules:not(.rm-expanded)',tab).each(function(index,table){self._toggleRuleTable($(table));});}else{$('.rm-module-rules.rm-expanded',tab).each(function(index,table){self._toggleRuleTable($(table));});}},_permissionChanged:function(checkbox){if(checkbox.data('implied')){checkbox.prop({checked:true,disabled:true});}else if(checkbox.prop('disabled')){checkbox.prop({disabled:false,checked:checkbox.data('selected')});}else{var selected=checkbox.prop('checked'),implied=checkbox.data('imply');checkbox.data({selected:selected});if(implied&&implied.length){implied.data('implied',selected).change();}}
this._updatePermissions(checkbox.closest('.rm-rule'));},_scopeChanged:function(selector){var row=selector.closest('.rm-rule'),rule=row.data('rule');switch(selector.val()){case'any':rule[6]='any';break;default:rule[6]=null;break;}
this._serialize();},_bindEvents:function(){var el=$(this.element),ns=this.eventNamespace,self=this;$('.rm-table-rules, .rm-page-rules',el).on('click'+ns,'.rm-expand-all',function(){self._toggleAll($(this).closest('.rm-table-rules, .rm-page-rules'),true);return false;}).on('click'+ns,'.rm-collapse-all',function(){self._toggleAll($(this).closest('.rm-table-rules, .rm-page-rules'),false);return false;});$('.rm-module-rules',el).on('click'+ns,'.rm-module-header',function(){self._toggleRuleTable($(this).closest('.rm-module-rules'));return false;}).on('change'+ns,'.rm-permission',function(){self._permissionChanged($(this));return false;}).on('change'+ns,'.rm-scope-select',function(){self._scopeChanged($(this));return false;}).on('click'+ns,'.rm-delete-rule',function(){self._deleteRule($(this).closest('.rm-rule'));return false;}).on('click'+ns,'.rm-add-rule',function(){self._addRule($(this));}).on('click'+ns,'.rm-cancel-add',function(){self._cancelAdd($(this).closest('.rm-rule'));}).on('click'+ns,'.rm-submit-rule',function(){self._submitAdd($(this).closest('.rm-rule'));}).on('input'+ns,'input.rm-target-select',function(){self._validateTarget($(this));});return true;},_unbindEvents:function(){var el=$(this.element),ns=this.eventNamespace;$('.rm-module-rules, .rm-table-rules, .rm-page-rules',el).off(ns);return true;}});})(jQuery);