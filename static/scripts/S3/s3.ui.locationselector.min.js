(function($,undefined){"use strict";var locationselectorID=0;var hierarchyLocations={},hierarchyLabels={},hierarchyReads={};$.widget('s3.locationselector',{options:{hideLx:true,reverseLx:false,locations:null,labels:null,minBBOX:0.05,showLabels:true,featureRequired:null,latlonMode:'decimal',latlonModeToggle:true,openMapOnLoad:false},_create:function(){this.id=locationselectorID;locationselectorID+=1;this.eventNamespace='.locationselector';},_init:function(){var el=$(this.element),opts=this.options;var fieldname=el.attr('id');if(!fieldname){throw'Location selector widget: real input field without id';}
this.fieldname=fieldname;this.input=el;this.data=null;this._storeHierarchyData(opts.labels,opts.locations);this.refresh();},_destroy:function(){$.Widget.prototype.destroy.call(this);},refresh:function(){this._unbindEvents();var data=this._deserialize();this._renderWidget();var selector='#'+this.fieldname,opts=this.options;if($(selector+'_geocode button').length){this.useGeocoder=true;}else{this.useGeocoder=false;}
var row=$(selector+'_L0__row');if(row.length){var locations=[],location,locationID;for(locationID in hierarchyLocations){location=hierarchyLocations[locationID];if(location.l===0){location.i=locationID;locations.push(location);}}
locations.sort(function(a,b){return a.n.localeCompare(b.n);});var dropdown=$(selector+'_L0'),option;for(var i=0,len=locations.length;i<len;i++){location=locations[i];locationID=location.i;option='<option value="'+locationID+'">'+location.n+'</option>';dropdown.append(option);}
row.removeClass('hide').show();var labelRow=$(selector+'_L0__row1');if(labelRow.length){labelRow.removeClass('hide').show();}}
var L0=data.L0,L1=data.L1,L2=data.L2,L3=data.L3,L4=data.L4,L5=data.L5;if(L0){this._lxSelect(0,L0,true);}
if(L1||L2){this._lxSelect(1,L1||L2,true);}
if(L2||L3){this._lxSelect(2,L2||L3,true);}
if(L3||L4){this._lxSelect(3,L3||L4,true);}
if(L4||L5){this._lxSelect(4,L4||L5,true);}
if(L5){this._lxSelect(5,L5,true);}
this.lx=[L0,L1,L2,L3,L4,L5].join('|');$(selector+'_address').val(data.address);$(selector+'_address__row').removeClass('hide').show();$(selector+'_address__row1').removeClass('hide').show();$(selector+'_postcode').val(data.postcode);$(selector+'_postcode__row').removeClass('hide').show();$(selector+'_postcode__row1').removeClass('hide').show();$(selector+'_lat').val(data.lat).latloninput({type:'lat',mode:opts.latlonMode});$(selector+'_lat__row').removeClass('hide').show();$(selector+'_lat__row1').removeClass('hide').show();$(selector+'_lon').val(data.lon).latloninput({type:'lon',mode:opts.latlonMode});$(selector+'_lon__row').removeClass('hide').show();$(selector+'_lon__row1').removeClass('hide').show();var map_icon_row=$(selector+'_map_icon__row').removeClass('hide').show();if(data.lat||data.lon||data.wkt){this.input.data('manually_geocoded',true);this._showMap();}else if(opts.featureRequired){this._showMap();}else if(opts.openMapOnLoad&&map_icon_row.is(':visible')&&selector.substring(0,5)!='#sub_'){this._showMap();}else{this._hideMap();}
this.input.data('input',this._hasData());this.input.prevAll('.throbber').remove();this._bindEvents();},_renderWidget:function(){var fieldname=this.fieldname;var selector='#'+fieldname,reverseLx=this.options.reverseLx;var mapWrapper=$(selector+'_map_icon__row .map_wrapper');mapWrapper.attr('id',this.fieldname+'_map_wrapper');var formRow=$(selector+'__row'),errorWrapper=this.input.next('.error_wrapper'),mapIconRow=$(selector+'_map_icon__row'),L0Row=$(selector+'_L0__row'),postcodeRow=$(selector+'_postcode__row');if(formRow.is('.control-group, .form-row')){var L1Row=$(selector+'_L1__row'),L2Row=$(selector+'_L2__row'),L3Row=$(selector+'_L3__row'),L4Row=$(selector+'_L4__row'),L5Row=$(selector+'_L5__row'),addressRow=$(selector+'_address__row'),latRow=$(selector+'_lat__row'),lonRow=$(selector+'_lon__row'),latlonToggleRow=$(selector+'_latlon_toggle__row');if(reverseLx){formRow.hide().after(mapWrapper).after(mapIconRow).after(latlonToggleRow).after(lonRow).after(latRow).after(L0Row).after(L1Row).after(L2Row).after(L3Row).after(L4Row).after(L5Row).after(postcodeRow).after(addressRow).after(errorWrapper);}else{formRow.hide().after(mapWrapper).after(mapIconRow).after(latlonToggleRow).after(lonRow).after(latRow).after(postcodeRow).after(addressRow).after(L5Row).after(L4Row).after(L3Row).after(L2Row).after(L1Row).after(L0Row).after(errorWrapper);}}else if(formRow.parent().is('.inline-form')){formRow.show();}else{$(selector+'__row1').hide();formRow.hide().after(errorWrapper);mapIconRow.detach();var lastRow=formRow.siblings('[id^="'+fieldname+'"][id$="__row"]').last();if(reverseLx){lastRow.after(mapWrapper).after(mapIconRow);}else{lastRow.after(mapWrapper).after(mapIconRow);}}
if(errorWrapper.length){errorWrapper.one('click'+this.eventNamespace,function(){var $this=$(this);$this.fadeOut('slow',function(){$this.remove();});});}},_lxSelectFinal:function(refresh){if(!refresh){this._collectData();}else{this._serialize();}
this._zoomMap();},_lxSelect:function(level,id,refresh){var selector='#'+this.fieldname,opts=this.options,dropdown=$(selector+'_L'+level),s,l;if(id){dropdown.val(id).trigger('change','implicit');if(dropdown.hasClass('multiselect')&&dropdown.multiselect('instance')){dropdown.multiselect('refresh');}}else{id=parseInt(dropdown.val(),10);}
if(level===0){var labelled=this._readLabels(id),defaultLabels=hierarchyLabels.d,levels=['1','2','3','4','5'],label,labelHTML,i;labelled.then(function(labels){for(i=0;i<5;i++){l=levels[i];label=labels[l]||defaultLabels[l];s=selector+'_L'+l;dropdown=$(s);if(opts.showLabels){if(dropdown.hasClass('required')){labelHTML='<div>'+label+':<span class="req"> *</span></div>';}else{labelHTML=label+':';}}else{labelHTML='';}
$(s+'__row label').html(labelHTML);$(s+'__row1 label').html(labelHTML);$(s+' option[value=""]').html(i18n.select+' '+label);if(dropdown.hasClass('multiselect')&&dropdown.multiselect('instance')){dropdown.multiselect('refresh');}}});}
var hideLx=opts.hideLx;for(l=level+1;l<6;l++){s=selector+'_L'+l;if(hideLx){$(s+'__row').hide();$(s+'__row1').hide();}else{$(s+' option').remove('[value != ""]');}
$(s).val('').trigger('change','implicit');}
if(id){var missing=false,next=level+1,dropdown_row=$(selector+'_L'+next+'__row');if(!dropdown_row.length){missing=true;next++;dropdown_row=$(selector+'_L'+next+'__row');}
if(!dropdown_row.length){if(this.useGeocoder&&!refresh){this._geocodeDecision();}
this._lxSelectFinal(refresh);}else{var locations,location,locationID,read=false,that=this;if($(selector+'_L'+level+' option[value="'+id+'"]').hasClass('missing')){location=hierarchyLocations[id];location.i=id;locations=[location];}else{locations=[];read=true;for(locationID in hierarchyLocations){if(hierarchyLocations[locationID].f==id){read=false;break;}}}
var reading=this._readHierarchy(read,id,next,missing);reading.then(function(){if(locations.length==0){for(locationID in hierarchyLocations){location=hierarchyLocations[locationID];if(location.f==id){location.i=locationID;locations.push(location);}}}
var numLocations=locations.length,selected,option;if(numLocations){locations.sort(function(a,b){return a.n.localeCompare(b.n);});var dropdownSelector=selector+'_L'+next,select=$(dropdownSelector),placeholder=$(dropdownSelector+' option[value=""]').html();$(dropdownSelector+' option').remove('[value != ""]');locationID=null;for(i=0;i<numLocations;i++){location=locations[i];locationID=location.i;if(id==locationID){selected=' selected="selected"';}else{selected='';}
if(location.l==next){missing='';}else{missing=' class="missing"';}
option='<option value="'+locationID+'"'+selected+missing+'>'+location.n+'</option>';select.append(option);}
dropdown_row.removeClass('hide').show();$(selector+'_L'+next+'__row1').removeClass('hide').show();if(select.hasClass('multiselect')){var multiSelectOptions={header:'',height:300,minWidth:0,selectedList:1,noneSelectedText:placeholder,multiple:false};if(select.hasClass('search')){select.multiselect(multiSelectOptions).multiselectfilter({label:'',placeholder:i18n.search});$('.ui-multiselect-header').show();}else{multiSelectOptions.header=false;select.multiselect(multiSelectOptions);}}
var previous=that.data['L'+next],available=locations.map(function(l){return l.i;});if(previous&&available.indexOf(''+previous)!=-1){that._lxSelect(next,previous,refresh);}else if(numLocations==1&&locationID){that._lxSelect(next,locationID,refresh);}}
that._lxSelectFinal(refresh);});}}else{this._lxSelectFinal(refresh);}},_collectData:function(mapInput){var data=this.data,selector='#'+this.fieldname,parent=this._lookupParent();var address=$(selector+'_address').val(),postcode=$(selector+'_postcode').val();data.address=address;data.postcode=postcode;if(data.specific){data.id=data.specific;data.parent=parent;}else{var lat=data.lat,lon=data.lon,wkt=data.wkt;if(!address&&!postcode&&!lat&&!lon&&!wkt){data.id=parent;data.parent=null;}else{data.id=null;data.parent=parent;}}
this._serialize();$(selector+'_lat').val(data.lat).trigger('setvalue');$(selector+'_lon').val(data.lon).trigger('setvalue');this.input.data('input',this._hasData());if(this.fieldname.slice(0,4)=='sub_'){this.input.trigger('change',mapInput&&'user'||'implicit');}},_collectLx:function(){var data=this.data,selector='#'+this.fieldname,dropdown,level,value;for(level=0;level<6;level++){dropdown=$(selector+'_L'+level);if(dropdown.length){value=dropdown.val();if(value){data['L'+level]=parseInt(value,10);}else{data['L'+level]=null;}}}
this._serialize();},_hasData:function(){var data=this.data,hasData=false;if(data.specific||data.address||data.postcode||data.lat||data.lon||data.wkt){hasData=true;}else{var L0=data.L0,L1=data.L1,L2=data.L2,L3=data.L3,L4=data.L4,L5=data.L5;var lx=[L0,L1,L2,L3,L4,L5].join('|');if(lx!=this.lx){hasData=true;}}
return hasData;},_lookupParent:function(){this._collectLx();var data=this.data,parent;for(var level=5;level>-1;level--){parent=data['L'+level];if(parent){return parent;}}
var defaultLocation=hierarchyLocations.d;if(defaultLocation){return defaultLocation.i;}
return null;},_readLabels:function(id){if(!id){id='d';}
var dfd=$.Deferred();var labels=hierarchyLabels[id];if(labels==undefined){var url=S3.Ap.concat('/gis/hdata/'+id);$.ajaxS3({url:url,dataType:'json',success:function(data){labels={};try{for(var prop in data){labels[prop]=data[prop];}
hierarchyLabels[id]=labels;}catch(e){}
dfd.resolve(labels);},error:function(request,status,error){var msg;if(error=='UNAUTHORIZED'){msg=i18n.gis_requires_login;}else{msg=request.responseText;}
if(msg){s3_debug(msg);}
dfd.reject();}});}else{dfd.resolve(labels);}
return dfd.promise();},_readHierarchy:function(read,parent,level,missing){var key=''+parent+';'+level+';'+missing,promise=hierarchyReads[key];if(promise!==undefined){return promise;}
var dfd=$.Deferred();if(read){var selector='#'+this.fieldname;var dropdown=$(selector+'_L'+level),multiselect=false;dropdown.hide();if(dropdown.hasClass('multiselect')){multiselect=true;var button=$(selector+'_L'+level+'__row button').hide();}
var throbber=$(selector+'_L'+level+'__throbber').removeClass('hide').show();var url;if(missing){url=S3.Ap.concat('/gis/ldata/'+parent+'/'+level);}else{url=S3.Ap.concat('/gis/ldata/'+parent);}
$.ajaxS3({url:url,dataType:'json',success:function(data){for(var prop in data){hierarchyLocations[prop]=data[prop];}
throbber.hide();if(multiselect){button.removeClass('hide').show();}else{dropdown.removeClass('hide').show();}
dfd.resolve();},error:function(request,status,error){var msg;if(error=='UNAUTHORIZED'){msg=i18n.gis_requires_login;}else{msg=request.responseText;}
if(msg){s3_debug(msg);S3.showAlert(msg,'error');}
throbber.hide();if(multiselect){button.removeClass('hide').show();}else{dropdown.removeClass('hide').show();}
dfd.reject();}});}else{dfd.resolve();}
promise=hierarchyReads[key]=dfd.promise();return promise;},_geocodeDecision:function(){var selector='#'+this.fieldname,data=this.data;this._collectData();if(!data.address){return;}
var levels=['1','2','3','4','5'];for(var i=0,dropdown;i<5;i++){dropdown=$(selector+'_L'+levels[i]);if(dropdown.length&&!dropdown.val()){if(dropdown[0].options.length>1){return;}}}
$(selector+'_geocode .geocode_success,'+
selector+'_geocode .geocode_fail').hide();var self=this,ns=this.eventNamespace;if(this.input.data('manually_geocoded')){$(selector+'_geocode button').removeClass('hide').show().unbind(ns).bind('click'+ns,function(){$(this).hide();self._geocode();});}else{this._geocode();}},_geocode:function(){var fieldname=this.fieldname,self=this;var selector='#'+fieldname;var failure=$(selector+'_geocode .geocode_fail').hide(),success=$(selector+'_geocode .geocode_success').hide(),throbber=$(selector+'_geocode .throbber').removeClass('hide').show();var data=this.data,postData={address:data.address},keys=['postcode','L0','L1','L2','L3','L4','L5'];for(var i=0,k,v;i<7;i++){k=keys[i];v=data[k];if(v){postData[k]=v;}}
var url=S3.Ap.concat('/gis/geocode');$.ajaxS3({url:url,type:'POST',data:postData,dataType:'json',success:function(result){var lat=result.lat,lon=result.lon;if(lat||lon){data.lat=parseFloat(lat);data.lon=parseFloat(lon);self._collectData();var gis=S3.gis;if(gis.maps){var map=gis.maps['location_selector_'+fieldname];if(map){var draftLayer=map.s3.draftLayer;draftLayer.removeAllFeatures();var geometry=new OpenLayers.Geometry.Point(data.lon,data.lat);geometry.transform(gis.proj4326,map.getProjectionObject());var feature=new OpenLayers.Feature.Vector(geometry);draftLayer.addFeatures([feature]);self._zoomMap();}}
throbber.hide();success.html(i18n.address_mapped).removeClass('hide').show();}else{throbber.hide();failure.html(i18n.address_not_mapped).removeClass('hide').show();s3_debug(result);}},error:function(request,status,error){var msg;if(error=='UNAUTHORIZED'){msg=i18n.gis_requires_login;}else{msg=request.responseText;}
throbber.hide();failure.html(i18n.address_not_mapped).removeClass('hide').show();s3_debug(msg);}});},_geocodeReverse:function(){var fieldname=this.fieldname,self=this;var selector='#'+fieldname;var failure=$(selector+'_geocode .geocode_fail').hide(),success=$(selector+'_geocode .geocode_success').hide(),throbber=$(selector+'_geocode .throbber').removeClass('hide').show();var data=this.data;var postData={lat:data.lat,lon:data.lon};var url=S3.Ap.concat('/gis/geocode_r');$.ajaxS3({async:false,url:url,type:'POST',data:postData,dataType:'json',success:function(result){if(result.L0){self.useGeocoder=false;self._lxSelect(0,result.L0);if(result.L1){self._lxSelect(1,result.L1);}
if(result.L2){self._lxSelect(2,result.L2);}
if(result.L3){self._lxSelect(3,result.L3);}
if(result.L4){self._lxSelect(4,result.L4);}
if(result.L5){self._lxSelect(5,result.L5);}
self.useGeocoder=true;throbber.hide();success.html(i18n.location_found).removeClass('hide').show();}else{throbber.hide();failure.html(i18n.location_not_found).removeClass('hide').show();}},error:function(request,status,error){var msg;if(error=='UNAUTHORIZED'){msg=i18n.gis_requires_login;}else{msg=request.responseText;}
throbber.hide();failure.html(i18n.location_not_found).removeClass('hide').show();s3_debug(msg);}});},_latlonInput:function(){var fieldname=this.fieldname,data=this.data;var selector='#'+fieldname;var lat=$(selector+'_lat').val(),lon=$(selector+'_lon').val();if(!lat&&!lon){data.lat=null;data.lon=null;if(!data.wkt){this.input.data('manually_geocoded',false);}}else{if(!lat){lat=0;}else{lat=parseFloat(lat);}
if(!lon){lon=0;}else{lon=parseFloat(lon);}
data.lat=lat;data.lon=lon;data.wkt=null;this.input.data('manually_geocoded',true);}
this._serialize();var gis=S3.gis;if(gis.maps){var map=gis.maps['location_selector_'+fieldname];if(map){var draftLayer=map.s3.draftLayer;draftLayer.removeAllFeatures();if(data.lat!==null&&data.lon!==null){var geometry=new OpenLayers.Geometry.Point(data.lon,data.lat);geometry.transform(gis.proj4326,map.getProjectionObject());var feature=new OpenLayers.Feature.Vector(geometry);draftLayer.addFeatures([feature]);map.s3.lastDraftFeature=feature;}
this._zoomMap();}}},_showMap:function(event){var fieldname=this.fieldname,ns=this.eventNamespace,self=this;var selector='#'+fieldname;$(selector+'_map_icon').unbind(ns).bind('click'+ns,function(){self._hideMap();});$(selector+'_map_icon span').html(i18n.hide_map);var map_wrapper=$(selector+'_map_wrapper').hide().removeClass('hide').slideDown('medium');if(map_wrapper.length&&event){$('html,body').animate({scrollTop:map_wrapper.offset().top},250);}
var realInput=this.input;$.when(this._jsLoaded()).then(function(){var gis=S3.gis,map_id='location_selector_'+fieldname,map;if(!gis.maps[map_id]){map=gis.show_map(map_id);}else{map=gis.maps[map_id];}
self._zoomMap();var data=self.data;var lat=data.lat,lon=data.lon,wkt=data.wkt,feature,geometry;if(lat||lon||wkt){map.s3.draftLayer.removeAllFeatures();if((wkt!=undefined)&&wkt){var in_options={'internalProjection':map.getProjectionObject(),'externalProjection':gis.proj4326};feature=new OpenLayers.Format.WKT(in_options).read(wkt);}else{geometry=new OpenLayers.Geometry.Point(parseFloat(lon),parseFloat(lat));geometry.transform(gis.proj4326,map.getProjectionObject());feature=new OpenLayers.Feature.Vector(geometry);}
map.s3.draftLayer.addFeatures([feature]);map.s3.lastDraftFeature=feature;}
var controls=map.controls,control;for(var i=0,len=controls.length;i<len;i++){if(controls[i].CLASS_NAME=='OpenLayers.Control.DrawFeature'){control=controls[i];break;}}
if(control){map.s3.pointPlaced=function(feature){$(selector+'_geocode .geocode_fail').hide();$(selector+'_geocode .geocode_success').hide();var geometry=feature.geometry;if(geometry.CLASS_NAME=='OpenLayers.Geometry.Point'){var centerPoint=geometry.getBounds().getCenterLonLat();centerPoint.transform(map.getProjectionObject(),gis.proj4326);data.wkt=null;data.lat=centerPoint.lat;data.lon=centerPoint.lon;if(!data.address&&self.useGeocoder){self._geocodeReverse();}}else{var out_options={'internalProjection':map.getProjectionObject(),'externalProjection':gis.proj4326};data.radius=null;var linearRing=new OpenLayers.Geometry.LinearRing(feature.geometry.components[0].components);var polygon=new OpenLayers.Geometry.Polygon([linearRing]);if(polygon.getVertices().length==1000){var polygonFeature=new OpenLayers.Feature.Vector(polygon,null);var polygonBounds=polygonFeature.geometry.getBounds();var minX=polygonBounds.left;var minY=polygonBounds.bottom;var maxX=polygonBounds.right;var maxY=polygonBounds.top;var startX=(minX+maxX)/2;var startY=(minY+maxY)/2;var startPoint=new OpenLayers.Geometry.Point(startX,startY);var endPoint=new OpenLayers.Geometry.Point(maxX,startY);var radius=new OpenLayers.Geometry.LineString([startPoint,endPoint]);var lengthMeter=parseFloat(radius.getLength());data.radius=lengthMeter;}
wkt=new OpenLayers.Format.WKT(out_options).write(feature);data.wkt=wkt;data.lat=null;data.lon=null;}
realInput.data('manually_geocoded',true);self._collectData(true);self._removeErrors();if(fieldname.substring(0,4)=='sub_'){realInput.parent().find('div.map_wrapper').trigger('change');}};}},function(status){s3_debug(status);},function(status){s3_debug(status);});},_hideMap:function(){var fieldname=this.fieldname,ns=this.eventNamespace;var selector='#'+fieldname;var self=this;$(selector+'_map_icon').unbind(ns).bind('click'+ns,function(e){self._showMap(e);});$(selector+'_map_wrapper').slideUp('medium');var data=this.data,iconLabel;if(data.specific){iconLabel=i18n.show_map_view;}else{iconLabel=i18n.show_map_add;if(S3.gis.maps){var map=S3.gis.maps['location_selector_'+fieldname];if(map){map.s3.draftLayer.removeAllFeatures();data.lat=null;data.lon=null;data.wkt=null;this.input.data('manually_geocoded',false);this._collectData();}}}
$(selector+'_map_icon span').html(iconLabel);},_zoomMap:function(id){var fieldname=this.fieldname;var gis=S3.gis;if(gis.maps){var map=gis.maps['location_selector_'+fieldname];if(map){var data=this.data;var lat=data.lat,lon=data.lon,wkt=data.wkt,bounds;if(lat&&lon){bounds=OpenLayers.Bounds.fromArray([lon,lat,lon,lat]);}else if(wkt){var vector=new OpenLayers.Feature.Vector(OpenLayers.Geometry.fromWKT(wkt));bounds=vector.geometry.getBounds();}else{if(!id){id=this._lookupParent()||'d';}
bounds=hierarchyLocations[id].b;if(!bounds||!bounds.length){var parent=hierarchyLocations[id].f,parentLocation,maxLevels=4;while(parent&&maxLevels){maxLevels--;parentLocation=hierarchyLocations[parent];bounds=parentLocation.b;if(bounds||parentLocation.l===0){break;}else{parent=parentLocation.f;}}}
if(bounds){bounds=OpenLayers.Bounds.fromArray(bounds);}}
if(bounds){S3.gis.zoomBounds(map,bounds,this.options.minBBOX);}}}},_validate:function(){var fieldname=this.fieldname;this._removeErrors();var selector='#'+fieldname,data=this.data,featureRequired=this.options.featureRequired;if(featureRequired){var valid=false;switch(featureRequired){case'latlon':valid=data.lat||data.lon;break;case'wkt':valid=data.wkt;break;default:valid=data.lat||data.lon||data.wkt;break;}
if(!valid){S3.fieldError(selector+'_map_icon',i18n.map_feature_required);return false;}}
var current_value=data.id,suffix=['address','L5','L4','L3','L2','L1','L0'],i,s,f,visible=function(field){if(field.hasClass('multiselect')){return field.next('button.ui-multiselect').is(':visible');}else{return field.is(':visible');}};if(current_value){if(!hierarchyLocations[current_value]){return true;}
var current_level=hierarchyLocations[current_value].l;for(i=0;i<6-current_level;i++){s=selector+'_'+suffix[i];f=$(s);if(f.length&&f.hasClass('required')&&visible(f)){S3.fieldError(s,i18n.enter_value);return false;}}
return true;}else{if(data.lat||data.lon||data.wkt||data.address||data.postcode){return true;}
for(i=0;i<7;i++){s=selector+'_'+suffix[i];f=$(s);if(f.length&&f.hasClass('required')&&visible(f)){S3.fieldError(s,i18n.enter_value);return false;}}
return true;}},_serialize:function(){var json=JSON.stringify(this.data);this.input.val(json);return json;},_deserialize:function(){var value=this.input.val();this.data=JSON.parse(value);return this.data;},_storeHierarchyData:function(labels,locations){var locationID;if(locations){for(locationID in locations){hierarchyLocations[locationID]=locations[locationID];}}
if(labels){for(locationID in labels){hierarchyLabels[locationID]=labels[locationID];}}},_jsLoaded:function(){var dfd=new jQuery.Deferred();setTimeout(function working(){if(S3.gis.maps!=undefined){dfd.resolve('loaded');}else if(dfd.state()==='pending'){dfd.notify('waiting for JS to load...');setTimeout(working,500);}else{}},1);return dfd.promise();},_removeErrors:function(element){if(!element){var selector='#'+this.fieldname;element=selector+'_L0,'+
selector+'_L1,'+
selector+'_L2,'+
selector+'_L3,'+
selector+'_L4,'+
selector+'_L5,'+
selector+'_address,'+
selector+'_postcode,'+
selector+'_map_icon';}
$(element).siblings('.error').remove();},_bindEvents:function(){var fieldname=this.fieldname,ns=this.eventNamespace,self=this;var selector='#'+fieldname;$(selector+'_L0').bind('change'+ns,function(){self._removeErrors(this);self._lxSelect(0);});$(selector+'_L1').bind('change'+ns,function(){self._removeErrors(this);self._lxSelect(1);});$(selector+'_L2').bind('change'+ns,function(){self._removeErrors(this);self._lxSelect(2);});$(selector+'_L3').bind('change'+ns,function(){self._removeErrors(this);self._lxSelect(3);});$(selector+'_L4').bind('change'+ns,function(){self._removeErrors(this);self._lxSelect(4);});$(selector+'_L5').bind('change'+ns,function(){self._removeErrors(this);self._lxSelect(5);});$(selector+'_address,'+
selector+'_postcode').bind('change'+ns,function(){self._removeErrors(this);if(self.useGeocoder){self._geocodeDecision();}else{self._collectData();}});$(selector+'_lat,'+
selector+'_lon').bind('change'+ns,function(){self._latlonInput();});$(selector+'_latlon_toggle').bind('click'+ns,function(){var mode=$(this).data('mode')||self.options.latlonMode,label;if(mode=='dms'){mode='decimal';label=i18n.latlon_mode.dms;}else{mode='dms';label=i18n.latlon_mode.decimal;}
$(selector+'_lat').latloninput('option',{mode:mode});$(selector+'_lon').latloninput('option',{mode:mode});$(this).html(label).data('mode',mode);});if(fieldname.substring(0,4)=='sub_'){var inlineForm=this.input.closest('.inline-form');inlineForm.bind('validate'+ns+this.id,function(e){if(!self._validate()){e.preventDefault();}});}else{var form=this.input.closest('form');form.bind('submit'+ns+this.id,function(e){e.preventDefault();if(self._validate()){form.unbind(ns+self.id).submit();}});}
return true;},_unbindEvents:function(){var selector='#'+this.fieldname,ns=this.eventNamespace;$(selector+'_L0,'+
selector+'_L1,'+
selector+'_L2,'+
selector+'_L3,'+
selector+'_L4,'+
selector+'_L5,'+
selector+'_address,'+
selector+'_postcode,'+
selector+'_map_icon,'+
selector+'_latlon_toggle').unbind(ns);this.input.next('.error_wrapper').unbind(ns);this.input.closest('form').unbind(ns+this.id);return true;}});})(jQuery);(function($,undefined){"use strict";var latloninputID=0;$.widget('s3.latloninput',{options:{type:'lat',mode:'decimal',labels:{deg:'°',min:"'",sec:'"'}},_create:function(){this.id=latloninputID;latloninputID+=1;this.eventNamespace='.latloninput';},_init:function(){$(this.element).hide();this.refresh();},_destroy:function(){$(this.element).show();$.Widget.prototype.destroy.call(this);},_setOption:function(key,value){this._super(key,value);if(key=='mode'){this.refresh();}},refresh:function(){this._unbindEvents();var el=$(this.element),opts=this.options;this.defaultValue=el.val();if(!this.input){var input=$('<div>').hide().insertAfter(el);var decimalInput=$('<input type="text" class="dms-input" size="18">').hide();this.decimalInput=decimalInput;var labels=opts.labels;var degInput=$('<input type="text" class="integer dms-input" size="5">'),degLabel=$('<span class="dms-label">'+labels.deg+'</span>'),minInput=$('<input type="text" class="integer dms-input" size="5">'),minLabel=$('<span class="dms-label">'+labels.min+'</span>'),secInput=$('<input type="text" class="double dms-input" size="8">'),secLabel=$('<span class="dms-label">'+labels.sec+'</span>');this.degInput=degInput;this.minInput=minInput;this.secInput=secInput;var dmsInput=$('<span>').append(degInput).append(degLabel).append(minInput).append(minLabel).append(secInput).append(secLabel).hide();this.dmsInput=dmsInput;this.input=input.append(decimalInput).append(dmsInput).show();}
this._removeErrors();if(opts.mode=='dms'){var dms=this._getDMS();this.degInput.val(dms.d);this.minInput.val(dms.m);this.secInput.val(dms.s);this.decimalInput.hide();this.dmsInput.show();}else{this.decimalInput.val(el.val());this.dmsInput.hide();this.decimalInput.show();}
this._bindEvents();},_getDMS:function(){var value=$(this.element).val();if(isNaN(parseFloat(value))||!isFinite(value)){return{d:'',m:'',s:''};}
var d=Math.abs(value),m=(d-parseInt(d,10))*60,s;if(Math.abs(m-Math.round(m))<1e-10){m=Math.round(m);s=0;}else{s=(m-parseInt(m,10))*60;if(Math.abs(s-Math.round(s))<1e-10){s=Math.round(s);}}
return{d:parseInt(value,10),m:parseInt(m,10),s:s};},_showError:function(field,message){if(field=='all'){this.input.find('input').addClass('invalidinput');}else if(field){field.addClass('invalidinput');}
if(message){this.input.append('<div class="error">'+message+'</div>');}},_removeErrors:function(){this.input.find('input').removeClass('invalidinput');this.input.find('.error').remove();},_validateDMS:function(){this._removeErrors();var type=this.options.type,range,rangeError;if(type=='lat'){range=90;rangeError=i18n.latlon_error.lat;}else{range=180;rangeError=i18n.latlon_error.lon;}
var deg=this.degInput.val(),min=this.minInput.val(),sec=this.secInput.val(),errors=[];if(deg===''&&min===''&&sec===''){return'';}
deg=parseInt(deg,10)||0;min=parseInt(min,10)||0;sec=parseFloat(sec)||0;if(Math.abs(min)>=60){this._showError(this.minInput);errors.push(i18n.latlon_error.min);}
if(Math.abs(sec)>=60){this._showError(this.secInput);errors.push(i18n.latlon_error.sec);}
var total=Math.abs(deg)+min/60+sec/3600;if(!errors.length&&total>range||deg>range){this._showError('all');errors.push(rangeError);}
if(errors.length){this._showError(null,errors.join(', '));return null;}
return(deg<0?-1:1)*total;},_validateDecimal:function(){this._removeErrors();var type=this.options.type,range,rangeError,formatError=i18n.latlon_error.format;if(type=='lat'){range=90;rangeError=i18n.latlon_error.lat;}else{range=180;rangeError=i18n.latlon_error.lon;}
var decimal=this.decimalInput.val();if(decimal===''){return'';}
decimal=this._parse(decimal,type);if(decimal===null){this._showError(this.decimalInput,formatError);}else if(Math.abs(decimal)>range){this._showError(this.decimalInput,rangeError);decimal=null;}
return decimal;},_parse:function(value,mode){var directions;if(mode=='lat'){directions={'N':1,'S':-1};}else{directions={'E':1,'W':-1};}
var DEG_REGEX=/^([NSEW]{0,1})\s*([-+]?\d+[.,]?\d*)\s*°?\s*([NSEW])?\s*$/,DMS_REGEX=/^([NSEW]{0,1})\s*([-+]?\d+[.,]?\d*)?\s*([°'"]{0,1})\s*:?\s*([-+]?\d+[.,]?\d*)?\s*(['"]{0,1})\s*:?\s*([-+]?\d+[.,]?\d*)?\s*(['"]{0,1})\s*([NSEW])?\s*$/,match,direction,degrees=0,minutes=0,seconds=0;if(value.match(DEG_REGEX)){match=value.replace(DEG_REGEX,"$1|$2|$3").split('|');direction=match[0]||match[2];if(direction){direction=directions[direction];}
degrees=parseFloat(match[1]);if(direction&&Math.abs(degrees)!=degrees){direction=null;}
if(direction){degrees*=direction;}
return degrees;}else if(value.match(DMS_REGEX)){match=value.replace(DMS_REGEX,"$1|$2|$3|$4|$5|$6|$7|$8").split('|');direction=match[0]||match[7];if(direction){direction=directions[direction];}
var numbers=[],symbols=[],n,s,i;for(i=1;i<6;i+=2){n=match[i];s=match[i+1];if(s){numbers.push(parseFloat(n)||0);symbols.push(s);}else if(n){numbers.push(parseFloat(n));symbols.push(null);}}
var DEGREES='°',MINUTES="'",SECONDS='"',len=numbers.length;if(!len){return null;}else{for(i=1;i<len;i++){numbers[i]=Math.abs(numbers[i]);}
n=numbers[0];if(Math.abs(n)!=n){direction=1;}
if(len==1){s=symbols[0];if(s==SECONDS){seconds=numbers[0];}else if(s==MINUTES){minutes=numbers[0];}else if(!s||s==DEGREES){degrees=numbers[0];}}else if(len==2){var s0=symbols[0],s1=symbols[1];if(s0==DEGREES){degrees=numbers[0];if(s1==SECONDS){seconds=numbers[1];}else if(s1==MINUTES||!s1){minutes=numbers[1];}}else if(!s0){if(s1==SECONDS){minutes=numbers[0];seconds=numbers[1];}else if(s1==MINUTES||!s1){degrees=numbers[0];minutes=numbers[1];}}else if(s0==MINUTES&&(!s1||s1==SECONDS)){minutes=numbers[0];seconds=numbers[1];}else{return null;}}else{if((!symbols[0]||symbols[0]==DEGREES)&&(!symbols[1]||symbols[1]==MINUTES)&&(!symbols[2]||symbols[2]==SECONDS)){degrees=numbers[0];minutes=numbers[1];seconds=numbers[2];}else{return null;}}
var decimal=degrees+minutes/60+seconds/3600;if(direction){decimal*=direction;}
return decimal;}}
return null;},_bindEvents:function(){var self=this,ns=this.eventNamespace;this.dmsInput.find('input').bind('change'+ns,function(){var value=self._validateDMS();if(value!==null){$(self.element).val(value).change();}else{$(self.element).val(self.defaultValue).change();}});this.decimalInput.bind('change'+ns,function(){var value=self._validateDecimal();if(value!==null){$(self.element).val(value).change();self.decimalInput.val(value);}else{$(self.element).val(self.defaultValue).change();}});$(this.element).bind('setvalue'+ns,function(){self.refresh();});return true;},_unbindEvents:function(){var ns=this.eventNamespace;if(this.input){this.input.find('input').unbind(ns);}
$(this.element).unbind(ns);return true;}});})(jQuery);