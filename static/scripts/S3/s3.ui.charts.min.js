(function($,undefined){"use strict";var uiChartID=0;$.widget('s3.uiChart',{options:{height:'280px',colors:null,transition:50,staggerLabels:true,valueFormat:',.0f'},_create:function(){this.id=uiChartID;uiChartID+=1;this.eventNamespace='.uiChart';},_init:function(){this.refresh();},_destroy:function(){$.Widget.prototype.destroy.call(this);},refresh:function(){var el=$(this.element),opts=this.options;this._unbindEvents();el.empty().css({height:opts.height});var container=d3.select(el.get(0)).append('svg').attr('class','nv'),chart;switch(el.data('type')){case'piechart':chart=this._pieChart(container);break;case'barchart':chart=this._barChart(container);break;case'multibarchart':chart=this._multiBarChart(container);break;default:break;}
this._bindEvents();},_getData:function(callback){var el=$(this.element),dataSource=el.data('source');if(dataSource){$.ajaxS3({'url':dataSource,'dataType':'json','type':'GET','ignoreStatus':[404],'success':function(data){callback(data);},'error':function(jqXHR,textStatus,errorThrown){callback([]);var msg;if(errorThrown=='UNAUTHORIZED'){msg=i18n.gis_requires_login;}else{msg=jqXHR.responseText;}
console.log(msg);}});}},_barChart:function(container){var el=$(this.element),opts=this.options;var chart=nv.models.discreteBarChart().duration(opts.transition).x(function(d){return d.label;}).y(function(d){return d.value;}).staggerLabels(opts.staggerLabels).showValues(true);var valueFormat=d3.format(opts.valueFormat);chart.yAxis.tickFormat(valueFormat);chart.valueFormat(valueFormat);if(opts.colors){chart.color(opts.colors);}
var dataURL=el.data('url'),itemAxis=el.data('items');var self=this;nv.addGraph(function(){self._getData(function(data){container.datum(data).call(chart);chart.update();nv.utils.windowResize(chart.update);if(dataURL&&itemAxis){chart.discretebar.dispatch.on('elementClick',function(e){var linkParams={},filterKey=e.data.filterKey;linkParams[itemAxis]=filterKey;var linkURL=self._updateURL(dataURL,linkParams);window.open(linkURL,'_blank');});}});});return chart;},_multiBarChart:function(container){var el=$(this.element),opts=this.options;var chart=nv.models.multiBarChart().duration(opts.transition).x(function(d){return d.label;}).y(function(d){return d.value;}).reduceXTicks(false).staggerLabels(opts.staggerLabels).stacked(true).groupSpacing(0.1);var valueFormat=d3.format(opts.valueFormat);chart.yAxis.tickFormat(valueFormat);if(el.data('controls')=='off'){chart.showControls(false);}
if(el.data('legend')=='off'){chart.showLegend(false);}
if(opts.colors){chart.color(opts.colors);}
var dataURL=el.data('url'),itemAxis=el.data('items');var self=this;nv.addGraph(function(){self._getData(function(data){container.datum(data).call(chart);chart.update();nv.utils.windowResize(chart.update);if(dataURL&&itemAxis){var seriesAxis=el.data('series');chart.multibar.dispatch.on('elementClick',function(e){var linkParams={},filterKey=e.data.filterKey;linkParams[itemAxis]=filterKey;if(seriesAxis){var seriesKey=e.element.parentElement.__data__.filterKey;linkParams[seriesAxis]=seriesKey;}
var linkURL=self._updateURL(dataURL,linkParams);window.open(linkURL,'_blank');});}});});return chart;},_updateURL:function(url,params){var anchor=document.createElement('a');anchor.href=url;var queries=[];for(var selector in params){queries.push(encodeURIComponent(selector)+'='+encodeURIComponent(params[selector]));}
if(queries.length){if(anchor.search){anchor.search+=queries.join('&');}else{anchor.search='?'+queries.join('&');}}
return anchor.href;},_pieChart:function(container){var el=$(this.element),opts=this.options;var showLegend=el.data('legend')!='off',showLabels=el.data('labels'),labelType=el.data('labeltype'),labelThreshold=0.05,labelsOutside=true;if(!labelType){if(showLegend){labelType='percent';}else{labelType='key';}}
switch(showLabels){case'off':showLabels=false;break;case'outside':showLabels=true;if(showLegend){if(labelType=='percent'||labelType=='value'){labelThreshold=0.03;}else{labelThreshold=0.20;}}
break;default:showLabels=true;labelsOutside=false;if(showLegend){if(labelType!='percent'&&labelType!='value'){labelThreshold=0.25;}}else{labelThreshold=0.10;}
break;}
var chart=nv.models.pieChart().duration(opts.transition).x(function(d){return d.label;}).y(function(d){return d.value;}).showLabels(showLabels).labelType(labelType).showLegend(showLegend).labelsOutside(labelsOutside).labelThreshold(labelThreshold).showTooltipPercent(true);var valueFormat=d3.format(opts.valueFormat);chart.valueFormat(valueFormat);if(opts.colors){chart.color(opts.colors);}
var dataURL=el.data('url'),itemAxis=el.data('items');var self=this;nv.addGraph(function(){self._getData(function(data){container.datum(data).call(chart);chart.update();nv.utils.windowResize(chart.update);if(dataURL&&itemAxis){chart.pie.dispatch.on('elementClick',function(e){var linkParams={},filterKey=e.data.filterKey;linkParams[itemAxis]=filterKey;var linkURL=self._updateURL(dataURL,linkParams);window.open(linkURL,'_blank');});}});});return chart;},_bindEvents:function(){return true;},_unbindEvents:function(){return true;}});})(jQuery);