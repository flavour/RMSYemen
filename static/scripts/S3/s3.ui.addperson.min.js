(function($,undefined){"use strict";var updateURLQuery=function(url,queries){var encode=function(key,value){if(value){return encodeURIComponent(key)+'='+encodeURIComponent(value);}else{return'';}};var urlParts=url.split('?');urlParts=[urlParts[0]].concat(urlParts[1].split('#'));var query=urlParts[1],key,getVars,replaced={},q;if(query){getVars=query.split('&').map(function(param){key=decodeURIComponent(param.split('=')[0]);if(queries.hasOwnProperty(key)){replaced[key]=true;return encode(key,queries[key]);}else{return param;}}).filter(function(p){return p;});}else{getVars=[];}
for(key in queries){if(!replaced[key]){q=encode(key,queries[key]);if(q){getVars.push(q);}}}
var newUrl=urlParts[0];if(getVars.length){newUrl+='?'+getVars.join('&');}
if(urlParts[2]){newUrl+='#'+urlParts[2];}
return newUrl;};S3.addPersonWidgetReady=function(fieldID){var deferred=new jQuery.Deferred(),input=$('#'+fieldID);if(input.data('lookup_contact')!==undefined){deferred.resolve(input);}else{input.on('addPersonReady',function(){deferred.resolve(input);});}
return deferred.promise();};var addPersonID=0;$.widget('s3.addPerson',{options:{lookupDuplicates:false,separateNameFields:false,trigger:'full_name',c:'pr',f:'person',chars:2,delay:800,downIcon:'fa fa-caret-down',yesIcon:'fa fa-check',noIcon:'fa fa-remove'},_create:function(){this.id=addPersonID;addPersonID+=1;this.eventNamespace='.addPerson';},_init:function(){var el=$(this.element),opts=this.options,fieldName=el.attr('id');this.fieldName=fieldName;this.selector='#'+fieldName;this.data={};var realRow=$(this.selector+'__row').hide();if(realRow.hasClass('form-row')||realRow.hasClass('control-group')){this.formStyle='div';}else{this.formStyle='table';}
this.topFields=['organisation_id','pe_label'];var idLabel=$(this.selector+'_pe_label');if(idLabel.length){this.idLabel=idLabel;}
var triggerName=opts.trigger,nameFields;if(opts.separateNameFields){if(triggerName=='first_name'){nameFields=['first_name','middle_name','last_name'];}else{triggerName='last_name';nameFields=['last_name','middle_name','first_name'];}}else{triggerName='full_name';nameFields=['full_name'];}
opts.trigger=triggerName;this.triggerRow=$(this._rowSelector(triggerName));this.trigger=$(this.selector+'_'+triggerName);this.nameFields=nameFields;this.personFields=['father_name','grandfather_name','year_of_birth','date_of_birth','gender','occupation','mobile_phone','home_phone','email'];this._arrangeFormRows();this.refresh();},_destroy:function(){$.Widget.prototype.destroy.call(this);},refresh:function(){var el=$(this.element),selector=this.selector,opts=this.options;this._unbindEvents();this.pendingAC=false;var throbber=this.throbber;if(throbber){throbber.remove();}
throbber=$('<div class="throbber input_throbber"></div>');throbber.hide().insertAfter(this.trigger);this.throbber=throbber;var idLabel=this.idLabel;if(idLabel){throbber=$('<div class="throbber input_throbber"></div>');throbber.hide().insertAfter(idLabel);this.idLabelThrobber=throbber;}
var value=el.val();if(value){if(!isNaN(value-0)){this.data={'id':value};this._serialize();}
if(this.data.id){this._disableInputs();this._toggleActions({cancel:false});}else{this._enableAutocomplete();this._toggleActions({edit:false});}}else{this._serialize();this._enableAutocomplete();this._toggleActions({edit:false});}
$(selector+'_edit_bar').removeClass('hide').show();if(opts.lookupDuplicates){var resultsID=this.fieldName+'_duplicates';if(!$('#'+resultsID).length){var results='<div id="'+resultsID+'" class="req"></div>';if(this.formStyle=='div'){$(selector+'_box_bottom').before(results);}else{$(selector+'_box_bottom1').before(results);}}}
this._bindEvents();el.trigger('addPersonReady');},_arrangeFormRows:function(){var el=$(this.element),selector=this.selector,realRow=$(selector+'__row').hide(),formStyle=this.formStyle;if(formStyle=='div'){$(selector+'_box_bottom').removeClass('hide').show().insertAfter(realRow);var self=this,allFields=this.topFields.concat(this.nameFields).concat(this.personFields).reverse();allFields.forEach(function(fieldName){realRow.after($(self._rowSelector(fieldName)));});$(allFields.map(this._rowSelector,this).join(',')).removeClass('hide').show();}else{$(selector+'__row1').hide();}
var titleRow=$(selector+'_title__row'),errorWrapper=el.next('.error_wrapper');realRow.after(errorWrapper).after(titleRow.removeClass('hide').show());},_allFields:function(){return this.topFields.concat(this.nameFields).concat(this.personFields);},_fieldMap:function(){var map={'pe_label':'pe_label','email':'email','mobile_phone':'mphone','home_phone':'hphone','gender':'sex','date_of_birth':'dob','year_of_birth':'year_of_birth','father_name':'father_name','grandfather_name':'grandfather_name','occupation':'occupation','organisation_id':'org_id'};if(this.options.separateNameFields){map.first_name='first_name';map.middle_name='middle_name';map.last_name='last_name';}
return map;},_rowSelector:function(fieldName){return this.selector+'_'+fieldName+'__row';},_readInputs:function(){var selector=this.selector,data={},field;this._allFields().forEach(function(fieldName){field=$(selector+'_'+fieldName);if(field.length){data[fieldName]=field.val();}});this.data=data;},_updateInputs:function(){var selector=this.selector,data=this.data,field;this._allFields().forEach(function(fieldName){field=$(selector+'_'+fieldName);if(field.length&&data.hasOwnProperty(fieldName)){field.val(data[fieldName]);}});},_serialize:function(){$(this.element).val(JSON.stringify(this.data));},_deserialize:function(){var value=$(this.element).val(),personID=value-0,data;if(isNaN(personID)){data=JSON.parse(value);}else{data={'id':personID};}
this.data=data;},_toggleActions:function(visibility){var selectors={edit:'.edit-action',cancel:'.cancel-action'},selector=this.selector,action,actionItem;for(action in visibility){actionItem=$(selector+'_edit_bar '+selectors[action]);if(visibility[action]){actionItem.removeClass('hide').show();}else{actionItem.hide();}}},_toggleDatePickerTrigger:function(visibility){var clearBtn=$(this.selector+'_date_of_birth__row .calendar-clear-btn'),trigger=$(this.selector+'_date_of_birth__row .ui-datepicker-trigger');if(visibility){trigger.removeClass('hide').show();clearBtn.removeClass('hide').show();}else{trigger.hide();clearBtn.hide();}},_enableInputs:function(){var selector=this.selector,allFields=this._allFields();allFields.forEach(function(fieldName){$(selector+'_'+fieldName).prop('disabled',false);});this._toggleDatePickerTrigger(true);},_disableInputs:function(){var selector=this.selector,allFields=this._allFields();allFields.forEach(function(fieldName){$(selector+'_'+fieldName).prop('disabled',true);});this._toggleDatePickerTrigger(false);this._toggleActions({edit:true,cancel:false});},_reset:function(keepNames){var fieldNames=this.topFields.concat(this.personFields);if(!keepNames){fieldNames=fieldNames.concat(this.nameFields);}
var selector=this.selector;fieldNames.forEach(function(fieldName){$(selector+'_'+fieldName).prop('disabled',false).val('');});this._toggleDatePickerTrigger(true);if(keepNames){this._readInputs();}else{this.data={};}
this._serialize();},_edit:function(){this.previousSelection=$.extend({},this.data);this._reset();this._enableAutocomplete();this._toggleActions({edit:false,cancel:true});},_cancel:function(){var previous=this.previousSelection;if(this.pendingAC){this.pendingAC.abort();this.pendingAC=false;this.throbber.hide();}
if(previous&&Object.values(previous).length){this.data=$.extend({},this.previousSelection);this._serialize();this._updateInputs();this._disableInputs();}else{this._reset();}
this._clearDuplicates();},_clearError:function(){$(this.selector+'_title__row').next('.error_wrapper').fadeOut('slow',function(){S3.hideAlerts();});},_fullName:function(item){if(item.label!==undefined){return item.label;}
return item.name;},_autocompleteLabel:function(item){if(item.label!==undefined){return item.label;}
var label=item.name,details=[item.job,item.org].filter(function(s){return s;});if(details.length){label+=' ('+details.join(',')+')';}
if(this.idLabel){var pe_label=item.pe_label;if(pe_label){label+=' <span class="pe-label">['+pe_label+']</span> ';}}
return label;},_enableAutocomplete:function(){var trigger=this.trigger;if(trigger.attr('autocomplete')){return;}
var opts=this.options,self=this;this.acURL=S3.Ap.concat('/'+opts.c+'/'+opts.f+'/search_ac');if(this.idLabel){this.acURL+='?label=1';}
var acInstance=trigger.autocomplete({delay:opts.delay,minLength:opts.chars,source:function(request,response){if(self.pendingAC){self.pendingAC.abort();}
self.pendingAC=$.ajax({url:self.acURL,data:{term:request.term}}).done(function(data){if(data.length===0){delete self.data.id;}else{data.push({id:0,value:'',label:i18n.none_of_the_above});}
response(data);});},search:function(){self.throbber.show();return true;},response:function(event,ui,content){self.throbber.hide();return content;},focus:function(){return false;},select:function(event,ui){var item=ui.item;if(item.id){if(!opts.separateNameFields){trigger.val(self._fullName(item));}
self._selectPerson(item.id);}else{delete self.data.id;}
return false;}}).data('ui-autocomplete');if(acInstance){acInstance._renderItem=function(ul,item){var label=self._autocompleteLabel(item);return $('<li>').data('item.autocomplete',item).append('<a>'+label+'</a>').appendTo(ul);};}},_selectPerson:function(itemID){var opts=this.options;var selector=this.selector,triggerName=opts.trigger,field;this.nameFields.forEach(function(fieldName){field=$(selector+'_'+fieldName).prop('disabled',false);if(fieldName!=triggerName){field.val('');}});this._reset(true);var self=this,trigger=this.trigger,url=S3.Ap.concat('/'+opts.c+'/'+opts.f+'/'+itemID+'/lookup.json');if(this.idLabel){url+='?label=1';}
this.throbber.show();if(!trigger.val()){trigger.attr('placeholder',i18n.loading+'...');}
$.getJSONS3(url,function(data){try{self.data.id=itemID;if(!opts.separateNameFields){self.data.full_name=trigger.val();}
self._processReponse(data);}catch(e){self._reset(true);}
self.throbber.hide();trigger.removeAttr('placeholder');});},_processReponse:function(data){var fieldMap=this._fieldMap();var current=this.data,fieldName,propertyName;for(fieldName in fieldMap){propertyName=fieldMap[fieldName]||fieldName;if(data.hasOwnProperty(propertyName)){current[fieldName]=data[propertyName];}}
this._serialize();this.previousSelection=$.extend({},this.data);this._updateInputs();this._disableInputs();},lookupIDLabel:function(){var idLabel=this.idLabel;if(!idLabel){return;}
var value=idLabel.val();if(!value){return;}
var lookup=idLabel.data('lookup');if(lookup){lookup.abort();idLabel.data('lookup',null);}
var opts=this.options,getName="";if(!opts.separateNameFields){getName="&name=1";}
var self=this,throbber=this.idLabelThrobber.show(),url=S3.Ap.concat('/'+opts.c+'/'+opts.f+'/lookup.json?search=1&label=1'+getName+'&~.pe_label='+value);lookup=$.getJSONS3(url,function(data){if(data.pe_label){self.data.id=data.id;if(!opts.separateNameFields){self.data.full_name=data.name;}
self._processReponse(data);}
idLabel.data('lookup',null);throbber.hide();});idLabel.data('lookup',lookup);},lookupContact:function(siteID){this._reset();var opts=this.options,trigger=this.trigger,self=this,url=S3.Ap.concat('/org/site/'+siteID+'/site_contact_person');this.throbber.show();if(!trigger.val()){trigger.attr('placeholder',i18n.loading+'...');}
$.getJSONS3(url,function(data){try{self.data.id=data.id;if(!opts.separateNameFields){var name=data.name;trigger.val(name);self.data.full_name=name;}
self._processReponse(data);}catch(e){self._reset();}
self.throbber.hide();trigger.removeAttr('placeholder');});},_checkDuplicates:function(){var opts=this.options,map=this._fieldMap(),selector=this.selector,current=this.data,data={},value;if(current.id){return;}
if(opts.separateNameFields){if(!current.first_name){return;}
this.nameFields.forEach(function(fieldName){value=current[fieldName];if(value){data[map[fieldName]||fieldName]=value;}});}else{value=current.full_name;if(!value){return;}
data.name=value;}
this.personFields.forEach(function(fieldName){value=current[fieldName];if(value){data[map[fieldName]||fieldName]=value;}});var url=S3.Ap.concat('/pr/person/check_duplicates');$.ajaxS3({url:url,data:data,type:'POST',dataType:'json',success:function(data){$(selector+'_results').remove();if(data.length){var count=i18n.dupes_found.replace('_NUM_',data.length),result=count+' <i class="'+opts.downIcon+'"> </i>';$(selector+'_duplicates').html(result).data('results',data).show();}else{$(selector+'_duplicates').data('results',[]).hide();}}});},_displayDuplicates:function(){var opts=this.options,selector=this.selector;if($(selector+'_results').length){return;}
var cardLine=function(value,label){var line=$('<div>').addClass('card_1_line');if(label){line.append($('<label>').html(label));}
return line.append(value);};var cardButton=function(label,icon){var button=$('<button type="button" class="fright">');if(icon){button.append($('<i class="'+icon+'">'));}
return button.append(label);};var dupesCount=$(selector+'_duplicates'),items=dupesCount.data('results'),cardList=$('<div id="'+this.fieldName+'_results">'),card,name,picture,imagePath;items.forEach(function(item){name=item.name;card=$('<div class="dl-item">').data({'id':item.id,'name':name});picture=$('<img width="50" height="50" class="media-object">');if(item.image){imagePath='/default/download/'+item.image;}else{imagePath='/static/img/blank-user.gif';}
picture.attr('src',S3.Ap.concat(imagePath));card.append($('<a class="fleft">').append(picture));if(item.org){card.append(cardLine(item.org));}
card.append(cardLine(name));if(item.father_name&&i18n.father_name_label){card.append(cardLine(item.father_name,i18n.father_name_label));}
if(item.grandfather_name&&i18n.grandfather_name_label){card.append(cardLine(item.grandfather_name,i18n.grandfather_name_label));}
['year_of_birth','dob','email','phone'].forEach(function(propName){var value=item[propName];if(value){card.append(cardLine(value));}});card.append(cardButton(i18n.Yes,opts.yesIcon));cardList.append(card);});var discard=$('<div class="dl-item">').append(cardButton(i18n.No,opts.noIcon));cardList.append(discard);dupesCount.after(cardList);$('html,body').animate({scrollTop:dupesCount.offset().top},250);},_selectDuplicate:function(personID,name){var selector=this.selector,dupesCount=$(selector+'_duplicates');if(personID&&name){$(selector+'_full_name').val(name);this._clearDuplicates();if(dupesCount.data('submit')){this.data={'id':personID};this._serialize();dupesCount.closest('form').off(this.eventNamespace).submit();}else{if(this.options.separateNameFields){this.trigger.val('');}
this._selectPerson(personID);}}else{this._clearDuplicates();if(dupesCount.data('submit')){dupesCount.closest('form').off(this.eventNamespace).submit();}}},_clearDuplicates:function(){var selector=this.selector;$(selector+'_duplicates').data('results',[]).empty();$(selector+'_results').remove();},_onFormSubmit:function(form){var opts=this.options,selector=this.selector;if(opts.lookupDuplicates){var duplicates=$(selector+'_duplicates');if(duplicates.data('results').length){duplicates.data('submit',true);this._displayDuplicates();return false;}}
if(!this.data.id){this._readInputs();}else{this.data={'id':this.data.id};}
this._serialize();$(form).off(this.eventNamespace).submit();return true;},_bindEvents:function(){var el=$(this.element),opts=this.options,selector=this.selector,ns=this.eventNamespace,self=this;el.closest('form').on('submit'+ns,function(event){event.preventDefault();return self._onFormSubmit(this);});$(selector+'_edit_bar .edit-action').on('click'+ns,function(){self._clearError();self._edit();});$(selector+'_edit_bar .cancel-action').on('click'+ns,function(){self._clearError();self._cancel();});$(selector+'_organisation_id').change(function(){self.acURL=updateURLQuery(self.acURL,{'~.organisation_id':$(this).val()});});$(selector+'_title__row').next('.error_wrapper').one('click'+ns,function(){self._clearError();return false;});var fields=this.nameFields.concat(this.personFields);$(fields.map(function(fieldName){return selector+'_'+fieldName;}).join(',')).on('change'+ns,function(){self._readInputs();self._serialize();if(opts.lookupDuplicates){self._checkDuplicates();}});if(opts.lookupDuplicates){$(selector+'_duplicates').data('results',[]).on('click'+ns,function(){self._displayDuplicates();});el.closest('form').on('click'+ns,selector+'_results .dl-item',function(){var $this=$(this),personID=$this.data('id'),name=$this.data('name');self._selectDuplicate(personID,name);});el.on('change'+ns,function(){if(el.val()){self._clearDuplicates();}});}
var idLabel=this.idLabel;if(idLabel){idLabel.on('input'+ns,function(){var $this=$(this),timer=$this.data('lookupTimeout');if(timer){clearTimeout(timer);}
timer=setTimeout(function(){self.lookupIDLabel();},opts.delay);$this.data('lookupTimeout',timer);});idLabel.on('blur'+this.eventNamespace,function(){var $this=$(this),lookup=$this.data('lookup'),timer=$this.data('lookupTimeout');if(lookup){lookup.abort();$this.data('lookup',null);self.idLabelThrobber.hide();}
if(timer){clearTimeout(timer);}});}
return true;},_unbindEvents:function(){var el=$(this.element),selector=this.selector,ns=this.eventNamespace;el.off(ns);el.closest('form').off(ns);$(selector+'_edit_bar .edit-action').off(ns);$(selector+'_edit_bar .cancel-action').off(ns);$(selector+'_duplicates').off(ns);var fields=this.nameFields.concat(this.personFields);$(fields.map(function(fieldName){return selector+'_'+fieldName;}).join(',')).off(ns);var idLabel=this.idLabel;if(idLabel){idLabel.off(ns);}
return true;}});})(jQuery);