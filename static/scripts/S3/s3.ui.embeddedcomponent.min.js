(function($,undefined){"use strict";var embeddedComponentID=0;$.widget('s3.embeddedComponent',{options:{ajaxURL:null,fieldname:null,component:null,recordID:null,autocomplete:false},_create:function(){this.id=embeddedComponentID;embeddedComponentID+=1;this.eventNamespace='.embeddedComponent';this.eventNamespaceID=this.eventNamespace+this.id;},_init:function(){var fieldname=this.options.fieldname;this.input=$(this.element);this.fieldname=fieldname;this.selectBtn=$('#'+fieldname+'-select');this.editBtn=$('#'+fieldname+'-edit');this.clearBtn=$('#'+fieldname+'-clear');this.loadThrobber=this.selectBtn.siblings('.throbber');this.selectRow=$('#'+fieldname+'-select-row');this.dummyInput=$('#dummy_'+fieldname);this.autocompleteRow=$('#'+fieldname+'-autocomplete-row');this.autocompleteLabel=$('#'+fieldname+'-autocomplete-label');this.refresh();},_destroy:function(){$.Widget.prototype.destroy.call(this);},refresh:function(){this._unbindEvents();this.dummyInput.hide();var recordID=this.options.recordID;if(recordID!='None'){this.input.val(recordID);this.select(recordID);}
if(this.input.val()>0){this.clearBtn.removeClass('hide').show();this.editBtn.removeClass('hide').show();this._disableEmbedded();}
this._bindEvents();},select:function(componentID){if(typeof componentID=='undefined'){componentID=this.input.val();}else{this.input.val(componentID);}
this.selectBtn.hide();this.clearBtn.hide();this.loadThrobber.removeClass('hide').show();this._clear();var componentName=this.options.component,url=this.options.ajaxURL+componentID+'.s3json?show_ids=true',self=this;$.getJSONS3(url,function(data){try{var record=data['$_'+componentName][0];self._disableEmbedded();self.input.val(record['@id']);var re=new RegExp("^[\$|\@].*"),fk=new RegExp("^[\$]k_.*");var field,fieldID;for(field in record){if(field.match(re)){if(field.match(fk)){fieldID='#'+componentName+"_"+field.slice(3);}else{continue;}}else{fieldID='#'+componentName+"_"+field;}
try{var value=record[field];if(value.hasOwnProperty('@id')){$(fieldID).val(eval(value['@id']));}else
if(value.hasOwnProperty('@value')){var val;try{val=JSON.parse(value['@value']);}
catch(e){val=value['@value'];}
$(fieldID).val(val);}
else{$(fieldID).val(value);}}
catch(e){}}}
catch(e){self.input.val('');}
self.loadThrobber.hide();self.selectBtn.removeClass('hide').show();self.editBtn.removeClass('hide').show();self.clearBtn.removeClass('hide').show();var postprocess=self.options.postprocess;if(postprocess){eval(postprocess);}});self.autocompleteRow.hide();self.selectRow.removeClass('hide').show();},_clear:function(){var input=$(this.input);var form=input.closest('form');form.find('.embedded-'+this.fieldname).each(function(){$(this).find('input, select, textarea').prop('disabled',false).val('');});input.val('');this.clearBtn.hide();this.editBtn.hide();var postprocess=this.options.postprocess;if(postprocess){eval(postprocess);}},_edit:function(){this._enableEmbedded();this.editBtn.hide();},_enableEmbedded:function(){var form=$(this.element).closest('form');form.find('.embedded-'+this.fieldname).each(function(){$(this).find('input, select, textarea').prop('disabled',false);});},_disableEmbedded:function(){var form=$(this.element).closest('form');form.find('.embedded-'+this.fieldname).each(function(){$(this).find('input, select, textarea').prop('disabled',true);});},_onFormSubmission:function(){S3ClearNavigateAwayConfirm();this._enableEmbedded();},_bindEvents:function(){var self=this,ns=this.eventNamespace;this.input.closest('form').bind('submit'+this.eventNamespaceID,function(){self._onFormSubmission();return true;});this.selectBtn.bind('click'+ns,function(){self.selectRow.hide();self.autocompleteRow.removeClass('hide').show();self.autocompleteLabel.removeClass('hide').show();self.dummyInput.removeClass('hide').show().focus();});this.editBtn.bind('click'+ns,function(){self._edit();});this.clearBtn.bind('click'+ns,function(){self._clear();});this.dummyInput.bind('focusout'+ns,function(){var componentID=self.input.val();$(this).hide();self.autocompleteLabel.hide();self.selectRow.removeClass('hide').show();if(self.input.val()>0){self.clearBtn.removeClass('hide').show();}});if(!this.options.autocomplete){this.dummyInput.bind('change'+ns,function(){var value=$(this).val();if(value){self.input.val(value).change();}})}
this.input.bind('change'+ns,function(){var value=$(this).val();if(value){self.select(value);}});return true;},_unbindEvents:function(){var ns=this.eventNamespace;this.input.closest('form').unbind(this.eventNamespaceID);this.selectBtn.unbind(ns);this.editBtn.unbind(ns);this.clearBtn.unbind(ns);this.dummyInput.unbind(ns);return true;}});})(jQuery);