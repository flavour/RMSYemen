(function($,undefined){"use strict";var pivottableID=0;$.widget('s3.pivottable',{options:{showTotals:true,ajaxURL:null,defaultChart:{type:'breakdown',axis:'rows'},renderFilter:true,renderOptions:true,renderChart:true,renderTable:true,collapseFilter:false,collapseOptions:true,collapseChart:true,collapseTable:false,exploreChart:false,filterURL:null,filterForm:null,filterTab:null,autoSubmit:1000,timeout:10000,thousandSeparator:' ',thousandGrouping:'3',minTickSize:null,precision:null,textAll:'All',labelRecords:'Records',},_create:function(){this.id=pivottableID;pivottableID+=1;this.table=null;this.chart=null;this.openRequest=null;this.eventNamespace='.pt';},_init:function(){var $el=$(this.element),opts=this.options;this.data=null;this.table=null;this.chartOptions={currentChart:null,currentDataIndex:null,currentSeriesIndex:null,currentSpectrumIndex:null};this.table_options={hidden:false};var chart=$el.find('.pt-chart');if(chart.length){this.chart=chart.first();}else{this.chart=null;}
if(!opts.renderFilter&&!opts.renderOptions){$el.find('.pt-form-container').hide();}else{var widgetID='#'+$el.attr('id');if(opts.renderOptions){$(widgetID+'-options').show();if(opts.collapseOptions){$(widgetID+'-options legend').siblings().toggle();$(widgetID+'-options legend').children().toggle();}}else{$(widgetID+'-options').hide();}
if(opts.renderFilter){$(widgetID+'-filters').show();if(opts.collapseFilter){$(widgetID+'-filters legend').siblings().toggle();$(widgetID+'-filters legend').children().toggle();}}else{$(widgetID+'-options').hide();}}
if(opts.collapseTable){this.table_options.hidden=true;$el.find('.pt-table').hide();$el.find('.pt-show-table').show();$el.find('.pt-hide-table').hide();}
opts.numberFormatter=function(number){var decimals=opts.precision;if(number===null||typeof number=='undefined'){return'-';}
var n=decimals||decimals==0?number.toFixed(decimals):number.toString();n=n.split('.');var n1=n[0],n2=n.length>1?'.'+n[1]:'';var re=new RegExp('\\B(?=(\\d{'+opts.thousandGrouping+'})+(?!\\d))','g');n1=n1.replace(re,opts.thousandSeparator);return n1+n2;};this.refresh();},_destroy:function(){if(this.table){this.table.remove();}
if(this.chart){this.chart.empty();}},refresh:function(){var $el=$(this.element),data=null;this._unbindEvents();var pivotdata=$el.find('input[type="hidden"][name="pivotdata"]');if(pivotdata.length){data=JSON.parse($(pivotdata).first().val());}
if(!data){data={empty:true};$el.find('.pt-hide-table').hide();$el.find('.pt-show-table').hide();$el.find('.pt-export-opt').hide();}else if(data.method=='count'){this.options.precision=0;this.options.minTickSize=1;}
this.data=data;this.lookups={};if(data.nodata){$el.find('.pt-table').first().empty().append($('<div class="pt-no-data">'+data.nodata+'</div>'));$el.find('.pt-hide-table').hide();$el.find('.pt-show-table').hide();$el.find('.pt-export-opt').hide();this._renderChart();}else{this._renderTable();this._renderChartOptions();this._renderChart();}
if(data.empty){$el.find('.pt-empty').show();}else{$el.find('.pt-empty').hide();}
if(this.options.autoSubmit){$el.find('.pt-submit').hide();}else{$el.find('.pt-submit').show();}
this._bindEvents();$el.find('.pt-throbber').hide();},_renderTable:function(){var $el=$(this.element),container=$el.find('.pt-table').first().empty();this.table=null;var data=this.data;if(data.empty){return;}
if(this.options.renderTable){var cells=data.cells.slice(0),cols=data.cols,rows=data.rows,total=data.total,labels=data.labels;var singleRow=false,singleCol=false,facts=data.facts;if(facts.length==1&&facts[0][1]!="list"){if(rows.length==1&&rows[0][4]===null){singleRow=true;}
if(cols.length==1&&cols[0][4]===null){singleCol=true;}}
var opts=this.options,showTotals=opts.showTotals,i;if(singleCol&&showTotals){cols=[];for(i=0;i<rows.length;i++){cells[i]=[];}}else{var notOther=function(cell,cidx){return cols[cidx][0]!='__other__';};for(i=0;i<rows.length;i++){cells[i]=cells[i].filter(notOther);}
cols=cols.filter(function(col){return col[0]!='__other__';});}
if(singleRow&&showTotals){rows=[];cells=[];}else{cells=cells.filter(function(row,ridx){return rows[ridx][0]!='__other__';});rows=rows.filter(function(row){return row[0]!='__other__';});}
var table=d3.select(container.get(0)).append('table').attr('class','dataTable display report');table.append('thead').call(this._renderHeader,cols,labels,opts).call(this._renderColumns,cols,labels,singleCol);if(!singleRow||!showTotals){var pt=this;table.append('tbody').call(this._renderRows,pt,rows,cols,labels,cells,opts);}
if(showTotals){table.append('tfoot').call(this._renderFooter,rows,cols,labels,total);}
this.table=$(table.node());if(this.table_options.hidden){$el.find('.pt-show-table').show();$el.find('.pt-hide-table').hide();$el.find('.pt-export-opt').hide();}else{$el.find('.pt-show-table').hide();$el.find('.pt-hide-table').show();$el.find('.pt-export-opt').show();}}else{$el.find('.pt-show-table').hide();$el.find('.pt-hide-table').hide();$el.find('.pt-export-opt').hide();}},_renderHeader:function(thead,cols,labels,opts){var header=thead.append('tr');header.append('th').attr('scope','col').text(labels.layer);if(cols.length){header.append('th').attr({'scope':'col','colspan':cols.length}).text(labels.cols);}
if(opts.showTotals){header.append('th').attr({'scope':'col','class':'pt-totals-header pt-row-total','rowspan':2}).text(labels.total);}
return header;},_renderColumns:function(thead,cols,labels,singleCol){var columns=thead.append('tr');columns.append('th').attr({'scope':'col','class':'pt-rows-header'}).text(labels.rows);columns.selectAll('th.pt-data').data(cols).enter().append('th').attr({'scope':'col','class':'pt-col-label'}).text(function(d){if(singleCol){return'';}else{return d[4];}});return columns;},_renderRows:function(tbody,pt,rows,cols,labels,cells,opts){rows=tbody.selectAll('tr.pt-row').data(rows).enter().append('tr').attr('class',function(d,i){return i%2?'odd':'even';});rows.append('td').text(function(d){return d[4];});rows.selectAll('td.pt-cell').data(function(d,i){return cells[i];}).enter().append('td').attr('class','pt-cell').each(pt._renderCell,labels);if(opts.showTotals){rows.append('td').attr('class','pt-row-total').text(function(d){return d[2][0];});}
return rows;},_renderCell:function(data,index,labels){var column=d3.select(this),items=data.i,layer;for(var i=0,len=items.length;i<len;i++){layer=items[i];var value=column.append('div').attr('class','pt-cell-value');if(layer===null){value.text(labels.none);}else if($.isArray(layer)){value.append('ul').selectAll('li').data(layer).enter().append('li').html(function(d){return d;});}else{value.text(layer);}
if(len-i>1){value.append('span').text(' / ');}}
var recordIDs=data.k;if(recordIDs&&recordIDs.length){$(column.node()).data('recordIDs',recordIDs);column.append('div').attr('class','pt-cell-zoom');}},_renderCellRecords:function(cell,recordIDs){var zoom=$('.pt-cell-zoom',cell).removeClass('opened'),records=$('.pt-cell-records',cell).remove();if(recordIDs){var lookups=this.lookups,recordList=[],recordRepr,keys=[];recordIDs.forEach(function(recordID){recordRepr=lookups[recordID];if(!recordRepr){return;}
if(recordRepr.constructor===Array){var key=recordRepr[1];if(keys.indexOf(key)!=-1){return;}else{keys.push(key);}
recordRepr=recordRepr[0];}
if(recordRepr){recordList.push(recordRepr);}});records=$('<div class="pt-cell-records">');var list=$('<ul>').appendTo(records);if(recordList.length){recordList.sort(function(a,b){return a.localeCompare(b);});recordList.forEach(function(recordRepr){$('<li>').html(recordRepr).appendTo(list);});}else{$('<li>').text(recordIDs.length+' '+this.options.textRecords).appendTo(list);}
zoom.addClass('opened').after(records);}},_renderFooter:function(tfoot,rows,cols,labels,total){var rowClass;if(rows.length%2){rowClass='odd';}else{rowClass='even';}
var footer=tfoot.append('tr').attr('class',rowClass+' pt-totals-row');footer.append('th').attr({'class':'pt-totals-header','scope':'row'}).text(labels.total);footer.selectAll('td.pt-col-total').data(cols).enter().append('td').attr('class','pt-col-total').text(function(col){return col[2][0];});footer.append('td').attr('class','pt-total').text(total);return footer;},_renderChartOptions:function(){var $el=$(this.element);var container=$el.find('.pt-chart-controls').first().empty();var data=this.data;if(data.empty||!this.options.renderChart){return;}
var labels=data.labels;var widgetID=$el.attr('id'),layerLabel=labels.layer,rowsLabel=labels.rows,colsLabel=labels.cols,per=labels.per,chartOpts=$('<div class="pt-chart-opts">');var pchartRows=widgetID+'-pchart-rows',vchartRows=widgetID+'-vchart-rows',hchartRows=widgetID+'-hchart-rows',schartRows=widgetID+'-schart-rows',pchartCols=widgetID+'-pchart-cols',vchartCols=widgetID+'-vchart-cols',hchartCols=widgetID+'-hchart-cols',schartCols=widgetID+'-schart-cols';if(layerLabel){$(chartOpts).append($('<span class="pt-chart-label">'+layerLabel+': </span>'));}
if(rowsLabel){$(chartOpts).append($('<div id="'+pchartRows+'" class="pt-chart-icon pt-pchart"/>'+'<div id="'+vchartRows+'" class="pt-chart-icon pt-vchart"/>'+'<span class="pt-chart-label">'+per+' '+rowsLabel+'</span>'));}
if(colsLabel){$(chartOpts).append($('<div id="'+pchartCols+'" class="pt-chart-icon pt-pchart"/>'+'<div id="'+vchartCols+'" class="pt-chart-icon pt-vchart"/>'+'<span class="pt-chart-label">'+per+' '+colsLabel+'</span>'));}
if(rowsLabel&&colsLabel){$(chartOpts).append($('<span class="pt-chart-label">| '+labels.breakdown+': </span>'+'<div id="'+schartRows+'" class="pt-chart-icon pt-schart"/>'+'<div id="'+hchartRows+'" class="pt-chart-icon pt-hchart"/>'+'<span class="pt-chart-label">'+per+' '+rowsLabel+'</span>'+'<div id="'+schartCols+'"  class="pt-chart-icon pt-schart"/>'+'<div id="'+hchartCols+'"  class="pt-chart-icon pt-hchart"/>'+'<span class="pt-chart-label">'+per+' '+colsLabel+'</span>'));}
$(container).append(chartOpts);},_truncateLabel:function(label,len){if(label&&label.length>len){return label.substring(0,len-3).replace(/\s+$/g,'')+'...';}else{return label;}},_renderChart:function(chartOptions){var $el=$(this.element),data=this.data;$('.pt-chart-contents',$el).hide();var chart=this.chart;if(chart){$(chart).off('plothover').off('plotclick').empty();}else{return;}
if(data.empty||!this.options.renderChart){return;}
if(chartOptions===false){this.options.collapseChart=true;return;}
var collapseChart=this.options.collapseChart;if(typeof chartOptions=='undefined'||!chartOptions){if(collapseChart){return;}
chartOptions=this.chartOptions.currentChart;}
if(typeof chartOptions=='undefined'||!chartOptions){if(collapseChart){return;}
chartOptions=this.options.defaultChart;}
if(typeof chartOptions=='undefined'||!chartOptions){return;}
this.options.collapseChart=false;this.chartOptions.currentChart=chartOptions;var chartType=chartOptions.type,chartAxis=chartOptions.axis,labels=data.labels;var per=labels.per,rowsTitle=labels.layer+' '+per+' '+labels.rows,colsTitle=labels.layer+' '+per+' '+labels.cols;var filter=data.filter;var rows_selector=filter[0],cols_selector=filter[1];if(chartType=='piechart'){if(chartAxis=='rows'){this._renderPieChart(data.rows,rowsTitle,rows_selector);}else{this._renderPieChart(data.cols,colsTitle,cols_selector);}}else if(chartType=='barchart'){if(chartAxis=='rows'){this._renderBarChart(data.rows,data.facts,rowsTitle,rows_selector);}else{this._renderBarChart(data.cols,data.facts,colsTitle,cols_selector);}}else if(chartType=='breakdown'){if(chartAxis=='rows'){this._renderBreakDown(data,0,rowsTitle,filter);}else{this._renderBreakDown(data,1,colsTitle,filter);}}else if(chartType=='spectrum'){this._renderSpectrum(data,chartAxis,filter);}},_renderPieChart:function(data,title,selector){var chart=this.chart;if(!chart){return;}
var height=360;$(chart).css({height:height+'px'}).closest('.pt-chart-contents').show().css({width:'98%'});if(title){$(chart).siblings('.pt-chart-title').html('<h4>'+title+'</h4>');}else{$(chart).siblings('.pt-chart-title').empty();}
var items=[],total=0;for(var i=0;i<data.length;i++){var item=data[i];if(!item[1]&&item[2][0]>=0){items.push({index:item[0],label:item[4],value:item[2][0],key:item[3]});total+=item[2][0];}}
var pt=this;pt.chartOptions.currentDataIndex=null;var onhoverTooltip=function(e){var index=e.index;if(pt.chartOptions.currentDataIndex==index){return;}
pt._removeChartTooltip();pt.chartOptions.currentDataIndex=index;var data=e.data;var value=data.value;var percent=Math.round((value/total)*100);var tooltip='<div class="pt-tooltip-label">'+data.label+'</div>';tooltip+='<div class="pt-tooltip-text">'+value+' ('+percent+'%)</div>';var d3_event=d3.event,x=d3_event.pageX,y=d3_event.pageY;pt._renderChartTooltip(x,y,tooltip);$('.pt-tooltip-label').css({color:nv.utils.defaultColor()({},index)});};nv.addGraph(function(){var reportChart=nv.models.pieChart().x(function(d){return d.label;}).y(function(d){return d.value;}).labelsOutside(false).labelType('percent').labelThreshold(0.03).showLegend(true);reportChart.tooltip.enabled(false);reportChart.legend.align(true).rightAlign(false);reportChart.pie.dispatch.on('elementMouseover',onhoverTooltip).on('elementMouseout',function(){$('.pt-tooltip').remove();pt.chartOptions.currentDataIndex=null;pt.chartOptions.currentSeriesIndex=null;});if(pt.options.exploreChart&&selector){reportChart.pie.dispatch.on('elementClick',function(e){var data=e.data,index=data.index,key=data.key,fvar;if(index=='__other__'){fvar=selector+'__belongs';}else{fvar=selector;}
pt._chartExplore([[fvar,key]]);});}
d3.select($(chart).get(0)).append('svg').attr('class','nv').datum(items).transition().duration(1200).call(reportChart);nv.utils.windowResize(reportChart.update);return reportChart;});},_renderBarChart:function(data,facts,title,selector){var chart=this.chart;if(!chart){return;}
$(chart).closest('.pt-chart-contents').show().css({width:'96%'});var items=[],truncateLabel=this._truncateLabel,series,set,item;for(var i=0;i<facts.length;i++){series={key:facts[i][2]};set=[];for(var j=0;j<data.length;j++){item=data[j];set.push({label:item[4],value:item[2][i],filterIndex:item[0],filterKey:item[3]});}
series.values=set;items.push(series);}
$(chart).css({height:'360px'});if(title){$(chart).siblings('.pt-chart-title').html('<h4>'+title+'</h4>');}else{$(chart).siblings('.pt-chart-title').empty();}
var tooltipContent=function(data){data=data.data;var color=nv.utils.defaultColor()({},data.index);var tooltip='<div class="pt-tooltip">'+'<div class="pt-tooltip-label" style="color:'+color+'">'+data.label+'</div>'+'<div class="pt-tooltip-text">'+data.value+'</div>'+'</div>';return tooltip;};var pt=this,valueFormat=this.options.numberFormatter;nv.addGraph(function(){var reportChart,dispatch;if(items.length>1){reportChart=nv.models.multiBarChart().x(function(d){return d.label;}).y(function(d){return d.value;}).staggerLabels(true).showControls(false);dispatch=reportChart.multibar;}else{reportChart=nv.models.discreteBarChart().x(function(d){return d.label;}).y(function(d){return d.value;}).staggerLabels(true).showValues(true);reportChart.valueFormat(valueFormat);dispatch=reportChart.discretebar;}
reportChart.tooltip.contentGenerator(tooltipContent);reportChart.yAxis.tickFormat(valueFormat);reportChart.xAxis.tickFormat(function(d){return truncateLabel(d,18);});d3.select($(chart).get(0)).append('svg').attr('class','nv').datum(items).transition().duration(500).call(reportChart);if(pt.options.exploreChart&&selector){dispatch.dispatch.on('elementClick',function(e){var filterKey=e.data.filterKey;if(filterKey===null){filterKey='None';}
var filterVar=selector;if(e.data.filterIndex=='__other__'){filterVar+='__belongs';}
pt._chartExplore([[filterVar,filterKey]]);});}
nv.utils.windowResize(reportChart.update);return reportChart;});},_renderBreakDown:function(data,dim,title,selectors){var chart=this.chart;if(!chart){return;}
$(chart).closest('.pt-chart-contents').show().css({width:'96%'});var cells=data.cells,rdim,cdim,getData,ridx=[],cidx=[],rowsSelector,colsSelector;if(dim===0){rdim=data.rows;cdim=data.cols;getData=function(i,j){var ri=ridx[i],ci=cidx[j];return cells[ri][ci].v[0];};rowsSelector=selectors[0];colsSelector=selectors[1];}else{rdim=data.cols;cdim=data.rows;getData=function(i,j){var ri=ridx[i],ci=cidx[j];return cells[ci][ri].v[0];};rowsSelector=selectors[1];colsSelector=selectors[0];}
var i,len,rows=[],cols=[];for(i=0,len=rdim.length;i<len;i++){if(!rdim[i][1]){rows.push(rdim[i]);ridx.push(i);}}
for(i=0,len=cdim.length;i<len;i++){if(!cdim[i][1]){cols.push(cdim[i]);cidx.push(i);}}
var matrix=[];for(var c=0;c<cols.length;c++){var series={key:cols[c][4],filterIndex:cols[c][0],filterKey:cols[c][3]},values=[];for(var r=0;r<rows.length;r++){values.push({label:rows[r][4],filterIndex:rows[r][0],filterKey:rows[r][3],value:getData(r,c)});}
series.values=values;matrix.push(series);}
var height=Math.max(rows.length*Math.max((cols.length+1)*16,50)+70,360);$(chart).css({height:height+'px'});if(title){$(chart).siblings('.pt-chart-title').html('<h4>'+title+'</h4>');}else{$(chart).siblings('.pt-chart-title').empty();}
var tooltipContent=function(data){var series=data.series[0],item=data.data,seriesLabel=item.series;if(series){seriesLabel=series.key;}
var color=nv.utils.defaultColor()({},item.index),tooltip='<div class="pt-tooltip">'+'<div class="pt-tooltip-label" style="color:'+color+'">'+series.key+'</div>'+'<div class="pt-tooltip-text">'+item.label+': <span class="pt-tooltip-value">'+item.value+'</span></div>'+'</div>';return tooltip;};var pt=this,valueFormat=this.options.numberFormatter,truncateLabel=this._truncateLabel;nv.addGraph(function(){var reportChart=nv.models.multiBarHorizontalChart().x(function(d){return d.label;}).y(function(d){return d.value;}).margin({top:20,right:20,bottom:20,left:175}).showValues(true).duration(350).showControls(true);reportChart.tooltip.contentGenerator(tooltipContent);reportChart.valueFormat(valueFormat);reportChart.yAxis.tickFormat(valueFormat);reportChart.xAxis.tickFormat(function(d){return truncateLabel(d,24);});d3.select($(chart).get(0)).append('svg').attr('class','nv').datum(matrix).call(reportChart);if(pt.options.exploreChart&&rowsSelector&&colsSelector){reportChart.multibar.dispatch.on('elementClick',function(e){var data=e.data,series=d3.event.currentTarget.parentElement.__data__,columnKey=series.filterKey,columnFilter;if(columnKey===null){columnKey='None';}
if(series.filterIndex=='__other__'){columnFilter=colsSelector+'__belongs';}else{columnFilter=colsSelector;}
var rowKey=data.filterKey,rowFilter;if(rowKey===null){rowKey='None';}
if(data.filterIndex=='__other__'){rowFilter=rowsSelector+'__belongs';}else{rowFilter=rowsSelector;}
var filterVars=[[rowFilter,rowKey],[columnFilter,columnKey]];pt._chartExplore(filterVars);});}
nv.utils.windowResize(reportChart.update);return reportChart;});},_renderSpectrum:function(data,axis,selectors){var chart=this.chart;if(!chart){return;}
var pt=this,defaultColor='silver';var cells=data.cells,labels=data.labels,xAxis,yAxis,xLabel,yLabel,xSelector,ySelector,getCell;if(axis=='rows'){xAxis=data.rows;yAxis=data.cols;xLabel=labels.rows;yLabel=labels.cols;xSelector=selectors[0];ySelector=selectors[1];getCell=function(xIndex,yIndex){return cells[xIndex][yIndex];};}else{xAxis=data.cols;yAxis=data.rows;xLabel=labels.cols;yLabel=labels.rows;xSelector=selectors[1];ySelector=selectors[0];getCell=function(xIndex,yIndex){return cells[yIndex][xIndex];};}
var getData=function(xIndex,yIndex){if(xIndex===null){return yAxis[yIndex];}else if(yIndex===null){return xAxis[xIndex];}else{return getCell(xIndex,yIndex);}};var getSeries=function(xIndex,color){if(color===undefined){color=defaultColor;}
var items=[],item,value;for(var i=0;i<yAxis.length;i++){item=getData(null,i);if(xIndex===null){value=item[2][0];}else{value=getData(xIndex,i).v[0];}
if(!item[1]&&item[2][0]>=0){items.push({filterIndex:item[0],filterKey:item[3],label:item[4],value:value,color:color});}}
return items;};var xHeaders=[],total=0;for(var i=0;i<xAxis.length;i++){var item=getData(i,null);if(!item[1]&&item[2][0]>=0){xHeaders.push({position:i,filterIndex:item[0],filterKey:item[3],label:item[4],value:item[2][0]});total+=item[2][0];}}
pt.chartOptions.currentDataIndex=null;var onhoverTooltip=function(e){var index=e.index;if(pt.chartOptions.currentDataIndex==index){return;}
pt._removeChartTooltip();pt.chartOptions.currentDataIndex=index;var data=e.data;var value=data.value;var percent=Math.round((value/total)*100);var tooltip='<div class="pt-tooltip-label">'+data.label+'</div>';tooltip+='<div class="pt-tooltip-text">'+value+' ('+percent+'%)</div>';var d3_event=d3.event,x=d3_event.pageX,y=d3_event.pageY;pt._renderChartTooltip(x,y,tooltip);$('.pt-tooltip-label').css({color:nv.utils.defaultColor()({},index)});};$(chart).removeAttr('style').closest('.pt-chart-contents').css({'width':'98%','height':'auto'}).show();$(chart).siblings('.pt-chart-title').empty();var pieArea=$('<div class="pt-spectrum-pie">').appendTo(chart),barArea=$('<div class="pt-spectrum-bar">').appendTo(chart);var valueFormat=this.options.numberFormatter,truncateLabel=this._truncateLabel;var barChartTooltip=function(data){data=data.data;var color=data.color||[defaultColor];var tooltip='<div class="pt-tooltip">'+'<div class="pt-tooltip-label" style="color:'+color+'">'+data.label+'</div>'+'<div class="pt-tooltip-text">'+valueFormat(data.value)+'</div>'+'</div>';return tooltip;};var barChart=nv.models.discreteBarChart().x(function(d){return d.label;}).y(function(d){return d.value;}).color([defaultColor]).staggerLabels(true).showValues(true);barChart.tooltip.contentGenerator(barChartTooltip);barChart.valueFormat(valueFormat);barChart.yAxis.tickFormat(valueFormat);barChart.xAxis.tickFormat(function(d){return truncateLabel(d,18);});var barChartContainer=d3.select($(barArea).get(0)).append('svg').attr('class','nv');var pieWidth=Math.floor(pieArea.width()/2)-30;var pieChart=nv.models.pieChart().x(function(d){return d.label;}).y(function(d){return d.value;}).height(280).width(pieWidth).margin({top:-20,left:20}).labelType('percent').labelThreshold(0.10).showLegend(false).donut(true).donutRatio(0.35);pieChart.tooltip.enabled(false);pieChart.legend.align(true).rightAlign(false);pieChart.pie.startAngle(function(d){return d.startAngle/2-Math.PI/2;}).endAngle(function(d){return d.endAngle/2-Math.PI/2;});pieChart.pie.dispatch.on('elementMouseover',onhoverTooltip).on('elementMouseout',function(){$('.pt-tooltip').remove();pt.chartOptions.currentDataIndex=null;pt.chartOptions.currentSeriesIndex=null;});var pieChartContainer=d3.select($(pieArea).get(0)).append('svg').attr('class','nv').style({'min-width':(pieWidth-30)+'px'});var formArea=d3.select($(pieArea).get(0)).append('div').attr('class','pt-spectrum-form');formArea.append('h4').html(labels.layer+' '+labels.per+' '+yLabel);formArea.append('label').html(xLabel+':');var seriesSelector=formArea.append('select');seriesSelector.append('option').attr('value','null').style('font-weight','bold').html(pt.options.textAll);seriesSelector.selectAll('.pt-series-item').data(xHeaders).enter().append('option').attr('class','pt-series-item').attr('value',function(d,i){return i;}).html(function(d){return d.label;});formArea.append('label').html(labels.total+':');var totalValue=formArea.append('span').text(data.total);var selectSeries=function(xIndex){var sliceColor,items;if(xIndex===null||pt.chartOptions.currentSpectrumIndex==xIndex){sliceColor=function(d,i){return nv.utils.defaultColor()({},i);};pieChartContainer.selectAll('.nv-slice').style('fill',sliceColor).style('stroke',sliceColor);items=getSeries(null);barChartContainer.datum([{key:null,filterIndex:null,filterKey:null,values:items}]);barChart.update();pt.chartOptions.currentSpectrumIndex=null;seriesSelector.property('value','null');totalValue.text(data.total);}else{var seriesHeader=xHeaders[xIndex],color=nv.utils.defaultColor()({},xIndex);sliceColor=function(d,i){if(i==xIndex){return color;}else{return defaultColor;}};pieChartContainer.selectAll('.nv-slice').style('fill',sliceColor).style('stroke',sliceColor);items=getSeries(seriesHeader.position,color);barChartContainer.datum([{key:seriesHeader.position,filterIndex:seriesHeader.filterIndex,filterKey:seriesHeader.filterKey,values:items}]);barChart.update();pt.chartOptions.currentSpectrumIndex=xIndex;seriesSelector.property('value',xIndex);totalValue.text(xHeaders[xIndex].value);}};pieChart.pie.dispatch.on('elementClick',function(e){selectSeries(e.index);});seriesSelector.on('change.pt',function(){var xIndex=d3.select(this).property('value');if(xIndex=='null'){selectSeries(null);}else{selectSeries(xIndex);}});nv.addGraph(function(){pieChartContainer.datum(xHeaders).transition().duration(1200).call(pieChart);nv.utils.windowResize(pieChart.update);return pieChart;});nv.addGraph(function(){barChartContainer.datum([{key:null,filterIndex:null,filterKey:null,values:getSeries(null)}]).transition().duration(500).call(barChart);if(pt.options.exploreChart&&xSelector&&ySelector){barChart.discretebar.dispatch.on('elementClick',function(e){var data=e.data,series=d3.event.currentTarget.parentElement.__data__,xIndex=series.filterIndex,xKey=series.filterKey,yIndex=data.filterIndex,yKey=data.filterKey,filters=[];var filterExpression=function(selector,index,key){if(key===null&&index!==null){key='None';}
if(index=='__other__'){return selector+'__belongs';}else{return selector;}};if(xIndex!==null){var xFilter=filterExpression(xSelector,xIndex,xKey);filters.push([xFilter,xKey||'None']);}
if(yIndex!==null){var yFilter=filterExpression(ySelector,yIndex,yKey);filters.push([yFilter,yKey||'None']);}
pt._chartExplore(filters);});}
nv.utils.windowResize(barChart.update);return barChart;});},_chartExplore:function(filter){var opts=this.options,summaryTabs=$(this.element).closest('.ui-tabs');var tab=opts.filterTab;if(summaryTabs.length&&tab!==false){var filterForm=opts.filterForm;var $filterForm=filterForm?$('#'+filterForm):undefined;S3.search.setCurrentFilters($filterForm,filter);var index=tab?$('#'+tab).index():0;summaryTabs.tabs('option','active',index);}else{var filterURL=opts.filterURL;if(filterURL){var page=this._updateURL(filterURL,filter);window.open(page,'_blank');}}
return;},_cellExplore:function(cell){var records=$('.pt-cell-records',cell);if(records.length){this._renderCellRecords(cell,false);return;}
var recordIDs=cell.data('recordIDs');if(recordIDs.length){var dfd=$.Deferred(),self=this;dfd.promise().then(function(){self._renderCellRecords(cell,recordIDs);});var ajaxURL=this._updateAjaxURL({'explore':'1'},null,true),lookups=this.lookups;var unknowns=recordIDs.filter(function(recordID){return!lookups.hasOwnProperty(recordID);});if(!unknowns.length){dfd.resolve();}else{var zoom=$('.pt-cell-zoom',cell).hide(),throbber=$('<div class="inline-throbber">');throbber.css({'display':'inline-block'}).insertAfter(zoom);$.ajaxS3({type:'POST',url:ajaxURL,data:JSON.stringify(unknowns),dataType:'json',contentType:'application/json; charset=utf-8',success:function(data){$.extend(self.lookups,data);dfd.resolve();throbber.remove();zoom.show();},error:function(){dfd.reject();throbber.remove();zoom.show();}});}}},_renderChartTooltip:function(x,y,contents){$('<div class="pt-tooltip">'+contents+'</div>').css({position:'absolute',display:'none',top:y-50,left:x+10,border:'1px solid #999','padding':'10px','min-height':'50px','max-width':'240px','z-index':'501','background-color':'white',color:'#000',opacity:0.95}).appendTo('body').fadeIn(200);},_removeChartTooltip:function(){$('.pt-tooltip').remove();this.chartOptions.currentDataIndex=null;this.chartOptions.currentSeriesIndex=null;},_getOptions:function(){var widgetID='#'+$(this.element).attr('id');return{rows:$(widgetID+'-rows').val(),cols:$(widgetID+'-cols').val(),fact:$(widgetID+'-fact').val(),totals:$(widgetID+'-totals').is(':checked')?1:0};},_getFilters:function(){var widgetID='#'+$(this.element).attr('id'),filters=null;var filterForm=$(widgetID+'-filters');if(filterForm.length){try{filters=S3.search.getCurrentFilters(filterForm.first());}catch(e){}}
return filters;},_updateURL:function(url,filters){var urlParts,urlVars,queries=[],update={},seen={},i,len,f,q,k;if(filters){for(i=0,len=filters.length;i<len;i++){f=filters[i];k=f[0];update[k]=true;queries.push(k+'='+f[1]);}}
var ajaxURL=this.options.ajaxURL;urlParts=ajaxURL.split('?');if(urlParts.length>1){urlVars=urlParts[1].split('&');seen={};for(i=0,len=urlVars.length;i<len;i++){q=urlVars[i].split('=');if(q.length>1){k=decodeURIComponent(q[0]);if(!update[k]){queries.push(k+'='+decodeURIComponent(q[1]));seen[k]=true;}}}
for(k in seen){update[k]=true;}}
urlParts=url.split('?');if(urlParts.length>1){urlVars=urlParts[1].split('&');seen={};for(i=0,len=urlVars.length;i<len;i++){q=urlVars[i].split('=');if(q.length>1){k=decodeURIComponent(q[0]);if(!update[k]){queries.push(k+'='+decodeURIComponent(q[1]));}}}}
var urlQuery=queries.join('&');var filteredURL=urlParts[0];if(urlQuery){filteredURL=filteredURL+'?'+urlQuery;}
return filteredURL;},_updateAjaxURL:function(options,filters,noupdate){var ajaxURL=this.options.ajaxURL;var urlParts=ajaxURL.split('?'),query=[],needsReload=false;var qstr,urlVars;if(urlParts.length>1){qstr=urlParts[1];urlVars=qstr.split('&');}else{qstr='';urlVars=[];}
var option,q,newopt;if(options){for(option in options){newopt=options[option];q=option+'='+newopt;if(option=='totals'){this.options.showTotals=newopt?true:false;}else if(!(needsReload||$.inArray(q,urlVars)!=-1)){needsReload=true;}
query.push(q);}}
var update={},remove={},subquery,i,len,k,v;if(filters){var removeIncompatible=function(k){var exclusive=['contains','anyof','belongs','eq'],pattern,match,incompatible=[];exclusive.forEach(function(op){pattern=new RegExp('__'+op+'$','g');if(k.match(pattern)){match=pattern;}else{incompatible.push(op);}});if(match){incompatible.forEach(function(op){remove[k.replace(match,'__'+op)]=true;});}};for(i=0,len=filters.length;i<len;i++){q=filters[i];k=q[0];v=q[1];removeIncompatible(k);if(v===null){if(!update[k]){remove[k]=true;}}else{if(remove[k]){remove[k]=false;}
subquery=k+'='+encodeURIComponent(v);if(update[k]){update[k].push(subquery);}else{update[k]=[subquery];}}}}
for(i=0,len=urlVars.length;i<len;i++){q=urlVars[i].split('=');if(q.length>1){k=decodeURIComponent(q[0]);v=decodeURIComponent(q[1]);if(remove[k]){needsReload=true;continue;}else if(update[k]){if(!(needsReload||$.inArray(k+'='+v,update[k])!=-1)){needsReload=true;}
continue;}else if(k=='aggregate'){continue;}else if(options&&options.hasOwnProperty(k)){continue;}else{query.push(urlVars[i]);}}}
for(k in update){for(i=0,len=update[k].length;i<len;i++){if(!(needsReload||$.inArray(update[k][i],urlVars)!=-1)){needsReload=true;}
query.push(update[k][i]);}}
var urlQuery=query.join('&'),filteredURL=urlParts[0];if(urlQuery){filteredURL=filteredURL+'?'+urlQuery;}
if(noupdate){return filteredURL;}else{this.options.ajaxURL=filteredURL;return needsReload;}},_setExtension:function(url,extension){var parser=document.createElement('a');parser.href=url;var path=parser.pathname.split('/'),items=[];if(path.length){path.forEach(function(item){var idx=item.lastIndexOf('.');if(idx!=-1){items.push(item.slice(0,idx));}else{items.push(item);}});items[items.length-1]+='.'+extension;parser.pathname=items.join('/');}
var search=parser.search;if(search){items=search.slice(1).split().filter(function(query){return query.split('=')[0]!='format';});if(!path.length){items.push('format='+extension);}
parser.search='?'+items.join('&');}
return parser.href;},reload:function(options,filters,force){force=typeof force!='undefined'?force:true;if(typeof filters=='undefined'){filters=this._getFilters();}
var pt=this,$el=(this.element),needsReload,pivotdata=$el.find('input[type="hidden"][name="pivotdata"]');if(!pivotdata.length){return;}
$el.find('.pt-throbber').show();if(options||filters){needsReload=this._updateAjaxURL(options,filters);}
if(needsReload||force){var ajaxURL=this.options.ajaxURL,timeout=this.options.timeout,ajaxMethod=$.ajaxS3;if($.searchS3!==undefined){ajaxMethod=$.searchS3;}
$el.find('.pt-empty').hide();if(pt.openRequest){pt.openRequest.onreadystatechange=null;pt.openRequest.abort();}
pt.openRequest=ajaxMethod({'timeout':timeout,'url':ajaxURL,'dataType':'json','type':'GET','success':function(data){pt.openRequest=null;pivotdata.first().val(JSON.stringify(data));pt.refresh();},'error':function(jqXHR,textStatus,errorThrown){var msg;if(errorThrown=='UNAUTHORIZED'){msg=i18n.gis_requires_login;}else{msg=jqXHR.responseText;}
console.log(msg);}});}else{pt.refresh();}},_downloadXLS:function(){var pivotdata=this.element.find('input[type="hidden"][name="pivotdata"]');if(!pivotdata.length){return;}
var options=this._getOptions(),filters=this._getFilters();var ajaxURL=this._updateAjaxURL(options,filters,true);var downloadURL=this._setExtension(ajaxURL,'xls');if($.searchDownloadS3!==undefined){$.searchDownloadS3(downloadURL,'_blank');}else{window.open(downloadURL);}},_bindEvents:function(){var pt=this,el=$(this.element),ns=this.eventNamespace,widgetID='#'+el.attr('id');$(widgetID+'-options legend').on('click'+ns,function(){$(this).siblings().toggle();$(this).children().toggle();});$(widgetID+'-filters legend').on('click'+ns,function(){$(this).siblings().toggle();$(this).children().toggle();});$('.pt-hide-table',el).on('click'+ns,function(){pt.table_options.hidden=true;$('.pt-table',el).hide();$('.pt-export-opt',el).hide();$(this).hide().siblings('.pt-show-table').show();});$('.pt-show-table',el).on('click'+ns,function(){pt.table_options.hidden=false;$('.pt-table',el).show();$('.pt-export-opt',el).show();$(this).hide().siblings('.pt-hide-table').show();});$('.pt-export-xls',el).on('click'+ns,function(){pt._downloadXLS();});$(widgetID+'-totals').on('click'+ns,function(){var show_totals=$(this).is(':checked');if(pt.options.showTotals!=show_totals){pt.reload({totals:show_totals},null,false);}});$(widgetID+'-rows,'+
widgetID+'-cols,'+
widgetID+'-fact').on('change.autosubmit',function(){$(widgetID+'-pt-form').trigger('optionChanged');});if(this.options.autoSubmit){var timeout=this.options.autoSubmit;$(widgetID+'-pt-form').on('optionChanged',function(){var that=$(this);if(that.data('noAutoSubmit')){return;}
var timer=that.data('autoSubmitTimeout');if(timer){clearTimeout(timer);}
timer=setTimeout(function(){var options=pt._getOptions(),filters=pt._getFilters();pt.reload(options,filters,false);},timeout);that.data('autoSubmitTimeout',timer);});}else{$(widgetID+'-pt-form input.pt-submit').on('click'+ns,function(){var options=pt._getOptions(),filters=pt._getFilters();pt.reload(options,filters,false);});}
$(widgetID+' .pt-table .pt-cell-zoom').on('click'+ns,function(event){var zoom=$(event.currentTarget),cell=zoom.closest('.pt-cell');if(cell.length){pt._cellExplore(cell);}});$(widgetID+'-pchart-rows').on('click'+ns,function(){pt._renderChart({type:'piechart',axis:'rows'});});$(widgetID+'-vchart-rows').on('click'+ns,function(){pt._renderChart({type:'barchart',axis:'rows'});});$(widgetID+'-schart-rows').on('click'+ns,function(){pt._renderChart({type:'spectrum',axis:'rows'});});$(widgetID+'-hchart-rows').on('click'+ns,function(){pt._renderChart({type:'breakdown',axis:'rows'});});$(widgetID+'-pchart-cols').on('click'+ns,function(){pt._renderChart({type:'piechart',axis:'cols'});});$(widgetID+'-vchart-cols').on('click'+ns,function(){pt._renderChart({type:'barchart',axis:'cols'});});$(widgetID+'-schart-cols').on('click'+ns,function(){pt._renderChart({type:'spectrum',axis:'cols'});});$(widgetID+'-hchart-cols').on('click'+ns,function(){pt._renderChart({type:'breakdown',axis:'cols'});});$('.pt-hide-chart',el).on('click'+ns,function(){pt._renderChart(false);});},_unbindEvents:function(){var el=$(this.element),widgetID='#'+el.attr('id'),ns=this.eventNamespace;$(widgetID+' .pt-table .pt-cell-zoom').off(ns);$(widgetID+'-options legend').off(ns);$(widgetID+'-filters legend').off(ns);$(widgetID+'-totals').off(ns);$(widgetID+'-rows,'+
widgetID+'-cols,'+
widgetID+'-fact').off('change.autosubmit');$(widgetID+'-pt-form').off('optionChanged');$('input.pt-submit, .pt-export-xls',el).off(ns);$(widgetID+'-pchart-rows,'+
widgetID+'-vchart-rows,'+
widgetID+'-schart-rows,'+
widgetID+'-hchart-rows,'+
widgetID+'-pchart-cols,'+
widgetID+'-vchart-cols,'+
widgetID+'-schart-cols,'+
widgetID+'-hchart-cols').off(ns);$('.pt-hide-table, .pt-show-table, .pt-hide-chart',el).off(ns);}});})(jQuery);