(function($,undefined){"use strict";var dashboardID=0;$.widget('s3.dashboardController',{options:{ajaxURL:null,version:null},_create:function(){var el=$(this.element);this.id=dashboardID;dashboardID+=1;this.eventNamespace='.dashboard';},_init:function(){var el=$(this.element);this.refresh();s3_debug("dashboard initialized");s3_debug("dashboard ajaxURL="+this.options.ajaxURL);s3_debug("dashboard version="+this.options.version);},_destroy:function(){$.Widget.prototype.destroy.call(this);},refresh:function(){var opts=this.options;this._unbindEvents();this._bindEvents();},configMode:function(mode){var el=this.element,ns=this.eventNamespace,modeSwitch=$('.db-config');if(typeof mode==='undefined'){var status=modeSwitch.data('mode');if(status=='on'){mode=true;}else{mode=false;}}else if(mode){modeSwitch.data('mode','on');modeSwitch.find('.db-config-on').hide();modeSwitch.find('.db-config-off').show().removeClass('hide');el.find('.db-widget').each(function(){$(this).dashboardWidget('configMode',true);});el.trigger('openConfig'+ns);}else{el.trigger('closeConfig'+ns);el.find('.db-widget').each(function(){$(this).dashboardWidget('configMode',false);});modeSwitch.data('mode','off');modeSwitch.find('.db-config-off').hide();modeSwitch.find('.db-config-on').show().removeClass('hide');}
return mode;},updateVersion:function(version){var el=this.element;this._setOption('version',version);s3_debug("dashboard new version="+version);el.find('.db-widget').each(function(){$(this).dashboardWidget('option','version',version);});},_bindEvents:function(){var el=this.element,ns=this.eventNamespace,self=this;$('.db-config-on').bind('click'+ns,function(){self.configMode(true);});$('.db-config-off').bind('click'+ns,function(){self.configMode(false);});el.bind('configSaved'+ns,function(e,data){e.stopPropagation();var version=null;if(data&&data.hasOwnProperty('v')){version=data.v;}
if(version){self.updateVersion(version);}});return true;},_unbindEvents:function(){var ns=this.eventNamespace;$('.dashboard-config').unbind(ns);return true;}});})(jQuery);(function($,undefined){"use strict";var dashboardWidgetID=0;$.widget('s3.dashboardWidget',{options:{dashboardURL:null,version:null,title:'Dashboard Widget'},_create:function(){this.id=dashboardWidgetID;dashboardWidgetID+=1;this.eventNamespace='.dashboardWidget';},_init:function(){var el=$(this.element);this.agentID=el.attr('id');this.configBar=el.find('.db-configbar');this.refresh();s3_debug("dashboard widget initialized");},_destroy:function(){$.Widget.prototype.destroy.call(this);},refresh:function(){var el=$(this.element),opts=this.options;this._unbindEvents();this._bindEvents();},_onConfigUpdate:function(newConfig){var el=$(this.element);if(newConfig&&newConfig.hasOwnProperty('xml')){el.children(':not(.db-configbar)').remove();var xmlStr=newConfig.xml;if(xmlStr){this.configBar.first().after(xmlStr);}}
this.refresh();},configMode:function(mode){var el=$(this.element);if(typeof mode==='undefined'){mode=this.configBar.is(':visible');}else if(mode){this.configBar.show();el.addClass('db-config-active');}else{this.configBar.hide();el.removeClass('db-config-active');}
return mode;},_configDialog:function(){var el=$(this.element),ns=this.eventNamespace,opts=this.options,self=this;if(!$('.db-config-dialog').length){var configURL='config.popup?agent='+this.agentID+'&version='+opts.version,dashboardURL=opts.dashboardURL;if(dashboardURL){configURL=dashboardURL+'/'+configURL;}
var iframeID=this.agentID+'-dialog',dialog=$('<iframe>',{'id':iframeID,'src':'','class':'loading','load':function(){$(this).removeClass('loading');var width=$('.ui-dialog').width();$('#'+iframeID).width(width).contents().find('#popup form').show();},'marginWidth':'0','marginHeight':'0','frameBorder':'0'}).appendTo('body');this.configDialog=dialog;dialog.dialog({autoOpen:false,modal:true,minWidth:320,minHeight:480,title:opts.title,open:function(){$('.ui-widget-overlay').one('click'+ns,function(){dialog.dialog('close');});el.addClass('db-has-dialog');},close:function(){dialog.attr('src','');el.removeClass('db-has-dialog');self.configDialog.remove();self.configDialog=null;}});dialog.attr('src',configURL).dialog('open');}},_bindEvents:function(){var el=$(this.element),ns=this.eventNamespace,self=this;this.configBar.find('.db-task-config').on('click'+ns,function(){self._configDialog();});el.bind('configSaved'+ns,function(e,data){var newConfig=null;if(data&&data.hasOwnProperty('c')){newConfig=data.c;}
self._onConfigUpdate(newConfig);var dialog=self.configDialog;if(dialog){dialog.dialog('close');}});return true;},_unbindEvents:function(){var el=$(this.element),ns=this.eventNamespace;el.unbind(ns);this.configBar.find('.db-task-config').off('click'+ns);return true;}});})(jQuery);