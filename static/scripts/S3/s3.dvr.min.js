(function($,undefined){"use strict";var eventRegistrationID=0;$.widget('dvr.eventRegistration',{options:{tablename:'case_event',ajax:null,ajaxURL:'',showPicture:true,showPictureText:'Show Picture',hidePictureText:'Hide Picture'},_create:function(){this.id=eventRegistrationID;eventRegistrationID+=1;this.eventNamespace='.eventRegistration';},_init:function(){this.idPrefix='#'+this.options.tablename;var form=$(this.element);this.flagInfo=form.find('input[type=hidden][name=flags]');this.permissionInfo=form.find('input[type=hidden][name=permitted]');this.actionableInfo=form.find('input[type=hidden][name=actionable]');this.eventType=form.find('input[type="hidden"][name="event"]');this.blockingInfo=form.find('input[type="hidden"][name="intervals"]');this.actionDetails=form.find('input[type="hidden"][name="actions"]');this.imageURL=form.find('input[type="hidden"][name="image"]');var intervals=this.blockingInfo.val();if(intervals){this.blockedEvents=JSON.parse(intervals);}else{this.blockedEvents={};}
this.blockingMessage=null;this.refresh();},_destroy:function(){$.Widget.prototype.destroy.call(this);},refresh:function(){var opts=this.options,prefix=this.idPrefix;this._unbindEvents();if(opts.ajaxURL&&opts.ajax===null){opts.ajax=true;}
this._showFlagInfo();this._showProfilePicture();$(this.element).find(prefix+'_details__row .controls').addClass('has-details');if(this.actionDetails.length){var actionData=JSON.parse(this.actionDetails.val());if(actionData.length){this._showDetails(true);}else{this._hideDetails();}}else{this._hideDetails();}
if(!this._checkBlockedEvents()){this._toggleSubmit(false);}
var labelInput=$(prefix+'_label');labelInput.focus().val(labelInput.val());this._bindEvents();},_checkID:function(){this._clearAlert();var form=$(this.element),prefix=this.idPrefix,labelInput=$(prefix+'_label'),label=labelInput.val().trim();labelInput.val(label);if(!label){return;}
var input={'l':label,'c':true},ajaxURL=this.options.ajaxURL,personInfo=$(prefix+'_person__row .controls').empty(),throbber=$('<div class="inline-throbber">').insertAfter(personInfo),self=this;this._removeProfilePicture();this._clearDetails();$.ajaxS3({'url':ajaxURL,'type':'POST','dataType':'json','contentType':'application/json; charset=utf-8','data':JSON.stringify(input),'success':function(data){throbber.remove();if(data.e){var msg=$('<div class="error_wrapper"><div id="label__error" class="error" style="display: block;">'+data.e+'</div></div>').hide();msg.insertAfter($(prefix+'_label')).slideDown();}else{personInfo.html(data.p).removeClass('hide').show();var flagInfo=self.flagInfo;if(data.f){flagInfo.val(JSON.stringify(data.f));}else{flagInfo.val('[]');}
var permissionInfo=self.permissionInfo;if(data.s!==undefined){permissionInfo.val(JSON.stringify(data.s));}else{permissionInfo.val('false');}
var actionableInfo=self.actionableInfo,actionable=data.u;if(actionableInfo.length){if(actionable!==undefined){actionableInfo.val(JSON.stringify(data.u));}else{actionable=true;actionableInfo.val('true');}}
if(data.d){self._updateDetails(data.d,actionable);}
if(data.b){self.imageURL.val(data.b);self._showProfilePicture();}
self.blockedEvents=data.i||{};self.blockingInfo.val(JSON.stringify(self.blockedEvents));if(self.eventType.val()){self._toggleSubmit(true);}
self._showFlagInfo();}
if(data.a){S3.showAlert(data.a,'error');}else if(data.m){S3.showAlert(data.m,'success');}},'error':function(){throbber.remove();self._clearForm(true);}});},_registerEvent:function(){this._clearAlert();var prefix=this.idPrefix,label=$(prefix+'_label').val(),event=this.eventType.val();if(!label||!event){return;}
var input={'l':label,'t':event},ajaxURL=this.options.ajaxURL,personInfo=$(prefix+'_person__row .controls'),throbber=$('<div class="inline-throbber">').insertAfter(personInfo),self=this;var actionDetails=this.actionDetails;if(actionDetails.length){actionDetails=actionDetails.val();if(actionDetails){input.d=JSON.parse(actionDetails);}else{input.d=[];}}
input.c=$(prefix+'comments').val();$.ajaxS3({'url':ajaxURL,'type':'POST','dataType':'json','contentType':'application/json; charset=utf-8','data':JSON.stringify(input),'success':function(data){throbber.remove();if(data.e){var msg=$('<div class="error_wrapper"><div id="label__error" class="error" style="display: block;">'+data.e+'</div></div>').hide();msg.insertAfter($(prefix+'_label')).slideDown();}else{self._clearForm();}
if(data.a){S3.showAlert(data.a,'error',false);}else if(data.m){S3.showAlert(data.m,'success',false);}},'error':function(){throbber.remove();this._clearForm(true);}});},_checkBlockedEvents:function(){var event=this.eventType.val(),blocked=this.blockedEvents,info=blocked[event];if(this.blockingMessage){this.blockingMessage.remove();}
if(info){var message=$('<h6>').addClass('event-registration-blocked').html(info[0]),date=new Date(info[1]),now=new Date();if(date>now){this.blockingMessage=$('<div>').addClass('small-12-columns').append(message).prependTo($('#submit_record__row'));return false;}}
return true;},_showFlagInfo:function(){var flagInfo=this.flagInfo,prefix=this.idPrefix,flagInfoContainer=$(prefix+'_flaginfo__row .controls').empty();if(flagInfo.length){flagInfo=JSON.parse(flagInfo.val());}else{flagInfo=[];}
var numFlags=flagInfo.length;if(numFlags){flagInfoContainer.addClass('has-flaginfo');var advise=$('<div class="checkpoint-advise">').hide().appendTo(flagInfoContainer),flag,instructions;for(var i=0;i<numFlags;i++){flag=flagInfo[i];instructions=$('<div class="checkpoint-instructions">').appendTo(advise);$('<h4>'+flag.n+'</h4>').appendTo(instructions);if(flag.i){$('<p>'+flag.i+'</p>').appendTo(instructions);}}
advise.slideDown();}},_showProfilePicture:function(){var el=$(this.element),opts=this.options,imageURL=this.imageURL.val();this._removeProfilePicture();if(!imageURL){return;}
var button=$('<button class="tiny secondary button toggle-picture" type="button">'),buttonRow=$('<div class="button-row">').append(button);button.text(opts.showPictureText);var panel=$('<div class="panel profile-picture">');panel.append(buttonRow).data('url',imageURL).appendTo(el);if(opts.showPicture){this._togglePicture();}},_removeProfilePicture:function(){this.imageURL.val('');$(this.element).find('.panel.profile-picture').remove();},_togglePicture:function(){var el=$(this.element),opts=this.options,container=el.find('.panel.profile-picture');if(container.length){var imageRow=container.find('.image-row'),imageURL=container.data('url'),toggle=container.find('button.toggle-picture');if(imageRow.length){imageRow.remove();toggle.text(opts.showPictureText);}else{if(imageURL){var image=$('<img>').attr('src',imageURL);imageRow=$('<div class="image-row">').append(image);container.prepend(imageRow);toggle.text(opts.hidePictureText);}}}},_hideDetails:function(){var prefix=this.idPrefix,hasPersonInfo=$(prefix+'_person__row .controls').text();if(hasPersonInfo){$(prefix+'_details__row').show();}else{$(prefix+'_details__row').hide();}
$(prefix+'_date__row').hide();$(prefix+'_comments__row').hide();},_showDetails:function(actionable){var prefix=this.idPrefix;$(prefix+'_details__row').show();if(actionable){$(prefix+'_date__row').show();$(prefix+'_comments__row').show();}},_updateDetails:function(data,actionable){var prefix=this.idPrefix,detailsContainer=$(prefix+'_details__row .controls'),dateContainer=$(prefix+'_date__row .controls');var actionDetails=this.actionDetails;if(actionDetails.length){if(data.h!==''){actionDetails.val(JSON.stringify(data.h));}else{actionDetails.val('[]');}}
$(prefix+'_details__row .controls').html(data.d);$(prefix+'_date__row .controls').html(data.t);this._showDetails(actionable);},_clearDetails:function(){var prefix=this.idPrefix;this._hideDetails();this.flagInfo.val('[]');this.permissionInfo.val('false');$(prefix+'_flaginfo__row .controls').empty();$(prefix+'_details__row .controls').empty();$(prefix+'_date__row .controls').empty();$(prefix+'_comments').val('');this.blockedEvents={};if(this.blockingMessage){this.blockingMessage.remove();}
this.blockingInfo.val(JSON.stringify(this.blockedEvents));},_toggleSubmit:function(submit){var form=$(this.element),buttons=['.check-btn','.submit-btn'],permissionInfo=this.permissionInfo,actionableInfo=this.actionableInfo;if(submit){var permitted=false,actionable=false;if(permissionInfo.length){permissionInfo=permissionInfo.val();if(permissionInfo){permitted=JSON.parse(permissionInfo);}}
if(permitted){actionable=true;if(actionableInfo.length){actionableInfo=actionableInfo.val();if(actionableInfo){actionable=JSON.parse(actionableInfo);}}}
if(permitted&&actionable){actionable=this._checkBlockedEvents();}
if(permitted&&actionable){buttons.reverse();}}
var active=form.find(buttons[0]),disabled=form.find(buttons[1]);disabled.prop('disabled',true).hide().insertAfter(active);active.prop('disabled',false).hide().removeClass('hide').show();},_clearAlert:function(){$('.alert-error, .alert-warning, .alert-info, .alert-success').fadeOut('fast');$('.error_wrapper').fadeOut('fast').remove();},_clearForm:function(keepAlerts,keepLabel){var prefix=this.idPrefix;$('.inline-throbber').remove();if(!keepAlerts){this._clearAlert();}
if(!keepLabel){$(prefix+'_label').val('');}
$(prefix+'_person__row .controls').hide().empty();this._removeProfilePicture();this._clearDetails();this._toggleSubmit(false);},_bindEvents:function(){var form=$(this.element),prefix=this.idPrefix,ns=this.eventNamespace,self=this;var zxingButton=$('.zxing-button'),eventTypeToggle=$('#event-type-toggle'),eventTypeSelector=$('#event-type-selector');if(navigator.userAgent.toLowerCase().indexOf("android")==-1){zxingButton.addClass('disabled').click(function(e){e.preventDefault();e.stopPropagation();return false;});}else{zxingButton.bind('click'+ns,function(){self._clearAlert();});}
eventTypeToggle.bind('click'+ns,function(){self._clearAlert();if(eventTypeSelector.hasClass('hide')){eventTypeSelector.hide().removeClass('hide').slideDown();}else{eventTypeSelector.slideToggle();}});eventTypeSelector.find('a.event-type-selector').bind('click'+ns,function(){var $this=$(this),code=$this.data('code'),name=$this.data('name');$('input[type="hidden"][name="event"]').val(code);$('.event-type-name').text(name).removeClass('placeholder');if($(prefix+'_person__row .controls').text()){self._toggleSubmit(true);}
zxingButton.each(function(){var $zxing=$(this),urlTemplate=$zxing.data('tmp');if(urlTemplate){$zxing.attr('href',urlTemplate.replace('%7BEVENT%7D',code));}});eventTypeSelector.slideUp();});form.delegate('.toggle-picture','click'+ns,function(e){e.preventDefault();self._togglePicture();});form.find('a.cancel-action').bind('click'+ns,function(e){e.preventDefault();self._clearForm();});if(this.options.ajax){form.find('.check-btn').bind('click'+ns,function(e){e.preventDefault();self._checkID();});form.find('.submit-btn').unbind(ns).bind('click'+ns,function(e){e.preventDefault();self._registerEvent();});}
var labelInput=$(prefix+'_label');labelInput.bind('input'+ns,function(e){self._clearForm(false,true);});labelInput.bind('keyup'+ns,function(e){switch(e.which){case 27:self._clearForm();break;default:break;}});return true;},_unbindEvents:function(){var form=$(this.element),ns=this.eventNamespace,prefix=this.idPrefix;$('.zxing-button').unbind(ns).unbind('click');$('#event-type-toggle').unbind(ns);$('#event-type-selector').find('a.event-type-selector').unbind(ns);$(prefix+'_label').unbind(ns);form.find('a.cancel-action').unbind(ns);form.find('.check-btn').unbind(ns);form.find('.submit-btn').unbind(ns);form.undelegate(ns);return true;}});})(jQuery);