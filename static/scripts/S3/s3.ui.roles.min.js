(function($,undefined){"use strict";var labels={rm_Add:'Add',rm_Cancel:'Cancel',rm_ConfirmDeleteAssignment:'Do you want to remove this assignment?',rm_Delete:'Delete',rm_DeletionFailed:'Deletion Failed',rm_ForEntity:'For Entity',rm_Role:'Role',rm_SubmissionFailed:'Submission Failed',rm_User:'User'};var roleManagerID=0;$.widget('s3.roleManager',{options:{mode:'roles',items:{},useRealms:false,realmTypes:null,realms:null,ajaxURL:null},_create:function(){this.id=roleManagerID;roleManagerID+=1;this.eventNamespace='.roleManager';},_init:function(){for(var key in labels){labels[key]=i18n[key]||labels[key];}
this.refresh();},_destroy:function(){$.Widget.prototype.destroy.call(this);},refresh:function(){var el=$(this.element);this._unbindEvents();$('.rm-assign',el).remove();this.addRow=null;this.addButton=null;this.realmSelector=null;this.itemSelector=null;this._deserialize();el.append(this._assignmentTable());this._bindEvents();},_deserialize:function(){var widgetID=$(this.element).attr('id'),data=$('#'+widgetID+'-data').val();try{this.assignments=JSON.parse(data);}catch(e){this.assignments=[];}
this.recordID=$('#'+widgetID+'-id').val();},_serialize:function(){var widgetID=$(this.element).attr('id');$('#'+widgetID+'-data').val(JSON.stringify(this.assignments));},_assignmentTable:function(){var opts=this.options,table=$('<table class="rm-assign">');table.append(this._assignmentTableHead()).append(this._assignmentTableBody());if(opts.ajaxURL){var items=opts.items,assignable=false;for(var key in items){if(items[key].a!==false){assignable=true;break;}}
if(assignable){table.append(this._assignmentTableFooter());}}
return table;},_assignmentTableHead:function(){var opts=this.options,thead=$('<thead>'),columnLabels=$('<tr>').appendTo(thead),targetLabel;if(opts.mode=='users'){targetLabel=labels.rm_User;}else{targetLabel=labels.rm_Role;}
$('<th>').text(targetLabel).appendTo(columnLabels);if(opts.useRealms){$('<th>').text(labels.rm_ForEntity).appendTo(columnLabels);}
$('<th>').appendTo(columnLabels);return thead;},_assignmentTableBody:function(){var tbody=$('<tbody>'),assignments=this.assignments,self=this;if(!assignments.length){tbody.append('<tr>');}
assignments.sort(function(a,b){return self._compareAssignments(a,b);}).forEach(function(assignment){tbody.append(self._assignmentTableRow(assignment));});return tbody;},_assignmentTableRow:function(assignment){var row=$('<tr class="rm-assignment">').data('assignment',assignment),opts=this.options,item=opts.items[assignment[0]];var nameCol=$('<td>').appendTo(row);$('<span class="rm-item-name">').text(item.l).appendTo(nameCol);if(item.t){$('<span class="rm-item-title">').text(item.t).appendTo(nameCol);}
if(opts.useRealms){var realm=!item.u&&opts.realms[assignment[1]].l||'';$('<td>').text(realm).appendTo(row);}
var actions=$('<td>');if(item.r!==false&&opts.ajaxURL){var deleteButton=$('<span class="rm-delete-assignment delete-btn-ajax">');actions.append(deleteButton.text(labels.rm_Delete));}
return row.append(actions);},_assignmentTableFooter:function(){var tfoot=$('<tfoot>'),addRow=$('<tr>').appendTo(tfoot);$('<td>').append(this._itemSelector()).appendTo(addRow);if(this.options.useRealms){$('<td>').append(this._realmSelector()).appendTo(addRow);}
var addButton=$('<a class="rm-submit-add action-btn">').text(labels.rm_Add),cancel=$('<span class="rm-cancel-add action-lnk">').text(labels.rm_Cancel);addButton.prop('disabled',true).attr('disabled','disabled');$('<td class="rm-row-actions">').append(addButton).append(cancel).appendTo(addRow);this.addRow=addRow;return tfoot;},_itemSelector:function(){var selector=$('<select class="rm-item-select">'),opts=this.options,items=opts.items,itemList=[];$('<option value="">').prop('selected',true).prop('disabled',true).hide().appendTo(selector);var item,label;for(var key in items){item=items[key];if(item.a!==false){label=item.l;if(item.t){label+=' ('+item.t+')';}
itemList.push([key,label]);}}
itemList.sort(function(a,b){return a[1]===b[1]&&0||(a[1]>b[1]&&1||-1);}).forEach(function(o){$('<option>').attr('value',o[0]).text(o[1]).appendTo(selector);});this.itemSelector=selector;return selector;},_realmSelector:function(){var selector=$('<select class="rm-realm-select">'),opts=this.options,realms=opts.realms,self=this;var entities=Object.keys(realms).sort(function(a,b){return self._compareRealms(a,b);});var realmOptions={};entities.forEach(function(entityID){var entity=realms[entityID],entityType=entity.t,entityOpt=[entityID,entity.l],group=realmOptions[entityType];if(group===undefined){realmOptions[entityType]=[entityOpt];}else{group.push(entityOpt);}});$('<option value="">').prop('selected',true).prop('disabled',true).hide().appendTo(selector);opts.realmTypes.forEach(function(realmType){var entityOpts=realmOptions[realmType[0]];if(entityOpts){var optGroup=$('<optgroup>').attr('label',realmType[1]).appendTo(selector);entityOpts.forEach(function(entity){$('<option>').attr('value',entity[0]).text(entity[1]).appendTo(optGroup);});}});this.realmSelector=selector;this._resetRealmSelector();return selector.prop('disabled',true).css({visibility:'hidden'});},_toggleAdd:function(on){var addButton=$('.rm-submit-add',this.addRow);if(addButton.length){if(on){addButton.prop('disabled',false).removeAttr('disabled');}else{addButton.prop('disabled',true).attr('disabled','disabled');}}},_resetAddRow:function(){var addRow=this.addRow,itemSelector=$('.rm-item-select',addRow);if(itemSelector.length){itemSelector.val('').change();}
this._checkNewAssignment();},_resetRealmSelector:function(){var realmSelector=this.realmSelector;if(realmSelector){if($('option[value="null"]',realmSelector).length){realmSelector.val('null');}else{realmSelector.val('');}}},_optionSelected:function(){var opts=this.options,itemSelector=this.itemSelector,realmSelector=this.realmSelector;if(itemSelector===undefined){return;}
var selectedOpt=itemSelector.val();if(selectedOpt){var item=opts.items[selectedOpt];if(!item){return;}
if(realmSelector){if(item.u){this._resetRealmSelector();realmSelector.prop('disabled',true).css({visibility:'hidden'});}else{realmSelector.prop('disabled',false).css({visibility:'visible'});}}
if(this._checkNewAssignment()===false){this._toggleAdd(false);}else{this._toggleAdd(true);}}else{if(realmSelector){this._resetRealmSelector();realmSelector.prop('disabled',true).css({visibility:'hidden'});}
this._toggleAdd(false);}},_realmSelected:function(){if(this._checkNewAssignment()===false){this._toggleAdd(false);}else{this._toggleAdd(true);}},_getNewAssignment:function(){var itemSelector=this.itemSelector;if(itemSelector){var realm=null,selectedOpt=itemSelector.val();if(!selectedOpt||isNaN(selectedOpt-0)){return;}
if(this.options.useRealms){realm=this.realmSelector.val();if(realm!==null){realm-=0;if(isNaN(realm)){realm=null;}}}
return[selectedOpt-0,realm];}},_checkNewAssignment:function(){var assignment=this._getNewAssignment(),rows=$('.rm-assignment',$(this.element)).removeClass('rm-duplicate');if(assignment){for(var i=rows.length;i--;){var otherRow=$(rows[i]),otherAss=otherRow.data('assignment');if(assignment[0]===otherAss[0]&&assignment[1]===otherAss[1]){otherRow.addClass('rm-duplicate');return false;}}
return assignment;}},_addAssignment:function(){var url=this.options.ajaxURL,assignment=this._checkNewAssignment();if(!url||!assignment){return;}
var addRow=this.addRow,addBtn=$('.rm-submit-add',addRow).hide(),cancel=$('.rm-cancel-add',addRow).hide(),throbber=$('<div class="inline-throbber">').insertBefore(addBtn),self=this;$.ajaxS3({type:'POST',url:url.replace(/%5Bid%5D/g,this.recordID),data:JSON.stringify({add:[assignment]}),dataType:'json',retryLimit:0,contentType:'application/json; charset=utf-8',success:function(){self.assignments.push(assignment);self._serialize();var rows=$('.rm-assignment',$(self.element)),newRow=self._assignmentTableRow(assignment).hide();for(var i=rows.length;i--;){var otherRow=$(rows[i]),otherAss=otherRow.data('assignment');if(self._compareAssignments(otherAss,assignment)==-1){newRow.insertAfter(otherRow).fadeIn();newRow=null;break;}}
if(newRow){$('tbody',addRow.closest('.rm-assign')).prepend(newRow);newRow.fadeIn();}
throbber.remove();addBtn.show();cancel.show();self._resetAddRow();},error:function(){var msg=$('<span class="rm-error">').insertBefore(throbber.hide());msg.text(labels.rm_SubmissionFailed);throbber.remove();window.setTimeout(function(){msg.fadeOut(function(){addBtn.show();cancel.show();});},1000);}});},_deleteAssignment:function(row){var opts=this.options,url=opts.ajaxURL,assignment=row.data('assignment');if(!url||!assignment){return;}
var question=labels.rm_ConfirmDeleteAssignment,label=opts.items[assignment[0]].l;question=question.replace(/%\((role|user)\)s/g,'"'+label+'"');if(!confirm(question)){return;}
var deleteBtn=$('.rm-delete-assignment',row).hide(),throbber=$('<div class="inline-throbber">').insertBefore(deleteBtn),self=this;$.ajaxS3({type:'POST',url:url.replace(/%5Bid%5D/g,this.recordID),data:JSON.stringify({remove:[assignment]}),dataType:'json',retryLimit:0,contentType:'application/json; charset=utf-8',success:function(){self.assignments=self.assignments.filter(function(other){return(other[0]!==assignment[0]||other[1]!==assignment[1]);});self._serialize();$('.rm-assignment',$(self.element)).each(function(){var other=$(this).data('assignment');if(other[0]===assignment[0]&&other[1]===assignment[1]){$(this).fadeOut(function(){throbber.remove();$(this).remove();if(self._checkNewAssignment()){self._toggleAdd(true);}});}});},error:function(){var msg=$('<span class="rm-error">').insertBefore(throbber.hide());msg.text(labels.rm_DeletionFailed);throbber.remove();window.setTimeout(function(){msg.fadeOut(function(){deleteBtn.show();});},1000);}});},_compareAssignments:function(a,b){var items=this.options.items,aName=items[a[0]].l,bName=items[b[0]].l;if(aName==bName){return this._compareRealms(a[1],b[1]);}else{return aName>bName&&1||-1;}},_compareRealms:function(a,b){if(a===b){return 0;}
var realms=this.options.realms,aType=realms[a].t,bType=realms[b].t,realmTypeOrder=this._compareRealmTypes(aType,bType);if(!realmTypeOrder){if(a){if(b){var aName=realms[a].l,bName=realms[b].l;return aName>bName&&1||-1;}else{return-1;}}else{return a===null&&1||(b===null&&-1||1);}}else{return realmTypeOrder;}},_compareRealmTypes:function(a,b){if(a===b){return 0;}else{var realmTypes=this.options.realmTypes.map(function(t){return t[0];});var aIndex=realmTypes.indexOf(a),bIndex=realmTypes.indexOf(b);return aIndex-bIndex;}},_bindEvents:function(){var ns=this.eventNamespace,self=this;if(this.addRow!==undefined){this.addRow.on('change'+ns,'.rm-item-select',function(){self._optionSelected();}).on('change'+ns,'.rm-realm-select',function(){self._realmSelected();}).on('click'+ns,'.rm-cancel-add',function(){self._resetAddRow();}).on('click'+ns,'.rm-submit-add',function(){self._addAssignment();});}
$(this.element).on('click'+ns,'.rm-delete-assignment',function(){self._deleteAssignment($(this).closest('.rm-assignment'));});return true;},_unbindEvents:function(){var el=$(this.element),ns=this.eventNamespace;if(this.addRow!==undefined){this.addRow.off(ns);}
el.off(ns);return true;}});})(jQuery);